/*! Locinator 08-09-2014 */
function nyplNavigation(){"use strict";return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_navigation.html",link:function(){$(".dropDown").hover(function(){$(this).addClass("openDropDown")},function(){$(this).removeClass("openDropDown")})}}}function nyplSearch(){"use strict";return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_search/nypl_search.html",link:function(a,b){function c(a){var b=a.closest("li");return b.hasClass("search-the-catalog")?k.term.attr("placeholder",k.prompt.catalog):b.hasClass("search-the-website")?k.term.attr("placeholder",k.prompt.site):k.term.attr("placeholder",k.prompt.default_val)}function d(){return $.trim(k.term.val())}function e(a){return void 0===a&&(a="Please enter a search term"),k.term.addClass("error").attr("placeholder",a)}function f(){return k.term.removeClass("error").attr("placeholder","")}function g(){return!k.mobile_flag.is(":visible")}function h(a){return void 0===a&&(a=k.choices.find("input[type=radio]:checked").parent()),$.trim(a.text()).toLowerCase()}function i(a){var b,c=d();return void 0===a&&(a=h()),0===c.length?(e(),!1):(b="nypl.org"===a?window.location.protocol+"//nypl.org/search/apachesolr_search/"+c:"http://nypl.bibliocommons.com/search?t=smart&q="+c+"&commit=Search&searchOpt=catalogue",window.location=b,!1)}function j(){angular.element("html").click(function(){b.find(".pseudo-select").removeClass("open"),b.find(".error").removeClass("error")});var a=b;k.term=a.find("#search-block-form-input"),k.search_button=a.find(".search_button"),k.choices=a.find(".pseudo-select"),k.mobile_flag=a.find(".search-button"),k.prompt={default_val:k.term.attr("placeholder"),catalog:"Search the catalog",site:"Search NYPL.org"},a.click(function(a){a.stopPropagation()}),a.find("#search-block-form").submit(function(){return k.search_button.click(),!1}),k.term.focus(function(){k.choices.addClass("open")}),k.term.focus(function(){f()}),a.find(".search-button").click(function(){return i()}),k.choices.find("li input").click(function(){c(angular.element(this))}),k.choices.find("li").click(function(){g()&&(0===d().length?e():i(h(angular.element(this))))})}var k={};j()}}}function nyplSSO(){"use strict";return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_sso/nypl_sso.html",link:function(a,b){b.find(".login-button").click(function(){b.find(".sso-login").toggleClass("visible")}),$(".mobile-login").click(function(){b.find(".sso-login").toggleClass("visible")}),$(".nav-open-button").click(function(){return $(this).toggleClass("open"),$(".search-open-button").removeClass("open"),$("#search-block-form-input").removeClass("open-search"),$(".search-options-resp").removeClass("open"),$("#search-top").removeClass("open"),$("#main-nav").toggleClass("open-navigation"),$(".sso-login").removeClass("visible"),!1}),$(".search-open-button").click(function(){return $(this).toggleClass("open"),$(".nav-open-button").removeClass("open"),$("#main-nav").removeClass("open-navigation"),$("#search-block-form-input").toggleClass("open-search"),$("#search-top").toggleClass("open"),$(".sso-login").removeClass("visible"),!1})}}}function loadingWidget(a){"use strict";return{restrict:"A",link:function(b,c){var d=function(){c.addClass("show")},e=function(){c.removeClass("show")};c.hasClass("show")&&c.removeClass("show"),a.onRequestStarted(b,d),a.onRequestEnded(b,e)}}}function nyplTranslate(){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/translatebuttons.html",replace:!0,controller:function(a,b){a.translate=function(a){b.use(a)}}}}function todayshours(){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/todaysHours.html",replace:!0,scope:{hours:"@"}}}function emailusbutton(){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/emailus.html",replace:!0,scope:{link:"@"}}}function librarianchatbutton(a){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/librarianchat.html",replace:!0,link:function(b,c){b.openChat=function(){a.popupWindow("http://www.nypl.org/ask-librarian","NYPL Chat",210,450),c.hasClass("active")||c.addClass("active")}}}}function scrolltop(a){"use strict";return function(b){b.$on("$stateChangeStart",function(){a.scrollTo(0,0)})}}function eventRegistration(a){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/registration.html",replace:!0,scope:{registration:"@",type:"@",open:"@",start:"@",link:"@"},link:function(b){b.online=!1,"Online"===b.type&&(b.online=!0,b.registration_available="true"===b.open?"Registration opens on "+a("date")(b.start,"MMMM d, y - h:mma"):"Registration for this event is closed.")}}}function nyplSiteAlerts(a,b){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/alerts.html",replace:!0,link:function(c){var d;a.alerts().then(function(a){d=a.alerts,c.sitewidealert=b.alerts(d)})}}}function nyplLibraryAlert(){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/library-alert.html",replace:!0,scope:{exception:"="},link:function(a){a.exception&&""!==a.exception.description&&(a.libraryAlert=a.exception.description)}}}function collapse(){"use strict";function a(a,b,c){var d=c.collapse,e=c.className||"open",f=c.duration||"fast";a.$eval(d)||b.hide(),a.$watch(d,function(a,c){a!==c&&(a?b.stop(!0,!0).slideDown(f).addClass(e):b.stop(!0,!0).slideUp(f).removeClass(e))})}return{link:a,restrict:"A"}}function nyplFundraising(){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/fundraising.html",replace:!0,scope:{fundraising:"=fundraising"}}}function nyplSidebar(){"use strict";return{restrict:"E",templateUrl:"scripts/directives/templates/sidebar-widgets.html",replace:!0,scope:{donateButton:"@",nyplAsk:"@"},link:function(a,b,c){var d="https://secure3.convio.net/nypl/site/SPageServer?pagename=donation_form&JServSessionIdr003=dwcz55yj27.app304a&s_src=FRQ14ZZ_SWBN";a.donateUrl=c.donateurl||d}}}var nypl_locations=angular.module("nypl_locations",["ngSanitize","ui.router","ngAnimate","locationService","coordinateService","nyplSearch","nyplSSO","nyplNavigation","nyplBreadcrumbs","angulartics","angulartics.google.analytics","pascalprecht.translate"]);nypl_locations.constant("_",window._),nypl_locations.config(["$locationProvider","$translateProvider","$stateProvider","$urlRouterProvider","$crumbProvider",function(a,b,c,d,e){"use strict";function f(a,b){return a.singleLocation(b.location).then(function(a){return a.location}).catch(function(a){throw a})}function g(a,b){return a.singleDivision(b.division).then(function(a){return a.division}).catch(function(a){throw a})}function h(a,b){return a.amenitiesAtLibrary(b.location).then(function(a){return a.location}).catch(function(a){throw a})}function i(a,b){return a.amenities(b.amenity).then(function(a){return a}).catch(function(a){throw a})}b.useStaticFilesLoader({prefix:"/languages/",suffix:".json"}),b.preferredLanguage("en"),f.$inject=["nyplLocationsService","$stateParams"],g.$inject=["nyplLocationsService","$stateParams"],h.$inject=["nyplLocationsService","$stateParams"],i.$inject=["nyplLocationsService","$stateParams"],e.setOptions({primaryState:{name:"Home",customUrl:"http://nypl.org"},secondaryState:{name:"Locations",customUrl:"home.index"}}),c.state("home",{url:"/","abstract":!0,templateUrl:"views/locations.html",controller:"LocationsCtrl",label:"Locations"}).state("home.index",{templateUrl:"views/location-list-view.html",url:"",label:"Locations"}).state("home.list",{templateUrl:"views/location-list-view.html",url:"list",label:"Locations"}).state("home.map",{templateUrl:"views/location-map-view.html",url:"map",controller:"MapCtrl",label:"Locations"}).state("division",{url:"/division/:division",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{division:g},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("amenities",{url:"/amenities",templateUrl:"/views/amenities.html",controller:"AmenitiesCtrl",label:"Amenities",resolve:{amenities:i},data:{crumbName:"Amenities"}}).state("amenity",{url:"/amenities/id/:amenity",templateUrl:"views/amenities.html",controller:"AmenityCtrl",label:"Amenities",resolve:{amenity:i},data:{parentState:"amenities",crumbName:"{{amenity.amenity.name}}"}}).state("amenities-at-location",{url:"/amenities/loc/:location",templateUrl:"views/amenitiesAtLibrary.html",controller:"AmenitiesAtLibraryCtrl",resolve:{location:h},data:{parentState:"amenities",crumbName:"{{location.name}}"}}).state("location",{url:"/:location",templateUrl:"views/location.html",controller:"LocationCtrl",resolve:{location:f},data:{crumbName:"{{location.name}}"}}).state("404",{url:"/404",templateUrl:"views/404.html"})}]),nypl_locations.run(["$state","$rootScope",function(a,b){b.$on("$stateChangeError",function(){a.go("404")})}]),nypl_locations.config(["$httpProvider",function(a){"use strict";var b,c=["$q","$injector","$location",function(a,c,d){function e(a){return b=b||c.get("$http"),b.pendingRequests.length<1&&(g=g||c.get("requestNotificationChannel"),g.requestEnded()),a}function f(e){var f=e.status;return b=b||c.get("$http"),b.pendingRequests.length<1&&(g=g||c.get("requestNotificationChannel"),g.requestEnded()),404===f?(d.path("/404"),a.reject(e)):a.reject(e)}var g;return function(a){return g=g||c.get("requestNotificationChannel"),g.requestStarted(),a.then(e,f)}}];a.responseInterceptors.push(c)}]),function(a,b,c){"use strict";function d(){var a={primaryState:{name:null,customUrl:null},secondaryState:{name:null,customUrl:null}};this.setOptions=function(c){b.extend(a,c)},this.$get=["$state","$stateParams",function(b,c){var d=function(a,d){var e,f;for(e=0,f=a.length;f>e;e+=1)if(a[e].name===d.name)return;d.abstract||d.customUrl&&(d.url=b.href(d.name,c||{}),a.unshift(d))};return{getConfigChain:function(){var b=[];return a.secondaryState&&d(b,a.secondaryState),a.primaryState&&d(b,a.primaryState),b}}}]}function e(a,d,e){return{restrict:"E",templateUrl:"scripts/components/nypl_breadcrumbs/nypl_breadcrumbs.html",scope:{crumbName:"@"},link:function(f){function g(a,c){var d,e=a.split("."),f=c;for(d=0;d<e.length;d+=1)b.isDefined(f[e[d]])&&(f=f[e[d]]);return f}function h(a){var b,c=a;return a.abstract===!0&&("undefined"!=typeof f.abstractProxyProperty?(b=g(f.abstractProxyProperty,a),c=b?d.get(b):!1):c=!1),c}function i(b){var c,d,e;return f.crumbName?(d=g(f.crumbName,b),c="undefined"!=typeof b.locals?b.locals.globals:b,d===!1?!1:"undefined"==typeof d?b.name:c?e=a(d)(c):void 0):b.name}function j(a){var b,d,e=a,f=e.data.parentState,g={},h="undefined"!=typeof a.locals?a.locals.globals:a;return"object"==typeof h&&f?h.$stateParams?(d=l(a),b=k(h,f),d&&b?g={displayName:d,route:b}:null):null:c}function k(a,b){var d,e=a,f=b,g=!1;return"object"==typeof e&&f?(Object.keys(e).forEach(function(a){"$stateParams"!==a&&(Object.keys(e[a]).forEach(function(a){-1!==a.indexOf(f)&&(g=!0)}),e[a].location_slug&&g?d=e[a].location_slug:e[a].slug&&g&&(d=e[a].slug))}),d?f+'({ "'+f+'":"'+d+'"})':f):c}function l(b){var e,f=b.data.parentState,g=d.get(f),h="undefined"!=typeof b.locals?b.locals.globals:b;if(g){if(e=a(g.data.crumbName)(h))return e;if("object"==typeof h)return Object.keys(h).forEach(function(a){"$stateParams"!==a&&(h[a].location_name?e=h[a].location_name:h[a].name&&(e=h[a].name))}),e}return c}function m(a,b){var c,d=!1;for(c=0;c<b.length;c++)b[c].route===a.name&&(d=!0);return d}function n(){var a,b,c,g,k=[],l=d.$current,n=e.getConfigChain();if(n)for(a=0;a<n.length;a+=1)k.push({displayName:n[a].name,route:n[a].customUrl});for(g=j(l),g&&k.push({displayName:g.displayName,route:g.route});l&&""!==l.name;)b=h(l),b&&(c=i(b),c===!1||m(b,k)||k.push({displayName:c,route:b.name})),l.parent&&(l=l.parent);f.breadcrumbs=k}f.breadcrumbs=[],""!==d.$current.name&&n(),f.$on("$stateChangeSuccess",function(){n()})}}}e.$inject=["$interpolate","$state","$crumb"],b.module("nyplBreadcrumbs",[]).provider("$crumb",d).directive("nyplBreadcrumbs",e)}(window,window.angular),function(){"use strict";function a(a,b){var c=null,d={};return d.geolocationAvailable=function(){return b.navigator||b.navigator.geolocation?!0:!1},d.getBrowserCoordinates=function(){var d=a.defer();return this.geolocationAvailable()?b.navigator.geolocation.getCurrentPosition(function(a){c=a.coords,d.resolve(c)},function(a){switch(a.code){case a.PERMISSION_DENIED:d.reject(new Error("Permission denied."));break;case a.POSITION_UNAVAILABLE:d.reject(new Error("The position is currently unavailable."));break;case a.TIMEOUT:d.reject(new Error("The request timed out."));break;default:d.reject(new Error("Unknown error."))}},{enableHighAccuracy:!0,timeout:5e3,maximumAge:6e5}):d.reject(new Error("Your browser does not support Geolocation.")),d.promise},d.getDistance=function(a,b,c,d){if(!(a&&d&&c&&d))return void 0;var e,f=Math.PI*a/180,g=Math.PI*c/180,h=b-d,i=Math.PI*h/180;return e=Math.sin(f)*Math.sin(g)+Math.cos(f)*Math.cos(g)*Math.cos(i),e=Math.acos(e),e=180*e/Math.PI,e=60*e*1.1515,Math.ceil(100*e)/100},d}a.$inject=["$q","$window"],angular.module("coordinateService",[]).factory("nyplCoordinatesService",a)}(),function(){"use strict";function a(a,b){var c="http://evening-mesa-7447-160.herokuapp.com",d="Could not reach API",e={};return e.allLocations=function(){var e=b.defer();return a.get(c+"/locations",{cache:!0}).success(function(a){e.resolve(a)}).error(function(){e.reject(d)}),e.promise},e.singleLocation=function(e){var f=b.defer();return a.get(c+"/locations/"+e,{cache:!0}).success(function(a){f.resolve(a)}).error(function(){f.reject(d)}),f.promise},e.singleDivision=function(e){var f=b.defer();return a.get(c+"/divisions/"+e,{cache:!0}).success(function(a){f.resolve(a)}).error(function(){f.reject(d)}),f.promise},e.amenities=function(e){var f=b.defer(),g=e?"/amenities/"+e:"/amenities";return a.get(c+g,{cache:!0}).success(function(a){f.resolve(a)}).error(function(){f.reject(d)}),f.promise},e.amenitiesAtLibrary=function(e){var f=b.defer();return a.get(c+"/locations/"+e,{cache:!0}).success(function(a){f.resolve(a)}).error(function(){f.reject(d)}),f.promise},e.alerts=function(){var e=b.defer();return a.get(c+"/alerts",{cache:!0}).success(function(a){e.resolve(a)}).error(function(){e.reject(d)}),e.promise},e}a.$inject=["$http","$q"],angular.module("locationService",[]).factory("nyplLocationsService",a)}(),angular.module("nyplNavigation",[]).directive("nyplNavigation",nyplNavigation),angular.module("nyplSearch",[]).directive("nyplSearch",nyplSearch),angular.module("nyplSSO",[]).directive("nyplSso",nyplSSO),function(){"use strict";function a(a,b,c,d){a.title="Amenities",b.amenitiesCategories=d.addCategoryIcon(c.amenities)}function b(a,b,c){var d=c.amenity.name;a.title=d,b.amenity=c.amenity,b.locations=c.locations,b.amenity_name=d}function c(a,b,c,d,e){d._embedded.amenities.length?c.amenitiesCategories=e.addCategoryIcon(d._embedded.amenities):a.get("json/amenitiesAtLibrary.json").success(function(a){c.amenitiesCategories=e.addCategoryIcon(a.amenities)}),b.title=d.name,c.location=d}a.$inject=["$rootScope","$scope","amenities","nyplAmenities"],b.$inject=["$rootScope","$scope","amenity"],c.$inject=["$http","$rootScope","$scope","location","nyplAmenities"],angular.module("nypl_locations").controller("AmenityCtrl",b).controller("AmenitiesCtrl",a).controller("AmenitiesAtLibraryCtrl",c)}(),function(){"use strict";function a(a,b,c,d){b.division=c,a.title=c.name,b.calendarLink=d.calendarLink,b.icalLink=d.icalLink,b.siteWideAlert=d.alerts(c._embedded.alerts),c.hours&&(b.hoursToday=d.hoursToday(c.hours)),c._embedded.divisions&&_.each(c._embedded.divisions,function(a){a.hoursToday=d.hoursToday(a.hours)}),b.division.social_media=d.socialMediaColor(c.social_media),b.has_appointment=d.divisionHasAppointment(c.id)}a.$inject=["$rootScope","$scope","division","nyplUtility"],angular.module("nypl_locations").controller("DivisionCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){var k,l=i.getSearchValues(),m={coords:{},address:""},n=function(a){b.predicate=a},o=function(a,b){_.each(a,function(a){a[b]=""})},p=function(){b.searchMarker=!1,b.researchBranches=!1,b.userMarker=!1,b.reverse=!1,b.searchTerm="",b.geolocationAddressOrSearchQuery="",b.select_library_for_map="",n("name"),o(b.locations,"distance"),o(b.locations,"highlight")},q=function(){e.geolocationAvailable()&&(b.geolocationOn=!0)},r=function(){return"home.map"===d.current.name},s=function(){return e.getBrowserCoordinates().then(function(a){if(m.coords=_.pick(a,"latitude","longitude"),b.locations=h.calcDistance(b.locations,m.coords),h.checkDistance(b.locations))throw p(),new Error("You are not within 25 miles of any NYPL library.");return b.locationStart=m.coords.latitude+","+m.coords.longitude,b.userMarker=!0,n("distance"),f.createMarker("user",m.coords,"Your Current Location"),r()&&b.drawUserMarker(),m.coords})},t=function(){return i.resetSearchValues(),f.reverseGeocoding({lat:m.coords.latitude,lng:m.coords.longitude}).then(function(a){return b.geolocationAddressOrSearchQuery=a,i.setSearchValue("resultsNear",a).setSearchValue("locations",b.locations),a})},u=function(a){return i.setSearchValue("searchTerm",a),f.geocodeAddress(a).then(function(a){return{coords:a,searchTerm:a.name}}).catch(function(a){throw a})},v=function(a){var c=b.locations,d=a.coords,e=a.searchTerm;if(c=h.calcDistance(c,d),h.checkDistance(c))throw b.searchError=e,f.panMap(),new Error("The search query is too far");return b.userMarker=!1,f.removeMarker("user"),i.setSearchValue("resultsNear",a.searchTerm),b.geolocationAddressOrSearchQuery=e,b.searchError="",c},w=function(a,c,d){o(a,"highlight"),_.each(c,function(a){a.highlight="active",a.distance=""}),a=_.sortBy(a,function(a){return a[d]}),a=_.difference(a,c),b.locations=_.union(c,a),i.setSearchValue("locations",b.locations),n("")},x=function(){var a=[angular.element(".locations-list-view tbody"),angular.element(".locations-data-wrapper")];_.each(a,function(a){$(a).animate({scrollTop:"0px"},1e3)})},y=function(){x(),r()&&b.drawUserMarker(),n("distance")},z=function(a){b.location_type=a},A=function(a){f.setFilterMarker(a),r()&&f.drawFilterMarker(a)},B=function(a){o(b.locations,"distance"),w(b.locations,a,"name"),A(a[0].slug),b.scrollPage()},C=function(a,b){a.length?A(a[0].slug):(f.clearFilteredLocation(),f.createSearchMarker(b.coords,b.searchTerm))},D=function(){l.locations?(b.locations=l.locations,b.searchTerm=l.searchTerm,b.geolocationAddressOrSearchQuery=l.resultsNear,b.searchMarker=l.searchMarker,b.searchMarker&&f.drawSearchMarker(),b.searchTerm||n("distance")):b.loadLocations()};b.loadLocations=function(){return g.allLocations().then(function(a){return k=a.locations,b.locations=k,_.each(b.locations,function(a){var b=h.getAddressString(a,!0),c={latitude:a.geolocation.coordinates[1],longitude:a.geolocation.coordinates[0]};a.hoursToday=h.hoursToday,a.locationDest=h.getAddressString(a),a.amenities_list=j.allAmenitiesArray(a._embedded.amenities),a.branchException=h.branchException(a.hours),f.doesMarkerExist(a.slug)||f.createMarker(a.slug,c,b)}),p(),k}).catch(function(a){throw d.go("404"),a})},b.scrollPage=function(){var a,b=angular.element(".container__all-locations"),d=parseInt(b.css("width"),10);a=601>d?angular.element(".map-search__results").offset()||angular.element(".search__results").offset():b.offset(),c(function(){angular.element("body").animate({scrollTop:a.top},1e3)},1e3)},b.viewMapLibrary=function(a){var c=_.where(b.locations,{slug:a});b.select_library_for_map=a,d.go("home.map"),w(b.locations,c,"name"),b.scrollPage()},b.useGeolocation=function(){f.removeMarker("search"),b.select_library_for_map="",b.searchTerm="",b.searchMarker=!1,b.scrollPage(),s().then(t).then(y).catch(function(a){b.distanceError=a.message,b.geolocationOn=!1})},b.clearSearch=function(){i.resetSearchValues(),z(),f.showAllLibraries().removeMarker("user").clearFilteredLocation(),r()&&f.removeMarker("search").hideInfowindow().panMap(),p(),x()},b.drawUserMarker=function(){f.doesMarkerExist("user")&&f.panExistingMarker("user")},b.submitAddress=function(a){var c,d;if(a)return b.geolocationAddressOrSearchQuery="",b.searchError="",z(),f.showAllLibraries(),b.searchTerm=a,a=i.searchWordFilter(a),x(),c=i.idLocationSearch(b.locations,a),d=i.locationSearch(b.locations,a),c&&0!==c.length?void B(c):void u(a).then(function(a){return C(d,a),v(a)}).then(function(a){b.scrollPage(),d.length||(b.searchMarker=!0,i.setSearchValue("searchMarker",!0),r()&&f.drawSearchMarker()),w(a,d,"distance")}).catch(function(a){f.removeMarker("search"),b.searchMarker=!1,i.resetSearchValues(),d&&d.length&&"query too short"!==a.msg?(o(b.locations,"distance"),b.searchError="",r()&&f.drawFilterMarker(d[0].slug),w(k,d,"name")):p()})},b.showResearch=function(){f.hideInfowindow(),x(),b.researchBranches=!b.researchBranches,b.researchBranches?(f.showResearchLibraries().panMap(),z("research")):(f.showAllLibraries().panMap(),z())},a.title="Locations",b.$state=d,D(),q()}function b(a,b,c){var d=function(){b(function(){a.locations&&(c.showAllLibraries(),a.researchBranches&&c.showResearchLibraries())},1200)},e=function(){b(function(){var b=c.getFilteredLocation();c.drawMap({lat:40.7532,"long":-73.9822},12,"all-locations-map").drawLegend("all-locations-map-legend"),a.locations&&c.showAllLibraries(),d(),a.drawUserMarker(),a.userMarker&&c.drawSearchMarker(),a.searchMarker&&c.drawSearchMarker(),a.researchBranches&&c.showResearchLibraries(),a.select_library_for_map&&c.panExistingMarker(a.select_library_for_map),c.drawFilterMarker(b),a.scrollPage()},1200)};e(),a.panToLibrary=function(b){c.hideSearchInfowindow().panExistingMarker(b),a.scrollPage()}}function c(a,b,c,d,e,f,g){var h=d._embedded.amenities,i=function(){return e.getBrowserCoordinates().then(function(a){var d=_.pick(a,"latitude","longitude");c(function(){b.locationStart=d.latitude+","+d.longitude})})};i(),b.location=d,a.title=d.name,d._embedded.amenities=g.addCategoryIcon(h),d.amenities_list=g.getHighlightedAmenities(h,3,2),b.calendarLink=f.calendarLink,b.icalLink=f.icalLink,b.location.social_media=f.socialMediaColor(b.location.social_media),d.hours&&(b.hoursToday=f.hoursToday(d.hours)),_.each(d._embedded.divisions,function(a){a.hoursToday=f.hoursToday(a.hours)}),_.each(d._embedded.features,function(a){a.body=f.returnHTML(a.body)}),b.locationDest=f.getAddressString(d)}a.$inject=["$rootScope","$scope","$timeout","$state","nyplCoordinatesService","nyplGeocoderService","nyplLocationsService","nyplUtility","nyplSearch","nyplAmenities"],b.$inject=["$scope","$timeout","nyplGeocoderService"],c.$inject=["$rootScope","$scope","$timeout","location","nyplCoordinatesService","nyplUtility","nyplAmenities"],angular.module("nypl_locations").controller("LocationsCtrl",a).controller("MapCtrl",b).controller("LocationCtrl",c)}(),loadingWidget.$inject=["requestNotificationChannel"],librarianchatbutton.$inject=["nyplUtility"],scrolltop.$inject=["$window"],eventRegistration.$inject=["$filter"],nyplSiteAlerts.$inject=["nyplLocationsService","nyplUtility"],nyplLibraryAlert.$inject=["nyplUtility"],angular.module("nypl_locations").directive("loadingWidget",loadingWidget).directive("nyplTranslate",nyplTranslate).directive("todayshours",todayshours).directive("emailusbutton",emailusbutton).directive("librarianchatbutton",librarianchatbutton).directive("scrolltop",scrolltop).directive("eventRegistration",eventRegistration).directive("nyplSiteAlerts",nyplSiteAlerts).directive("nyplLibraryAlert",nyplLibraryAlert).directive("nyplFundraising",nyplFundraising).directive("nyplSidebar",nyplSidebar).directive("collapse",collapse),function(){"use strict";function a(){function a(a){var b=a.split(":"),c=(parseInt(b[0],10)+11)%12+1,d=b[1],e=b[0]>=12?"pm":"am";return c+":"+d+e}return function(b){var c=void 0!==b&&void 0!==b.today?b.today:b;return c?null===c.open?"Closed":a(c.open)+" - "+a(c.close):(console.log("timeFormat() filter function error: Argument is not defined or empty, verify API response for time"),"")}}function b(){return function(a){return new Date(a).toISOString()}}function c(){return function(a){return"string"==typeof a?a.replace(/(^|\s)([a-z])/g,function(a){return a.toUpperCase()}):a}}function d(){function a(a){return a=a.split(":"),_.object(["hours","mins","meridian","military"],[(parseInt(a[0],10)+11)%12+1,a[1],a[0]>=12?"pm":"am",a[0]])}return function(b,c){var d,e,f,g,h,i,j,k=new Date,l=k.getHours();if(b){if(g=b.today,h=b.tomorrow,g.open&&(d=a(g.open)),g.close&&(e=a(g.close)),!g.open||!g.close)return console.log("Returned object is undefined for open/closed elems"),"Closed today";if(null!==h.open&&(i=a(h.open)),null!==h.close&&(j=a(h.close)),l>=e.military)return i||j?"Open tomorrow "+i.hours+(0!==parseInt(i.mins,10)?":"+i.mins:"")+i.meridian+"-"+j.hours+(0!==parseInt(j.mins,10)?":"+j.mins:"")+j.meridian:"Closed today";switch(i&&l>=0&&l<i.military&&(c="long"),c){case"short":f="Open today until "+e.hours+(0!==parseInt(e.mins,10)?":"+e.mins:"")+e.meridian;break;case"long":f="Open today "+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian+"-"+e.hours+(0!==parseInt(e.mins,10)?":"+e.mins:"")+e.meridian;break;default:f=d.hours+":"+d.mins+d.meridian+"-"+e.hours+":"+e.mins+e.meridian}return f}return"Not available"}}function e(){return function(a,b,c){return"string"!=typeof a?a:a.length<200?a:(isNaN(b)&&(b=200),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c)}}angular.module("nypl_locations").filter("timeFormat",a).filter("dateToISO",b).filter("capitalize",c).filter("hoursTodayFormat",d).filter("truncate",e)}(),function(){"use strict";function a(){var a={},b=function(a,b){return _.sortBy(a,function(a){return a[b]})};return a.addIcon=function(a,b){var c=b||"";return _.each(a,function(a){switch(a.id){case 7952:a.icon="icon-connection";break;case 7953:a.icon="icon-laptop";break;case 7954:a.icon="icon-print";break;case 7955:a.icon="icon-power-cord";break;case 7958:case 7951:a.icon="icon-box-add";break;default:a.icon=c}}),a},a.addCategoryIcon=function(a){var b=this;return _.each(a,function(a){var c="";switch(a.name){case"Computer Services":c="icon-screen2";break;case"Circulation":c="icon-book";break;case"Office Services":c="icon-copy";break;case"Facilities":c="icon-library";break;case"Assistive Technologies":c="icon-accessibility2"}a.icon=c,a.amenities=b.addIcon(a.amenities,c)}),a},a.allAmenitiesArray=function(a){return a?_.chain(a).pluck("amenities").flatten(!0).value():void 0},a.getHighlightedAmenities=function(a,c,d){var e=this.allAmenitiesArray(a),f=[];if(a&&c&&d)return e=b(e,"rank"),f=e.splice(0,c),e=b(e,"location_rank"),e=e.splice(0,d),f=_.union(f,e)},a}angular.module("nypl_locations").factory("nyplAmenities",a)}(),function(){"use strict";function a(a){var b,c,d=[],e=new google.maps.Marker({icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}),f=new google.maps.InfoWindow,g=new google.maps.InfoWindow,h={},i=function(a){return _.findWhere(d,{id:a})},j=function(a,c){h.hideInfowindow(),g.setContent(c),g.open(b,a)},k=function(a){var b=i(a);h.doesMarkerExist(a)&&b.marker.setMap(null)},l=function(a){var c=i(a);c&&c.marker.setMap(b)};return h.geocodeAddress=function(b){var c=a.defer(),d={},e=new google.maps.Geocoder,f=new google.maps.LatLng(40.49,-74.26),g=new google.maps.LatLng(40.91,-73.77),h=new google.maps.LatLngBounds(f,g);return b.length<3?c.reject({msg:"Query too short"}):e.geocode({address:b,bounds:h,region:"US"},function(a,b){b===google.maps.GeocoderStatus.OK?(d.lat=a[0].geometry.location.k,d.long=a[0].geometry.location.B||a[0].geometry.location.A,d.name=a[0].formatted_address,c.resolve(d)):c.reject(new Error(b))}),c.promise},h.reverseGeocoding=function(b){var c,d=a.defer(),e=new google.maps.Geocoder,f=new google.maps.LatLng(b.lat,b.lng);return e.geocode({latLng:f},function(a,b){b===google.maps.GeocoderStatus.OK?(c=a[0].formatted_address,d.resolve(c)):d.reject(new Error(b))}),d.promise},h.drawMap=function(a,c,d){var e=new google.maps.LatLng(a.lat,a.long),f={zoom:c,center:e,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,streetViewControl:!1};return b=new google.maps.Map(document.getElementById(d),f),this},h.drawLegend=function(a){var c=document.getElementById(a);return b.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(c),c.className="show-legend",this},h.panMap=function(a){var c,d,e=new google.maps.LatLng(40.7632,-73.9822);if(b)return a?(c=a.getPosition(),d=14):(c=e,d=12),b.panTo(c),b.setZoom(d),this},h.showResearchLibraries=function(){var a=["schwarzman","lpa","sibl","schomburg","user"];return _.each(d,function(b){_.contains(a,b.id)||k(b.id)}),this},h.showAllLibraries=function(){return d&&_.each(d,function(a){l(a.id)}),this},h.createMarker=function(a,b,c){var e,f=new google.maps.LatLng(b.latitude,b.longitude),g={position:f,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"};"user"===a&&(g.icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",g.zIndex=1e3,g.animation=google.maps.Animation.DROP),e=new google.maps.Marker(g),d.push({id:a,marker:e,text:c}),google.maps.event.addListener(e,"click",function(){j(e,c)})},h.hideInfowindow=function(){return g.close(),this},h.doesMarkerExist=function(a){return!!i(a)},h.createSearchMarker=function(a,b){var c=b.replace(","," <br>").replace(","," <br>"),d=new google.maps.LatLng(a.lat,a.long);e.setPosition(d),f.setContent(c)},h.drawSearchMarker=function(){return c||(e.setMap(b),this.panMap(e),f.open(b,e),this.hideInfowindow(),google.maps.event.addListener(e,"click",function(){f.open(b,e)})),this},h.hideSearchInfowindow=function(){return f.close(),this},h.removeMarker=function(a){return a?("search"===a?e.setMap(null):k(a),this):this},h.panExistingMarker=function(a){var b=i(a),c=b.marker;return(void 0===c.getMap()||null===c.getMap())&&l(a),this.panMap(c),j(b.marker,b.text),this},h.setFilterMarker=function(a){return c=a,this},h.drawFilterMarker=function(a){return this.doesMarkerExist(a)&&this.panExistingMarker(a),this},h.clearFilteredLocation=function(){return c=void 0,this},h.getFilteredLocation=function(){return c},h}a.$inject=["$q"],angular.module("nypl_locations").factory("nyplGeocoderService",a)}(),function(){"use strict";function a(a){var b={},c={};return b.setSearchValue=function(a,b){return c[a]=b,this},b.getSearchValues=function(){return c},b.resetSearchValues=function(){return c={},this},b.idLocationSearch=function(a,b){var c=[];if(a&&b)return b.length>=2&&b.length<=4&&(c=_.where(a,{id:b.toUpperCase()})),c},b.locationSearch=function(b,c){var d,e;if(b&&c&&!(c.length<3))return d=a("filter")(b,c),e=a("filter")(b,c,!0),void 0!==e&&0!==e.length?_.union(e,d):d},b.searchWordFilter=function(a){var b=["branch"];if(a)return _.each(b,function(b){a=a.replace(b,"")}),a},b}a.$inject=["$filter"],angular.module("nypl_locations").factory("nyplSearch",a)}(),function(){"use strict";function a(a){var b="_START_REQUEST_",c="_END_REQUEST_",d={};return d.requestStarted=function(){a.$broadcast(b)},d.requestEnded=function(){a.$broadcast(c)},d.onRequestStarted=function(a,c){a.$on(b,function(a){c(a)})},d.onRequestEnded=function(a,b){a.$on(c,function(a){b(a)})},d}function b(a,b,c){var d={};return d.hoursToday=function(a){var b,c=new Date,d=c.getDay(),e=d+1;return a&&(b={today:{day:a.regular[d].day,open:a.regular[d].open,close:a.regular[d].close},tomorrow:{day:a.regular[e%7].day,open:a.regular[e%7].open,close:a.regular[e%7].close}}),b},d.branchException=function(a){var b={};if(a){if(!a.exceptions)return null;if(""!==a.exceptions.description.trim())return b.desc=a.exceptions.description,a.exceptions.start&&(b.start=a.exceptions.start),a.exceptions.end&&(b.end=a.exceptions.end),b}},d.getAddressString=function(a,b){if(!a)return"";var c=" ",d=a.name;return b&&(c="<br />",d="<a href='/#/"+a.slug+"'>"+a.name+"</a>"),d+c+a.street_address+c+a.locality+", "+a.region+", "+a.postal_code},d.socialMediaColor=function(a){return _.each(a,function(a){switch(a.classes="icon-",a.site){case"facebook":a.classes+=a.site+" blueDarkerText";break;case"foursquare":a.classes+=a.site+" blueText";break;case"instagram":a.classes+=a.site+" blackText";
break;case"twitter":a.classes+=a.site+"2 blueText";break;case"tumblr":a.classes+=a.site+"2 indigoText";break;case"youtube":case"pinterest":a.classes+=a.site+" redText";break;default:a.classes+=a.site}}),a},d.alerts=function(a){var b,c,d=new Date,e="";return a&&Array.isArray(a)&&(_.each(a,function(a){b=new Date(a.start),c=new Date(a.end),d>=b&&c>=d&&(e+=a.body+"\n")}),!angular.isUndefined(e))?e:null},d.popupWindow=function(b,c,d,e){var f,g,h,i,j;f=void 0===d?"300":"string"==typeof d||d instanceof String?d:d.toString(),g=void 0===e?"500":"string"==typeof d||d instanceof String?e:e.toString(),b&&c?h=a.open(b,c,"menubar=1,resizable=1,width="+f+",height="+g):b?h=a.open(b,"","menubar=1,resizable=1,width="+f+",height="+g):console.log("No link set, cannot initialize the popup window"),h&&(j=parseInt(f,10),i=parseInt(g,10),h.moveTo(screen.width/2-j/2,screen.height/2-i/2))},d.calendarLink=function(a,b,c){if(!a||!b)return"";var d=b.title,e=b.start.replace(/[\-:]/g,""),f=b.end.replace(/[\-:]/g,""),g=b.body,h=b._links.self.href,i=c.name+" - "+c.street_address+" "+c.locality+", "+c.region+" "+c.postal_code,j="";switch(a){case"google":j="https://www.google.com/calendar/render?action=template&text="+d+"&dates="+e+"/"+f+"&details="+g+"&location="+i+"&pli=1&uid=&sf=true&output=xml";break;case"yahoo":j="https://calendar.yahoo.com/?v=60&TITLE="+d+"&ST="+e+"&in_loc="+i+"&in_st="+i+"&DESC="+g+"&URL="+h}return j},d.icalLink=function(b,c){if(!b||!c)return"";var d=(new Date).toJSON().toString().replace(/[\-.:]/g,""),e="http://nypl.org/"+b._links.self.href,f="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NYPL//NONSGML v1.0//EN\nMETHOD:PUBLISH\nBEGIN:VEVENT\nUID:"+(new Date).getTime()+"\nDTSTAMP:"+d+"\nATTENDEE;CN=My Self ;\nORGANIZER;CN=NYPL:\nDTSTART:"+b.start.replace(/[\-:]/g,"")+"\nDTEND:"+b.end.replace(/[\-:]/g,"")+"\nLOCATION:"+c+"\nDESCRIPTION:"+b.body+"\nURL;VALUE=URI:"+e+"\nSUMMARY:"+b.title+"\nEND:VEVENT\nEND:VCALENDAR";a.open("data:text/calendar;chartset=utf-8,"+encodeURI(f))},d.calcDistance=function(a,b){if(!a)return[];var d={latitude:b.latitude||b.lat,longitude:b.longitude||b.long};return _.each(a,function(a){var b,e,f=[];a.geolocation&&a.geolocation.coordinates&&(f=a.geolocation.coordinates),b=a.lat||f[1],e=a.long||f[0],a.distance=c.getDistance(d.latitude,d.longitude,b,e)}),a},d.checkDistance=function(a){var b=_.pluck(a,"distance");return _.min(b)>25?!0:!1},d.returnHTML=function(a){return b.trustAsHtml(a)},d.divisionHasAppointment=function(a){switch(a){case"ARN":case"RBK":case"MSS":case"BRG":case"PRN":case"PHG":case"SPN":case"CPS":return!0;default:return!1}},d}a.$inject=["$rootScope"],b.$inject=["$window","$sce","nyplCoordinatesService"],angular.module("nypl_locations").factory("nyplUtility",b).factory("requestNotificationChannel",a)}();