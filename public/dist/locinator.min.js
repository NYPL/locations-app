/*!
 __                                            __    
/\ \                      __                  /\ \__
\ \ \        ___     ___ /\_\    ___      __  \ \ ,_\   ___   _ __
 \ \ \  __  / __`\  /'___\/\ \ /' _ `\  /'__`\ \ \ \/  / __`\/\`'__\
  \ \ \_\ \/\ \_\ \/\ \__/\ \ \/\ \/\ \/\ \_\.\_\ \ \_/\ \_\ \ \ \/ 
   \ \____/\ \____/\ \____\\ \_\ \_\ \_\ \__/.\_\\ \__\ \____/\ \_\ 
    \/___/  \/___/  \/____/ \/_/\/_/\/_/\/__/\/_/ \/__/\/___/  \/_/ 
*/
function nyplInterceptor(a,b){var c,d;return{request:function(a){return c=c||b.get("$http"),c.pendingRequests.length<1&&(d=d||b.get("requestNotificationChannel"),d.requestStarted()),a},response:function(a){return c=c||b.get("$http"),c.pendingRequests.length<1&&(d=d||b.get("requestNotificationChannel"),d.requestEnded()),a},responseError:function(e){return c=c||b.get("$http"),c.pendingRequests.length<1&&(d=d||b.get("requestNotificationChannel"),d.requestEnded()),a.reject(e)}}}var nypl_locations=angular.module("nypl_locations",["ngSanitize","ui.router","ngAnimate","locationService","coordinateService","nyplFeedback","nyplSearch","nyplSSO","nyplNavigation","nyplBreadcrumbs","angulartics","angulartics.google.analytics","newrelic-timing","nyplAlerts"]);nypl_locations.constant("_",window._),nypl_locations.config(["$analyticsProvider","$locationProvider","$stateProvider","$urlRouterProvider","$crumbProvider","$nyplAlertsProvider","$httpProvider",function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){return c.singleLocation(a.location).then(function(a){return a.location})["catch"](function(a){throw a})}function i(a,b,c,d){var e=d.singleDivision(b.division),f=d.singleDivision(b.subdivision);return a.all([e,f]).then(function(a){var b=(a[0].division,a[1].division);return b})}function j(a,b,c){return c.singleDivision(a.division).then(function(a){return a.division})["catch"](function(a){throw a})}function k(a,b,c){return c.amenities(a.amenity).then(function(a){return a})["catch"](function(a){throw a})}function l(a){return a.getConfig()}h.$inject=["$stateParams","config","nyplLocationsService"],i.$inject=["$q","$stateParams","config","nyplLocationsService"],j.$inject=["$stateParams","config","nyplLocationsService"],k.$inject=["$stateParams","config","nyplLocationsService"],l.$inject=["nyplLocationsService"],g.interceptors.push(nyplInterceptor),a.virtualPageviews(!1),b.html5Mode(!0),f.setOptions({api_root:locations_cfg.config.api_root,api_version:locations_cfg.config.api_version}),e.setOptions({primaryState:{name:"Home",customUrl:"http://nypl.org"},secondaryState:{name:"Locations",customUrl:"home.index"}}),d.rule(function(a,b){var c=b.url();return"/"===c[c.length-1]?c.slice(0,-1):void 0}),moment.tz.setDefault("America/New_York"),d.otherwise("/404"),c.state("home",{url:"/","abstract":!0,templateUrl:"views/locations.html",controller:"LocationsCtrl",label:"Locations",resolve:{config:l}}).state("home.index",{templateUrl:"views/location-list-view.html",url:"",label:"Locations"}).state("home.list",{templateUrl:"views/location-list-view.html",url:"list",label:"Locations"}).state("home.map",{templateUrl:"views/location-map-view.html",url:"map",controller:"MapCtrl",label:"Locations"}).state("subdivision",{url:"/divisions/:division/:subdivision",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:l,division:i},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("division",{url:"/divisions/:division",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:l,division:j},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("amenities",{url:"/amenities",templateUrl:"views/amenities.html",controller:"AmenitiesCtrl",label:"Amenities",resolve:{config:l,amenities:k},data:{crumbName:"Amenities"}}).state("amenity",{url:"/amenities/id/:amenity",templateUrl:"views/amenities.html",controller:"AmenityCtrl",label:"Amenities",resolve:{config:l,amenity:k},data:{parentState:"amenities",crumbName:"{{amenity.amenity.name}}"}}).state("amenities-at-location",{url:"/amenities/loc/:location",templateUrl:"views/amenitiesAtLibrary.html",controller:"AmenitiesAtLibraryCtrl",resolve:{config:l,location:h},data:{parentState:"amenities",crumbName:"{{location.name}}"}}).state("404",{url:"/404",templateUrl:"views/404.html"}).state("location",{url:"/:location",templateUrl:"views/location.html",controller:"LocationCtrl",resolve:{config:l,location:h},data:{crumbName:"{{location.name}}"}})}]),nypl_locations.run(["$analytics","$state","$rootScope","$location",function(a,b,c,d){c.$on("$stateChangeStart",function(){c.close_feedback=!0}),c.$on("$viewContentLoaded",function(){a.pageTrack("/locations"+d.path()),c.current_url=d.absUrl()}),c.$on("$stateChangeError",function(){b.go("404")})}]),nyplInterceptor.$inject=["$q","$injector"];var nypl_widget=angular.module("nypl_widget",["ngSanitize","ui.router","locationService","nyplAlerts","coordinateService","angulartics","angulartics.google.analytics"]).config(["$locationProvider","$stateProvider","$urlRouterProvider","$nyplAlertsProvider","$httpProvider",function(a,b,c,d,e){"use strict";function f(a,b,c){return c.singleLocation(a.location).then(function(a){return a.location})["catch"](function(a){throw a})}function g(a,b,c,d){var e=d.singleDivision(b.division),f=d.singleDivision(b.subdivision);return a.all([e,f]).then(function(a){var b=(a[0],a[1].division);return b})}function h(a,b,c){return c.singleDivision(a.division).then(function(a){return a.division})["catch"](function(a){throw a})}function i(a){return a.getConfig()}f.$inject=["$stateParams","config","nyplLocationsService"],g.$inject=["$q","$stateParams","config","nyplLocationsService"],h.$inject=["$stateParams","config","nyplLocationsService"],i.$inject=["nyplLocationsService"],h.$inject=["$stateParams","config","nyplLocationsService"],e.interceptors.push(nyplInterceptor),a.html5Mode(!0),d.setOptions({api_root:locations_cfg.config.api_root,api_version:locations_cfg.config.api_version}),b.state("subdivision",{url:"/widget/divisions/:division/:subdivision",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:i,data:g}}).state("division",{url:"/widget/divisions/:division",templateUrl:"views/widget.html",controller:"WidgetCtrl",label:"Division",resolve:{config:i,data:h}}).state("widget",{url:"/widget/:location",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:i,data:f}})}]);!function(a,b,c){"use strict";function d(){var a={url_undefined:"$nyplAlerts: API URL could not be defined",api:"$nyplAlerts: Alerts API could not retrieve data"},d={api_root:null,api_version:null};this.setOptions=function(a){b.extend(d,a)},this.$get=["$http","$q",function(b,e){var f={};return f.generateApiUrl=function(a,b){if(!a||!b)return c;var d="?callback=JSON_CALLBACK",e=a+"/"+b+"/alerts"+d;return 0===a.indexOf("http://")||0===a.indexOf("https://")?e:"http://"+e},f.getGlobalAlerts=function(){var c=e.defer(),f=this.generateApiUrl(d.api_root,d.api_version);return f?b.jsonp(f,{cache:!0}).success(function(a){c.resolve(a.alerts)}).error(function(){c.reject(a.api)}):c.reject(a.url_undefined),c.promise},f.alerts=null,f.api_url=d.api_root||null,f.api_version=d.api_version||null,f}]}function e(){var a={};return a.currentAlerts=function(a){var b,c,d=moment();return _.filter(a,function(a){return a.display&&a.display.start&&a.display.end&&(b=moment(a.display.start),c=moment(a.display.end),b.valueOf()<=d.valueOf()&&c.valueOf()>=d.valueOf())?a:void 0})},a.currentClosingAlerts=function(a){var b,c,d=moment();return _.filter(a,function(a){if(a.applies)if(a.applies.start&&a.applies.end){if(b=moment(a.applies.start),c=moment(a.applies.end),b.valueOf()<=d.valueOf()&&c.valueOf()>=d.valueOf())return a;if(d.toDate()===b.toDate()&&c.toDate()===d.toDate()&&c.valueOf()>=d.valueOf())return a}else if(a.applies.start&&(b=moment(a.applies.start),b.valueOf()<=d.valueOf()))return a})},a.currentWeekClosingAlerts=function(a){var b,c=moment().startOf("day"),d=moment().add(7,"days").startOf("day");return _.filter(a,function(a){if(a.applies&&a.applies.start){if(b=moment(a.applies.start),d.valueOf()>=b.valueOf()&&c.valueOf()<=b.valueOf())return a;if(c.valueOf()>=b.valueOf())return a}})},a.allClosingAlerts=function(a){return a?_.filter(a,function(a){return a.applies&&a.applies.start?a:void 0}):void 0},a.sortAlertsByScope=function(a){return a?_.chain(a).sortBy(function(a){return"all"===a.scope.toLowerCase()}).sortBy(function(a){return"location"===a.scope.toLowerCase()}).sortBy(function(a){return"division"===a.scope.toLowerCase()}).value():void 0},a.removeDuplicates=function(a){return a?_.chain(a).indexBy("id").flatten().uniq(function(a){return a.msg?a.msg.toLowerCase():void 0}).value():void 0},a.isAlertExpired=function(a,b){if(a&&b){var c=moment(a),d=moment(b),e=moment();return c.valueOf()<=e.valueOf()&&d.valueOf()>=e.valueOf()?!1:!0}},a.filterAlerts=function(a,b){if(a){var c=this.removeDuplicates(a),d={scope:b?b.scope||null:null,current:b?b.current||!1:!1,only_closings:b?b.only_closings||!1:!1};return d.scope&&(c=_.where(c,{scope:d.scope})),"all"===d.only_closings?c=this.allClosingAlerts(c):"current"===d.only_closings?c=this.currentClosingAlerts(c):"week"===d.only_closings?c=this.currentWeekClosingAlerts(c):(d.current===!0&&(c=this.currentAlerts(c)),c)}},a.getHoursOrMessage=function(a){if(a&&a.closedFn){var b=a.message||"",d=a.open||!1,e=a.hours||c,f=a.hoursFn,g=a.closedFn;return d?b?b:f(e):g()}},a.activeClosings=function(a){var b=this.filterAlerts(a,{only_closings:"current"});return b&&b.length?!0:!1},a.getCurrentActiveMessage=function(a){if(a){var b=this.filterAlerts(a,{only_closings:"current"}),c=_.chain(b).pluck("closed_for").first().value();return c}},a}function f(){return{restrict:"E",template:"<div class='nypl-global-alerts' data-ng-if='$root.alerts.length'><div data-ng-repeat='alert in $root.alerts'><p data-ng-bind-html='alert.msg'></p></div></div>",replace:!0,scope:!1}}function g(a){return{restrict:"E",template:"<div class='nypl-location-alerts' data-ng-if='locationAlerts.length'><div data-ng-repeat='alert in locationAlerts'><p data-ng-bind-html='alert.msg'></p></div></div>",replace:!1,scope:{alerts:"=alerts",type:"@"},link:function(b){b.alerts&&b.type.length&&(b.locationAlerts=a.filterAlerts(b.alerts,{scope:b.type,current:!0}))}}}function h(a,b,c){a.getGlobalAlerts().then(function(d){var e=b.alerts||d;b.alerts=c.filterAlerts(e,{current:!0}),a.alerts=b.alerts||d})["catch"](function(a){throw a})}f.$inject=["$rootScope"],g.$inject=["nyplAlertsService"],h.$inject=["$nyplAlerts","$rootScope","nyplAlertsService"],b.module("nyplAlerts",["ngSanitize"]).provider("$nyplAlerts",d).service("nyplAlertsService",e).run(h).directive("nyplLocationAlerts",g).directive("nyplGlobalAlerts",f)}(window,window.angular),function(a,b,c){"use strict";function d(){var a={primaryState:{name:null,customUrl:null},secondaryState:{name:null,customUrl:null}};this.setOptions=function(c){b.extend(a,c)},this.$get=["$state","$stateParams",function(b,c){var d=function(a,d){var e,f;for(e=0,f=a.length;f>e;e+=1)if(a[e].name===d.name)return;d["abstract"]||d.customUrl&&(d.url=b.href(d.name,c||{}),a.unshift(d))};return{getConfigChain:function(){var b=[];return a.secondaryState&&d(b,a.secondaryState),a.primaryState&&d(b,a.primaryState),b}}}]}function e(a,d,e){return{restrict:"E",templateUrl:"scripts/components/nypl_breadcrumbs/nypl_breadcrumbs.html",scope:{crumbName:"@"},link:function(f){function g(a,c){var d,e=a.split("."),f=c;for(d=0;d<e.length;d+=1)b.isDefined(f[e[d]])&&(f=f[e[d]]);return f}function h(a){var b,c=a;return a["abstract"]===!0&&("undefined"!=typeof f.abstractProxyProperty?(b=g(f.abstractProxyProperty,a),c=b?d.get(b):!1):c=!1),c}function i(b){var c,d,e;return f.crumbName?(d=g(f.crumbName,b),c="undefined"!=typeof b.locals?b.locals.globals:b,d===!1?!1:"undefined"==typeof d?b.name:c?e=a(d)(c):void 0):b.name}function j(a){var b,d,e,f,g=a,h=g.data.parentState,i={},j="undefined"!=typeof a.locals?a.locals.globals:a;return"object"==typeof j&&h&&j.$stateParams?(d=n(a),b=m(j,h),e=l(j),f=k(j),d&&b&&(i={displayName:d,route:b}),e&&f&&(i.division={name:e,route:f}),i?i:c):c}function k(a){var b,d,e=a,f="division";return"object"==typeof e?(Object.keys(e).forEach(function(a){"$stateParams"!==a&&(d=e[a])}),d._embedded!==c&&d._embedded.parent&&d._embedded.parent.slug?(b=d._embedded.parent.slug,f+'({ "'+f+'":"'+b+'"})'):c):c}function l(a){var b,d,e=a;return"object"==typeof e?(Object.keys(e).forEach(function(a){"$stateParams"!==a&&(d=e[a])}),d._embedded!==c&&d._embedded.parent&&d._embedded.parent.name?b=d._embedded.parent.name:c):c}function m(a,b){var d,e,f=a,g=b;return"object"==typeof f&&g?(Object.keys(f).forEach(function(a){"$stateParams"!==a&&(e=f[a])}),e.amenity?e.amenity.id&&(d=e.amenity.id):e._embedded&&e._embedded.location&&e._embedded.location.slug&&(d=e._embedded.location.slug),d?g+'({ "'+g+'":"'+d+'"})':g):c}function n(b){var e,f,g=b.data.parentState,h=d.get(g),i="undefined"!=typeof b.locals?b.locals.globals:b;if(h){if(e=a(h.data.crumbName)(i))return e;if("object"==typeof i)return Object.keys(i).forEach(function(a){"$stateParams"!==a&&(f=i[a])}),f.amenity?f.amenity.name&&(e=f.amenity.name):f._embedded&&f._embedded.location&&f._embedded.location.name&&(e=f._embedded.location.name),e?e:g}return c}function o(a,b){var c,d=!1;for(c=0;c<b.length;c++)b[c].route===a.name&&(d=!0);return d}function p(){var a,b,c,g,k=[],l=d.$current,m=e.getConfigChain();if(m)for(a=0;a<m.length;a+=1)k.push({displayName:m[a].name,route:m[a].customUrl});for(g=j(l),g&&(g.displayName&&g.route&&k.push({displayName:g.displayName,route:g.route}),g.division&&k.push({displayName:g.division.name,route:g.division.route}));l&&""!==l.name;)b=h(l),b&&(c=i(b),c===!1||o(b,k)||k.push({displayName:c,route:b.name})),l.parent&&(l=l.parent);f.breadcrumbs=k}f.breadcrumbs=[],""!==d.$current.name&&p(),f.$on("$stateChangeSuccess",function(){p()})}}}e.$inject=["$interpolate","$state","$crumb"],b.module("nyplBreadcrumbs",[]).provider("$crumb",d).directive("nyplBreadcrumbs",e)}(window,window.angular),function(){"use strict";function a(a,b){return{restrict:"E",templateUrl:"scripts/components/nypl_feedback/nypl_feedback.html",replace:!0,scope:{height:"@",width:"@",url:"@",side:"@"},link:function(c,d){var e="right";c.trusted_url=a.trustAsResourceUrl(c.url),c.feedback="Feedback","left"===c.side?(d.addClass("left"),e="left"):d.addClass("right"),b.$watch("close_feedback",function(a){a&&(b.close_feedback=!1,d.removeClass("open"),c.feedback="Feedback")}),d.find("a").click(function(){d.toggleClass("open"),c.feedback=d.hasClass("open")?"Close":"Feedback",c.$apply()})}}}a.$inject=["$sce","$rootScope"],angular.module("nyplFeedback",[]).directive("nyplFeedback",a)}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{activenav:"@",menuitem:"@"},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_navigation.html",link:function(d){$(".dropDown").hover(function(){$(this).addClass("openDropDown")},function(){$(this).removeClass("openDropDown")}),c.$watch("current_url",function(){d.logout_url="https://nypl.bibliocommons.com/user/logout?destination="+c.current_url}),$(".mobile-login").click(function(c){c.preventDefault(),a.logged_in()?b.location.href=d.logout_url:$(".sso-login").toggleClass("visible")}),d.menuLabel="Log In",a.logged_in()&&(d.menuLabel="Log Out")}}}function b(){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_collapsed_buttons.html",link:function(a,b){var c=b.find(".nav-open-button"),d=b.find(".search-open-button");c.click(function(){return $(this).toggleClass("open"),d.removeClass("open"),$("#search-block-form-input").removeClass("open-search"),$(".search-options-resp").removeClass("open"),$("#search-top").removeClass("open"),$("#main-nav").toggleClass("open-navigation"),$(".sso-login").removeClass("visible"),!1}),d.click(function(){return $(this).toggleClass("open"),c.removeClass("open"),$("#search-block-form-input").toggleClass("open-search"),$("#search-top").toggleClass("open"),$("#main-nav").removeClass("open-navigation"),$(".sso-login").removeClass("visible"),!1})}}}a.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplNavigation",[]).directive("nyplNavigation",a).directive("nyplCollapsedButtons",b)}(),function(){"use strict";function a(a){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_search/nypl_search.html",link:function(b,c){function d(a){var b=a.closest("li");return b.hasClass("search-the-catalog")?l.term.attr("placeholder",l.prompt.catalog):b.hasClass("search-the-website")?l.term.attr("placeholder",l.prompt.site):l.term.attr("placeholder",l.prompt.default_val)}function e(){return $.trim(l.term.val())}function f(a){return void 0===a&&(a="Please enter a search term"),l.term.addClass("error").attr("placeholder",a)}function g(){return l.term.removeClass("error").attr("placeholder","")}function h(){return!l.mobile_flag.is(":visible")}function i(a){return void 0===a&&(a=l.choices.find("input[type=radio]:checked").parent()),$.trim(a.text()).toLowerCase()}function j(b){var c,d=e();return void 0===b&&(b=i()),0===d.length?(f(),a.eventTrack("Empty Search",{category:"Header Search",label:""}),!1):("nypl.org"===b?(c=window.location.protocol+"//nypl.org/search/apachesolr_search/"+d,a.eventTrack("Submit Search",{category:"Header Search",label:d})):(c="http://nypl.bibliocommons.com/search?t=smart&q="+d+"&commit=Search&searchOpt=catalogue",a.eventTrack("Submit Catalog Search",{category:"Header Search",label:d})),window.location=c,!1)}function k(){angular.element("html").click(function(){c.find(".pseudo-select").removeClass("open"),c.find(".error").removeClass("error")});var b=c;l.term=b.find("#search-block-form-input"),l.search_button=b.find(".search_button"),l.choices=b.find(".pseudo-select"),l.mobile_flag=b.find(".search-button"),l.prompt={default_val:l.term.attr("placeholder"),catalog:"Search the catalog",site:"Search NYPL.org"},b.click(function(a){a.stopPropagation()}),b.find("#search-block-form").submit(function(){return l.search_button.click(),!1}),l.term.focus(function(){l.choices.addClass("open"),a.eventTrack("Focused",{category:"Header Search",label:"Search Box"})}),l.term.focus(function(){g()}),b.find(".search-button").click(function(){return j()}),l.choices.find("li input").click(function(){d(angular.element(this)),a.eventTrack("Select",{category:"Header Search",label:i()})}),l.choices.find("li").click(function(){h()&&(0===e().length?f():j(i(angular.element(this))))})}var l={};k()}}}a.$inject=["$analytics"],angular.module("nyplSearch",["angulartics","angulartics.google.analytics"]).directive("nyplSearch",a)}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_sso/nypl_sso.html",link:function(d){function e(d,e,f,g){var h="";a.remembered()&&(d.val(a.remember()),f.attr("checked",!0)),f.click(function(){$(this).is(":checked")||a.forget()}),c.$watch("current_url",function(){h=c.current_url}),g.click(function(c){var g="https://nypl.bibliocommons.com/user/login?destination=";c.preventDefault(),f.is(":checked")&&a.remember(d.val()),g+=h.replace("#","%23")+"&",g+="name="+d.val(),g+="&user_pin="+e.val(),b.location.href=g})}function f(b){var c={username:"#username",pin:"#pin",remember_checkbox:"#remember_me",login_button:"#login-form-submit"},d=$.extend({},c,b);a.logged_in()&&h.addClass("logged-in"),e($(d.username),$(d.pin),$(d.remember_checkbox),$(d.login_button))}function g(){c.$watch("current_url",function(){d.logout_url="https://nypl.bibliocommons.com/user/logout?destination="+c.current_url}),d.header_button_label="LOG IN",a.logged_in()&&(d.header_button_label=a.login(),i.addClass("logged-in")),i.click(function(){h.toggleClass("visible")})}{var h=$(".sso-login"),i=$(".login-button"),j=$(".email-input-field"),k=$("#header-news_signup input[type=submit]");$(".header-newsletter-signup")}j.focus(function(){$(".newsletter_policy").slideDown()}),j.blur(function(){$(".newsletter_policy").slideUp()}),k.click(function(){return""===j.val()?(j.focus(),!1):void 0}),f(),g()}}}function b(){var a={};return a.login=function(){return $.cookie("bc_username")},a.logged_in=function(){return!(!this.login()||null===this.login())},a.remember=function(a){return a?$.cookie("remember_me",a,{path:"/"}):$.cookie("remember_me")},a.remembered=function(){var a=this.remember();return!(!a||null===a)},a.forget=function(){return $.removeCookie("remember_me",{path:"/"})},a}a.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplSSO",[]).service("ssoStatus",b).directive("nyplSso",a)}(),function(){"use strict";function a(a,b){var c=null,d={};return d.geolocationAvailable=function(){return b.navigator||b.navigator.geolocation?!0:!1},d.getBrowserCoordinates=function(){var d=a.defer();return this.geolocationAvailable()?b.navigator.geolocation.getCurrentPosition(function(a){c=a.coords,d.resolve(c)},function(a){switch(a.code){case a.PERMISSION_DENIED:d.reject(new Error("Permission denied."));break;case a.POSITION_UNAVAILABLE:d.reject(new Error("The position is currently unavailable."));break;case a.TIMEOUT:d.reject(new Error("The request timed out."));break;default:d.reject(new Error("Unknown error."))}},{enableHighAccuracy:!0,timeout:5e3,maximumAge:6e5}):d.reject(new Error("Your browser does not support Geolocation.")),d.promise},d.getDistance=function(a,b,c,d){if(!(a&&d&&c&&d))return void 0;var e,f=Math.PI*a/180,g=Math.PI*c/180,h=b-d,i=Math.PI*h/180;return e=Math.sin(f)*Math.sin(g)+Math.cos(f)*Math.cos(g)*Math.cos(i),e=Math.acos(e),e=180*e/Math.PI,e=60*e*1.1515,Math.ceil(100*e)/100},d}a.$inject=["$q","$window"],angular.module("coordinateService",[]).factory("nyplCoordinatesService",a)}(),function(){"use strict";function a(a,b){var c,d,e="?callback=JSON_CALLBACK",f="Could not reach API",g={};return g.getConfig=function(){var a=b.defer();return d?a.resolve(d):(d=window.locations_cfg.config,d?(c=d.api_root+"/"+d.api_version,a.resolve(d)):a.reject(f+": config")),a.promise},g.allLocations=function(){var d=b.defer();return a.jsonp(c+"/locations"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": locations")}),d.promise},g.singleLocation=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": location")}),g.promise},g.singleDivision=function(d){var g=b.defer();return a.jsonp(c+"/divisions/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": division")}),g.promise},g.amenities=function(d){var g=b.defer(),h=d?"/amenities/"+d:"/amenities";return a.jsonp(c+h+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": amenities")}),g.promise},g.amenitiesAtLibrary=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+"/amenities"+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": library-amenity")}),g.promise},g.alerts=function(){var d=b.defer();return a.jsonp(c+"/alerts"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": site-wide alerts")}),d.promise},g}a.$inject=["$http","$q"],angular.module("locationService",[]).factory("nyplLocationsService",a)}(),function(){"use strict";function a(a,b,c,d,e){a.title="Amenities",b.amenitiesCategories=e.createAmenitiesCategories(c.amenities)}function b(a,b,c){var d=c.amenity,e=d.name;a.title=e,b.amenity=d,b.locations=d._embedded.locations,b.amenity_name=e}function c(a,b,c,d,e){var f=e.allAmenitiesArray(d._embedded.amenities);b.amenitiesCategories=e.createAmenitiesCategories(f),a.title=d.name,b.location=d}a.$inject=["$rootScope","$scope","amenities","config","nyplAmenities"],b.$inject=["$rootScope","$scope","amenity","config"],c.$inject=["$rootScope","$scope","config","location","nyplAmenities"],angular.module("nypl_locations").controller("AmenityCtrl",b).controller("AmenitiesCtrl",a).controller("AmenitiesAtLibraryCtrl",c)}(),function(){"use strict";function a(a,b,c,d,e){var f=c.divisions_with_appointments;b.division=d,b.location=d._embedded.location,a.title=d.name,b.calendarLink=e.calendarLink,b.icalLink=e.icalLink,e.scrollToHash(),b.createHash=function(a){e.createHash(a)},d.hours&&(b.hoursToday=e.hoursToday(d.hours),d.hours.exceptions&&(d.hours.exceptions.description=e.returnHTML(d.hours.exceptions.description))),d._embedded.divisions&&_.each(d._embedded.divisions,function(a){a.hoursToday=e.hoursToday(a.hours)}),b.division.social_media=e.socialMediaColor(d.social_media),b.has_appointment=e.divisionHasAppointment(f,d.id)}a.$inject=["$rootScope","$scope","config","division","nyplUtility"],angular.module("nypl_locations").controller("DivisionCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){var b=h.activeClosings(a);return b?!0:!1}function p(b){return a("timeFormat")(l.hoursToday(b))}function q(){return"<b>Branch is temporarily closed.</b>"}function r(){c.globalClosingMessage,f.alerts&&f.alerts.length&&(c.globalClosingMessage=h.getCurrentActiveMessage(f.alerts))}var s,t=m.getSearchValues(),u=g.research_order||["SASB","LPA","SC","SIBL"],v={coords:{},address:""},w=function(a){c.predicate=a},x=function(a,b){_.each(a,function(a){a[b]=""})},y=function(){c.searchMarker=!1,c.researchBranches=!1,c.userMarker=!1,c.reverse=!1,c.searchTerm="",c.geolocationAddressOrSearchQuery="",c.select_library_for_map="",w("name"),x(c.locations,"distance"),x(c.locations,"highlight")},z=function(){i.geolocationAvailable()&&(c.geolocationOn=!0)},A=function(){return"home.map"===e.current.name},B=function(){return i.getBrowserCoordinates().then(function(a){return v.coords=_.pick(a,"latitude","longitude"),v})},C=function(a){if(c.locations=l.calcDistance(c.locations,a.coords),l.checkDistance(c.locations))throw y(),new Error("You are not within 25 miles of any NYPL library.");return a.coords},D=function(){c.locationStart=v.coords.latitude+","+v.coords.longitude,c.userMarker=!0,A()||e.go("home.map"),w("distance"),j.createMarker("user",v.coords,"Your Current Location"),c.drawUserMarker()},E=function(a){return m.resetSearchValues(),j.reverseGeocoding({lat:a.latitude,lng:a.longitude}).then(function(a){return c.geolocationAddressOrSearchQuery=a,m.setSearchValue("resultsNear",a).setSearchValue("locations",c.locations),a})},F=function(a){return m.setSearchValue("searchTerm",a),j.geocodeAddress(a).then(function(a){return{coords:a,searchTerm:a.name}})["catch"](function(a){throw a})},G=function(a){var b=c.locations,d=a.coords,e=a.searchTerm;if(b=l.calcDistance(b,d),l.checkDistance(b))throw c.searchError=e,j.panMap(),new Error("The search query is too far");return c.userMarker=!1,j.removeMarker("user"),m.setSearchValue("resultsNear",a.searchTerm),c.geolocationAddressOrSearchQuery=e,c.searchError="",b},H=function(a,b,d){x(a,"highlight"),_.each(b,function(a){a.highlight="active",a.distance=""}),a=_.sortBy(a,function(a){return a[d]}),a=_.difference(a,b),c.locations=_.union(b,a),m.setSearchValue("locations",c.locations),w(d)},I=function(){var a=[angular.element(".locations-list-view tbody"),angular.element(".locations-data-wrapper")];_.each(a,function(a){$(a).animate({scrollTop:"0px"},1e3)})},J=function(a){c.location_type=a},K=function(){t.locations?(c.locations=t.locations,c.searchTerm=t.searchTerm,c.geolocationAddressOrSearchQuery=t.resultsNear,c.searchMarker=t.searchMarker,c.searchMarker&&j.drawSearchMarker(),w(c.geolocationAddressOrSearchQuery?"distance":"name")):c.loadLocations()};c.loadLocations=function(){return k.allLocations().then(function(a){var b=n.getAmenityConfig(g);return s=a.locations,c.locations=s,r(),_.each(c.locations,function(a){var c,d=l.getAddressString(a,!0),e={},f=a._embedded.alerts,g=h.getCurrentActiveMessage(f);a.geolocation&&a.geolocation.coordinates&&(e={latitude:a.geolocation.coordinates[1],longitude:a.geolocation.coordinates[0]}),a.locationDest=l.getAddressString(a),a.amenities_list=n.getHighlightedAmenities(a._embedded.amenities,b.global,b.local),a.research_order=l.researchLibraryOrder(u,a.id),!j.doesMarkerExist(a.slug)&&a.geolocation&&j.createMarker(a.slug,e,d),a.closingMessageClass=o(f),a.todaysHoursDisplay=g?"Today:":"Today's Hours:",c={message:g,open:a.open,hours:a.hours,hoursFn:p,closedFn:q},a.hoursOrClosingMessage=h.getHoursOrMessage(c)}),y(),m.setSearchValue("locations",c.locations),s})["catch"](function(a){throw e.go("404"),a})},c.scrollPage=function(){var a,b=angular.element(".container__all-locations"),c=parseInt(b.css("width"),10);601>c&&(a=angular.element(".map-search__results").offset()||angular.element(".search__results").offset(),d(function(){angular.element("body").animate({scrollTop:a.top},1e3)},1e3))},c.viewMapLibrary=function(a){var b=_.where(c.locations,{slug:a});c.select_library_for_map=a,c.searchMarker=!1,A()?j.hideSearchInfowindow().panExistingMarker(a):e.go("home.map"),H(c.locations,b,"name"),c.scrollPage()},c.useGeolocation=function(){j.removeMarker("search"),y(),c.scrollPage(),I(),B().then(C).then(E).then(D)["catch"](function(a){c.distanceError=a.message,c.geolocationOn=!1})},c.clearSearch=function(){m.resetSearchValues(),J(),j.showAllLibraries().removeMarker("user"),A()&&j.removeMarker("search").hideInfowindow().panMap(),y(),I()},c.drawUserMarker=function(){j.doesMarkerExist("user")&&j.panExistingMarker("user")},c.geocodeAddress=function(a){!a||a.length<3||(c.geolocationAddressOrSearchQuery="",c.searchError="",J(),c.researchBranches=!1,j.showAllLibraries(),c.searchTerm=a,a=m.searchWordFilter(a),I(),A()||e.go("home.map"),F(a).then(function(a){return j.createSearchMarker(a.coords,a.searchTerm),G(a)}).then(function(a){c.scrollPage(),c.searchMarker=!0,m.setSearchValue("searchMarker",!0),j.drawSearchMarker(),H(a,[],"distance")})["catch"](function(){j.removeMarker("search"),c.searchMarker=!1,m.resetSearchValues(),y()}))},c.showResearch=function(){j.hideInfowindow(),I(),c.researchBranches=!c.researchBranches,c.researchBranches?(j.showResearchLibraries().panMap(),J("research"),w("research_order")):(j.showAllLibraries().panMap(),J(),w("name"))},b.title="Locations",c.$state=e,K(),z()}function b(a,b,c){var d=function(){b(function(){a.locations&&(c.showAllLibraries(),a.researchBranches&&c.showResearchLibraries())},1200)},e=function(){b(function(){c.drawMap({lat:40.7532,"long":-73.9822},12,"all-locations-map").drawLegend("all-locations-map-legend"),a.locations&&c.showAllLibraries(),d(),a.drawUserMarker(),a.searchMarker&&c.drawSearchMarker(),a.researchBranches&&c.showResearchLibraries(),a.select_library_for_map&&c.panExistingMarker(a.select_library_for_map),a.scrollPage()},1200)};e(),a.panToLibrary=function(b){c.hideSearchInfowindow().panExistingMarker(b),a.scrollPage()}}function c(a,b,c,d,e,f,g,h){var i=e._embedded.amenities,j=h.getAmenityConfig(d),k=function(){return f.getBrowserCoordinates().then(function(a){var d=_.pick(a,"latitude","longitude");c(function(){b.locationStart=d.latitude+","+d.longitude})})};k(),g.scrollToHash(),b.createHash=function(a){g.createHash(a)},b.location=e,a.title=e.name,e.hours.exceptions&&(e.hours.exceptions.description=g.returnHTML(e.hours.exceptions.description)),_.each(e._embedded.amenities,function(a){a.amenity=h.addAmenitiesIcon(a.amenity)}),e.amenities_list=h.getHighlightedAmenities(i,j.global,j.local),b.calendarLink=g.calendarLink,b.icalLink=g.icalLink,b.location.social_media=g.socialMediaColor(b.location.social_media),e.hours&&(b.hoursToday=g.hoursToday(e.hours)),e._embedded.exhibitions&&_.each(e._embedded.exhibitions,function(a){a.start&&a.end&&(a.prettyDate=g.formatDate(a.start,a.end))}),_.each(e._embedded.divisions,function(a){a.hoursToday=g.hoursToday(a.hours)}),_.each(e._embedded.features,function(a){"string"==typeof a.body&&(a.body=g.returnHTML(a.body))}),b.locationDest=g.getAddressString(e),d.closed_img&&(b.location.images.closed=d.closed_img)}a.$inject=["$filter","$rootScope","$scope","$timeout","$state","$nyplAlerts","config","nyplAlertsService","nyplCoordinatesService","nyplGeocoderService","nyplLocationsService","nyplUtility","nyplSearch","nyplAmenities"],b.$inject=["$scope","$timeout","nyplGeocoderService"],c.$inject=["$rootScope","$scope","$timeout","config","location","nyplCoordinatesService","nyplUtility","nyplAmenities"],angular.module("nypl_locations").controller("LocationsCtrl",a).controller("MapCtrl",b).controller("LocationCtrl",c)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){b.title=g.name,c.data=g,c.locinator_url="http://www.nypl.org/locations"+a.path().substr(7),
c.widget_name=g.name,g._embedded.location&&(c.division=!0,c.data.images.exterior=g.images.interior),f.closed_img&&(c.data.images.closed=f.closed_img),g.hours&&(c.hoursToday=i.hoursToday(g.hours)),c.data.social_media=i.socialMediaColor(c.data.social_media),c.locationDest=i.getAddressString(g)}a.$inject=["$location","$rootScope","$scope","$timeout","$window","config","data","nyplCoordinatesService","nyplUtility"],angular.module("nypl_widget").controller("WidgetCtrl",a)}(),function(){"use strict";function a(a){return{restrict:"A",link:function(b,c){var d=function(){c.addClass("show")},e=function(){c.removeClass("show")};c.hasClass("show")&&c.removeClass("show"),a.onRequestStarted(b,d),a.onRequestEnded(b,e)}}}function b(a,b,c){return{restrict:"EA",replace:!1,templateUrl:"scripts/directives/templates/todaysHours.html",scope:{hours:"=hours",alerts:"=alerts"},link:function(b,c,d,e){var f={},g=b.hours||null;b.alerts&&(f.current_global=a.filterAlerts(b.alerts,{scope:"all",only_closings:"current"}),f.current_location=a.filterAlerts(b.alerts,{scope:"location",only_closings:"current"}),f.current_division=a.filterAlerts(b.alerts,{scope:"division",only_closings:"current"}),f.all_closings=a.filterAlerts(b.alerts,{only_closings:"week"})),b.todaysHours=e.computeHoursToday(g,f),b.showIcon="true"===d.displayIcon?!0:!1},controller:["$scope",function(){this.getAlertMsg=function(a){return"Today: "+_.chain(a).pluck("closed_for").flatten(!0).first().value()},this.getLocationHours=function(a,d){return c("hoursTodayFormat")(b.hoursToday(a,d))},this.computeHoursToday=function(a,b){return a?b?b.current_global&&b.current_global.length?this.getAlertMsg(b.current_global):b.current_location&&b.current_location.length?this.getAlertMsg(b.current_location):b.current_division&&b.current_division.length?this.getAlertMsg(b.current_division):this.getLocationHours(a,b):this.getLocationHours(a):"Not available"}}]}}function c(a){return{restrict:"EA",templateUrl:"scripts/directives/templates/hours-table.html",replace:!0,scope:{hours:"=hours",alerts:"=alerts"},link:function(b,c,d,e){var f,g,h=angular.copy(b.hours)||null;b.alerts&&(g=a.filterAlerts(b.alerts,{only_closings:"week"})),g&&g.length&&(f=a.sortAlertsByScope(g)),b.dynamicWeekHours=f?e.findAlertsInWeek(h,f):null,b.numAlertsInWeek=b.dynamicWeekHours?e.findNumAlertsInWeek(b.dynamicWeekHours):0,b.regularWeekHours=b.hours||null,b.buttonText=f?"Regular hours":null,b.displayDynamicWeek=b.dynamicWeekHours&&b.numAlertsInWeek>0?!0:!1,b.displayDynamicWeek&&c.addClass("hide-regular-hours"),b.toggleHoursTable=function(){c.hasClass("hide-regular-hours")?(c.removeClass("hide-regular-hours"),c.addClass("hide-dynamic-hours"),b.buttonText="Upcoming hours"):c.hasClass("hide-dynamic-hours")&&(c.removeClass("hide-dynamic-hours"),c.addClass("hide-regular-hours"),b.buttonText="Regular hours")}},controller:["$scope",function(){this.findAlertsInWeek=function(a,b){if(!a&&!b)return null;var c=this,d=moment().day(),e=_.each(a,function(a,e){a.is_today=e===d?!0:!1,a.date=c.assignDynamicDate(e),null!==a.open&&null!==a.close&&(a.alert=c.assignCurrentDayAlert(b,a.date))});return e},this.findNumAlertsInWeek=function(a){if(!a)return 0;var b=0;return _.each(a,function(a){a.alert&&b++}),b},this.isSameDayAlert=function(a,b,c){var d=moment();return a.isSame(b,"day")&&c.isSame(a,"day")&&d.isBefore(b)?!0:!1},this.assignDynamicDate=function(a){var b,c=moment();return b=moment().weekday(a<c.weekday()?a+7:a)},this.assignCurrentDayAlert=function(a,b){var c,d,e=this;return _.find(a,function(a){if(a.applies.start&&a.applies.end){if(c=moment(a.applies.start),d=moment(a.applies.end),a.infinite=!1,e.isSameDayAlert(c,d,b))return a;if(b.isBetween(c,d))return a}else if(a.applies.start&&!a.applies.end&&(c=moment(a.applies.start),a.infinite=!0,b.isAfter(c)))return a})}}]}}function d(){return{restrict:"E",templateUrl:"scripts/directives/templates/emailus.html",replace:!0,scope:{link:"@"}}}function e(a){return{restrict:"E",templateUrl:"scripts/directives/templates/librarianchat.html",replace:!0,link:function(b,c){b.openChat=function(){a.popupWindow("http://www.nypl.org/ask-librarian","NYPL Chat",210,450),c.hasClass("active")||c.addClass("active")}}}}function f(a){return function(b){b.$on("$stateChangeStart",function(){a.scrollTo(0,0)})}}function g(a){function b(a){var b=new Date(a),c=new Date;return b.getTime()>c.getTime()?!0:!1}return{restrict:"E",templateUrl:"scripts/directives/templates/registration.html",replace:!0,scope:{registration:"=",status:"=",link:"="},link:function(c){c.online=!1,c.registration&&(c.eventRegStarted=b(c.registration.start),"Online"===c.registration.type?(c.online=!0,c.reg_msg=c.eventRegStarted?"Online, opens "+a("date")(c.registration.start,"MM/dd"):"Online"):c.reg_msg=c.registration.type)}}}function h(){function a(a,b,c){var d=c.collapse,e=c.className||"open",f=c.duration||"fast";a.$eval(d)||b.hide(),a.$watch(d,function(a,c){a!==c&&(a?b.stop(!0,!0).slideDown(f).addClass(e):b.stop(!0,!0).slideUp(f).removeClass(e))})}return{link:a,restrict:"A"}}function i(a,b){return{restrict:"E",templateUrl:"scripts/directives/templates/fundraising.html",replace:!0,scope:{fundraising:"=fundraising",category:"@"},link:function(c){c.fundraising||a(function(){b.getConfig().then(function(a){var b=a.fundraising;c.fundraising={appeal:b.appeal,statement:b.statement,button_label:b.button_label,link:b.link}})},200)}}}function j(){return{restrict:"E",templateUrl:"scripts/directives/templates/sidebar-widgets.html",replace:!0,scope:{donateButton:"@",nyplAsk:"@"},link:function(a,b,c){var d="https://secure3.convio.net/nypl/site/SPageServer?pagename=donation_form&JServSessionIdr003=dwcz55yj27.app304a&s_src=FRQ14ZZ_SWBN";a.donateUrl=c.donateurl||d}}}function k(a){return{restrict:"E",templateUrl:"scripts/directives/templates/footer.html",replace:!0,scope:{},link:function(b,c){var d,e=c.find(".footerlinks a");e.click(function(){d=angular.element(this).attr("href"),a.eventTrack("Click",{category:"footer",label:d})}),b.year=(new Date).getFullYear()}}}function l(a,b,c){return{restrict:"AEC",templateUrl:"scripts/directives/templates/autofill.html",scope:{data:"=",model:"=ngModel",mapView:"&",geoSearch:"&"},link:function(d,e,f,g){function h(){d.$watch("model",function(a){g.updateSearchText(d.data,a)}),d.$on("$stateChangeSuccess",function(){g.resetSearchTerms(),g.closeAutofill()})}d.focused=!1,d.activated=!1,d.geocodingactive=!1,d.filtered=[];var i=angular.element(document.getElementById("searchTerm")),j=angular.element(document.getElementsByTagName("html")),k=angular.element(document.getElementById("find-location"));i.bind("focus",function(){d.$apply(function(){g.openAutofill()})}),i.bind("click",function(a){a.stopPropagation()}),i.bind("keyup",function(e){13===e.keyCode&&d.$apply(function(){d.activated?d.active.slug?(d.activated=!1,g.closeAutofill(),d.model=d.active.name,c.setSearchValue("searchTerm",d.active.name),a.go("location",{location:d.active.slug})):(d.geoSearch({term:d.model}),d.geocodingactive=!1,d.activated=!1,i.blur()&&g.closeAutofill()):g.setSearchText()?(d.model=d.items[0].name,c.setSearchValue("searchTerm",d.model),g.closeAutofill(),b.eventTrack("Accept",{category:"Locations",label:d.model}),a.go("location",{location:d.items[0].slug})):(g.handleSearch(d.model),i.blur()&&g.closeAutofill())}),39===e.keyCode&&d.$apply(function(){g.setSearchText()}),8===e.keyCode&&d.$apply(function(){d.lookahead=""})}),i.bind("keydown",function(a){(9===a.keyCode||13===a.keyCode||27===a.keyCode)&&a.preventDefault(),38===a.keyCode&&(a.preventDefault(),d.$apply(function(){d.activated?g.activatePreviousItem():g.activateFirstItem()})),40===a.keyCode&&(a.preventDefault(),d.$apply(function(){d.activated?g.activateNextItem():g.activateFirstItem(),g.activateGeocodingItem()}))}),j.bind("click",function(){d.$apply(function(){g.closeAutofill()})}),k.bind("click",function(a){a.preventDefault(),d.$apply(function(){g.handleSearch(d.model)})}),h()},controller:["$scope",function(b){b.lookahead="",b.currentWord="",b.completeWord="",this.closeAutofill=function(){return b.focused=!1},this.openAutofill=function(){return b.focused=!0},this.activate=function(a){return a},this.activateFirstItem=function(){b.active=b.filtered[0],b.currentIndex=b.filtered.indexOf(b.active),b.activated=!0},this.activateNextItem=function(){b.geocodingactive=!1,b.currentIndex<b.filtered.length&&b.currentIndex>=0?(b.currentIndex=b.filtered.indexOf(b.active)+1,b.active=this.activate(b.filtered[b.currentIndex])):(b.active=void 0,b.currentIndex=-1)},this.activatePreviousItem=function(){b.geocodingactive=!1,-1===b.currentIndex?(b.currentIndex=b.filtered.length-1,b.active=this.activate(b.filtered[b.currentIndex])):b.currentIndex<=b.filtered.length&&b.currentIndex>0&&(b.currentIndex=b.currentIndex-1,b.active=this.activate(b.filtered[b.currentIndex]))},this.activateGeocodingItem=function(){!b.active&&b.activated&&(b.active=this.activate(b.model),b.geocodingactive=!0)},this.setSearchText=function(){return b.completeWord!==b.model&&""!==b.completeWord&&""!==b.model?b.model=b.completeWord:void 0},this.resetSearchTerms=function(){b.lookahead="",b.currentWord=""},this.filterStartsWith=function(a,b){return _.filter(a,function(a){return a.name?a.name.substring(0,b.length).toLowerCase()===b.toLowerCase():!1})},this.filterTermWithin=function(a,b,c){var d=this;return _.filter(a,function(a){if("name"===c){if(a.name)return d.cleanText(a.name).indexOf(d.cleanText(b))>=0}else if("id"===c&&a.id)return a.id.toLowerCase().indexOf(b.substring(1,b.length).toLowerCase())>=0;return!1})},this.cleanText=function(a){return a.replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^_`{|}~']/g,"").toLowerCase()},this.handleSearch=function(d){if(d.length){var e,f="!"===d.charAt(0)?d.slice(1):d;f.length>1&&(b.filtered&&b.filtered.length?(e=b.filtered[0],(f.toLowerCase()===e.id.toLowerCase()||this.cleanText(e.name).indexOf(this.cleanText(f))>=0)&&(c.setSearchValue("searchTerm",d),a.go("location",{location:e.slug}))):b.geoSearch({term:f}))}},this.updateSearchText=function(a,c){return""!==c&&c&&a&&c.length>0?(b.items=this.filterStartsWith(a,c),"!"===c.charAt(0)?(b.filtered=this.filterTermWithin(a,c,"id"),b.filterById=!0):(b.filtered=this.filterTermWithin(a,c,"name"),b.filterById=!1),b.items[0]?(b.lookahead=b.items[0].name.substring(c.length),b.currentWord=c):this.resetSearchTerms(),b.completeWord=b.currentWord+b.lookahead):void 0}}]}}a.$inject=["requestNotificationChannel"],b.$inject=["nyplAlertsService","nyplUtility","$filter"],c.$inject=["nyplAlertsService"],e.$inject=["nyplUtility"],f.$inject=["$window"],g.$inject=["$filter"],i.$inject=["$timeout","nyplLocationsService"],k.$inject=["$analytics"],l.$inject=["$state","$analytics","nyplSearch"],angular.module("nypl_locations").directive("loadingWidget",a).directive("todayshours",b).directive("hoursTable",c).directive("emailusbutton",d).directive("librarianchatbutton",e).directive("scrolltop",f).directive("eventRegistration",g).directive("nyplFundraising",i).directive("nyplSidebar",j).directive("nyplAutofill",l).directive("collapse",h).directive("nyplFooter",k),angular.module("nypl_widget").directive("todayshours",b).directive("nyplFundraising",i).directive("librarianchatbutton",e).directive("emailusbutton",d)}(),function(){"use strict";function a(a){function b(a){var b=a.split(":"),c=parseInt(b[0],10);return c}function c(a){var b=a.split(":"),c=(parseInt(b[0],10)+11)%12+1,d=b[1],e=b[0]>=12?"pm":"am";return c+":"+d+e}function d(c,d){var e,f,g,h,i,j;return d.length||(e=moment(d.applies.start),f=moment(d.applies.end),h=b(c.open),i=b(c.close),g=f.isAfter(e,"day")?!0:!1,j=g||alert.infinite===!0?"Closed *":e.hours()<=h&&f.hours()>=i?"Closed *":h<e.hours()&&i<=f.hours()?"Closing early *":i>f.hours()&&h>=e.hours()?"Opening late *":"Change in hours *"),a.trustAsHtml(j)}return function(a){var b,e=void 0!==a&&void 0!==a.today?a.today:a;return e?(b=e.alert||null,null===e.open?"Closed":b?d(e,b):c(e.open)+" - "+c(e.close)):(console.log("timeFormat() filter error: Argument is not defined or empty, verify API response for time"),"")}}function b(){return function(a){return new Date(a).toISOString()}}function c(){return function(a){return"string"==typeof a?a.replace(/(^|\s)([a-z])/g,function(a){return a.toUpperCase()}):a}}function d(){function a(a){return a=a.split(":"),_.object(["hours","mins","meridian","military"],[(parseInt(a[0],10)+11)%12+1,a[1],a[0]>=12?"pm":"am",parseInt(a[0],10)])}return function(b){var c,d,e,f,g,h,i,j=moment(),k=j.get("hour");return b?(e=b.today,f=b.tomorrow,e.open&&e.close?(e.open&&(c=a(e.open)),e.close&&(d=a(e.close)),null!==f.alert&&(i=f.alert.closed_for||null),null!==f.open&&(g=a(f.open)),null!==f.close&&(h=a(f.close)),k>=d.military?i?"Tomorrow: "+i:g&&h?"Open tomorrow "+g.hours+(0!==parseInt(g.mins,10)?":"+g.mins:"")+g.meridian+"-"+h.hours+(0!==parseInt(h.mins,10)?":"+h.mins:"")+h.meridian:"Closed today":k<c.military?"Open today "+c.hours+(0!==parseInt(c.mins,10)?":"+c.mins:"")+c.meridian+"-"+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian:"Open today until "+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian):(console.log("Obj is undefined for open/close properties"),"Closed today")):"Not available"}}function e(){return function(a,b,c){return"string"!=typeof a?a:a.length<200?a:(isNaN(b)&&(b=200),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c)}}a.$inject=["$sce"],angular.module("nypl_locations").filter("timeFormat",a).filter("dateToISO",b).filter("capitalize",c).filter("hoursTodayFormat",d).filter("truncate",e),angular.module("nypl_widget").filter("hoursTodayFormat",d)}(),function(){"use strict";function a(){var a={},b=function(a,b){return a instanceof Array?_.sortBy(a,function(a){return a.amenity?a.amenity[b]?a[b]:a.amenity[b]:void 0}):void 0};return a.addAmenitiesIcon=function(a){return a&&a.category?(a.icon=this.getCategoryIcon(a.category),a.icon=this.getAmenityIcon(a.id,a.icon),a):void 0},a.getCategoryIcon=function(a,b){var c=b||"";switch(a){case"Computer Services":c="icon-screen2";break;case"Circulation":c="icon-book";break;case"Printing and Copy Services":c="icon-copy";break;case"Facilities":c="icon-library";break;case"Assistive Technologies":c="icon-accessibility2"}return c},a.getAmenityIcon=function(a,b){var c=b||"";switch(a){case 7967:case 8123:c="icon-connection";break;case 7965:c="icon-laptop";break;case 7966:c="icon-print";break;case 7968:c="icon-power-cord";break;case 7971:case 7972:c="icon-box-add"}return c},a.allAmenitiesArray=function(a){return a?_.chain(a).pluck("amenity").flatten(!0).value():void 0},a.getAmenityCategories=function(a){return a?_.chain(a).pluck("category").flatten(!0).unique().value():void 0},a.createAmenitiesCategories=function(a){var b,c,d=["Computer Services","Circulation","Printing and Copy Services","Facilities","Assistive Technologies"],e=[],f=this;if(a)return b=this.getAmenityCategories(a),_.each(b,function(b){c={},c.amenities=_.where(a,{category:b}),c.name=b,c.icon=f.getCategoryIcon(b),c.amenities.length&&(e[_.indexOf(d,b)]=c)}),e},a.getHighlightedAmenities=function(a,c,d){var e=a,f=[];if(a&&a.length&&c&&d)return e=b(e,"rank"),f=e.splice(0,c),e=b(e,"location_rank"),e=e.splice(0,d),f=_.union(f,e)},a.getAmenityConfig=function(a,b,c){var d={},e=b||3,f=c||2;return a&&a.featured_amenities?(d.global=a.featured_amenities.global||e,d.local=a.featured_amenities.local||f):(d.global=e,d.local=f),d},a}angular.module("nypl_locations").factory("nyplAmenities",a)}(),function(){"use strict";function a(a){var b,c,d=[],e=new google.maps.Marker({icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}),f=new google.maps.InfoWindow,g=new google.maps.InfoWindow,h={},i=function(a){return _.findWhere(d,{id:a})},j=function(a,c){h.hideInfowindow(),g.setContent(c),g.open(b,a)},k=function(a){var b=i(a);h.doesMarkerExist(a)&&b.marker.setMap(null)},l=function(a){var c=i(a);c&&c.marker.setMap(b)};return h.geocodeAddress=function(b){var c=a.defer(),d={},e=new google.maps.Geocoder,f=new google.maps.LatLng(40.49,-74.26),g=new google.maps.LatLng(40.91,-73.77),h=new google.maps.LatLngBounds(f,g),i={address:b,bounds:h,region:"US",componentRestrictions:{country:"US",locality:"New York"}};return e.geocode(i,function(a,b){b===google.maps.GeocoderStatus.OK?(d.lat=a[0].geometry.location.lat(),d["long"]=a[0].geometry.location.lng(),d.name=a[0].formatted_address,c.resolve(d)):c.reject(new Error(b))}),c.promise},h.reverseGeocoding=function(b){var c,d=a.defer(),e=new google.maps.Geocoder,f=new google.maps.LatLng(b.lat,b.lng);return e.geocode({latLng:f},function(a,b){b===google.maps.GeocoderStatus.OK?(c=a[0].formatted_address,d.resolve(c)):d.reject(new Error(b))}),d.promise},h.drawMap=function(a,c,d){var e=new google.maps.LatLng(a.lat,a["long"]),f={zoom:c,center:e,mapTypeControl:!1,panControl:!0,zoomControl:!0,scaleControl:!0,streetViewControl:!1};return b=new google.maps.Map(document.getElementById(d),f),this},h.drawLegend=function(a){var c=document.getElementById(a);return b.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(c),c.className="show-legend",this},h.panMap=function(a){var c,d,e=new google.maps.LatLng(40.7632,-73.9822);if(b)return a?(c=a.getPosition(),d=14):(c=e,d=12),b.panTo(c),b.setZoom(d),this},h.showResearchLibraries=function(){var a=["schwarzman","lpa","sibl","schomburg","user"];return _.each(d,function(b){_.contains(a,b.id)||k(b.id)}),this},h.showAllLibraries=function(){return d&&_.each(d,function(a){l(a.id)}),this},h.createMarker=function(a,b,c){var e,f=new google.maps.LatLng(b.latitude,b.longitude),g={position:f,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"};"user"===a&&(g.icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",g.zIndex=1e3,g.animation=google.maps.Animation.DROP),e=new google.maps.Marker(g),d.push({id:a,marker:e,text:c}),google.maps.event.addListener(e,"click",function(){j(e,c)})},h.hideInfowindow=function(){return g.close(),this},h.doesMarkerExist=function(a){return!!i(a)},h.createSearchMarker=function(a,b){var c=b.replace(","," <br>").replace(","," <br>"),d=new google.maps.LatLng(a.lat,a["long"]);e.setPosition(d),f.setContent(c)},h.drawSearchMarker=function(){return c||(e.setMap(b),this.panMap(e),f.open(b,e),this.hideInfowindow(),google.maps.event.addListener(e,"click",function(){f.open(b,e)})),this},h.hideSearchInfowindow=function(){return f.close(),this},h.removeMarker=function(a){return a?("search"===a?e.setMap(null):k(a),this):this},h.panExistingMarker=function(a){var b=i(a),c=b.marker;return(void 0===c.getMap()||null===c.getMap())&&l(a),this.panMap(c),j(b.marker,b.text),this},h}a.$inject=["$q"],angular.module("nypl_locations").factory("nyplGeocoderService",a)}(),function(){"use strict";function a(a){var b={},c={};return b.setSearchValue=function(a,b){return c[a]=b,this},b.getSearchValues=function(){return c},b.resetSearchValues=function(){return c={},this},b.idLocationSearch=function(a,b){var c=[];if(a&&b)return b.length>=2&&b.length<=4&&(c=_.where(a,{id:b.toUpperCase()})),c},b.locationSearch=function(b,c){var d,e;if(b&&c&&!(c.length<3))return d=a("filter")(b,c),e=a("filter")(b,c,!0),d},b.searchWordFilter=function(a){var b=["branch"];if(a)return _.each(b,function(b){a=a.replace(b,"")}),a},b}a.$inject=["$filter"],angular.module("nypl_locations").factory("nyplSearch",a)}(),function(){"use strict";function a(a){var b="_START_REQUEST_",c="_END_REQUEST_",d={};return d.requestStarted=function(){a.$broadcast(b)},d.requestEnded=function(){a.$broadcast(c)},d.onRequestStarted=function(a,c){a.$on(b,function(a){c(a)})},d.onRequestEnded=function(a,b){a.$on(c,function(a){b(a)})},d}function b(a,b,c,d,e,f){var g={};return g.hoursToday=function(a,b){var c,d,e,f,g=moment().day(),h=moment().add(1,"days").startOf("day");return b&&b.all_closings&&b.all_closings.length&&(d=b.all_closings),a&&(d&&d.length&&(f=_.find(d,function(a){return a.applies?(e=moment(a.applies.start),"all"===a.scope&&e.isSame(h,"day")?a:"location"===a.scope&&e.isSame(h,"day")?a:"division"===a.scope&&e.isSame(h,"day")):void 0})),c={today:{day:a.regular[g].day,open:a.regular[g].open,close:a.regular[g].close},tomorrow:{day:a.regular[h.day()%7].day,open:a.regular[h.day()%7].open,close:a.regular[h.day()%7].close,alert:f||null}}),c},g.formatDate=function(a,b){var c;if(this.numDaysBetween=function(a,b){var c=moment(a),d=moment(b);return d.diff(c,"days")},this.dateToString=function(a,b,c){var e,f=["January","February","March","April","May","June","July","August","September","October","November","December"];if(a||b){switch(c){case"current":e="Open now. Ends "+f[b.getUTCMonth()]+" "+b.getUTCDate()+", "+b.getUTCFullYear()+".";break;case"current-ongoing":e="Open now. Ongoing.";break;case"upcoming":e="Opening soon. "+f[a.getUTCMonth()]+" "+a.getUTCDate()+", "+a.getUTCFullYear()+" - "+f[b.getUTCMonth()]+" "+b.getUTCDate()+", "+b.getUTCFullYear()+".";break;case"upcoming-ongoing":e="Opening soon. "+f[d.getUTCMonth()]+" "+d.getUTCDate()+", "+d.getUTCFullYear()+".";break;default:e=f[a.getUTCMonth()]+" "+a.getUTCDate()+", "+a.getUTCFullYear()+" - "+f[b.getUTCMonth()]+" "+b.getUTCDate()+", "+b.getUTCFullYear()+"."}return e}},a&&b){var d=new Date(a),e=new Date(b),f=new Date,g=this.numDaysBetween(d,e),h=365;c=d.getTime()<=f.getTime()&&e.getTime()>=f.getTime()&&h>g&&g>0?this.dateToString(d,e,"current"):d.getTime()<=f.getTime()&&e.getTime()>=f.getTime()&&g>h?this.dateToString(d,e,"current-ongoing"):d.getTime()>f.getTime()&&e.getTime()>=f.getTime()&&h>g&&g>0?this.dateToString(d,e,"upcoming"):this.dateToString(d,e,"upcoming-ongoing")}return c},g.branchException=function(a){var b={};if(a){if(!a.exceptions)return null;if(""!==a.exceptions.description.trim())return b.desc=a.exceptions.description,a.exceptions.start&&(b.start=a.exceptions.start),a.exceptions.end&&(b.end=a.exceptions.end),b}return null},g.getAddressString=function(a,b){if(!a)return"";var c=" ",d="";return b&&(d="<a href='/locations/"+a.slug+"'>"+a.name+"</a><br />",c="<br />"),d+a.street_address+c+a.locality+", "+a.region+", "+a.postal_code},g.socialMediaColor=function(a){return _.each(a,function(a){switch(a.classes="icon-",a.site){case"facebook":a.classes+=a.site+" blueDarkerText";break;case"foursquare":a.classes+=a.site+" blueText";break;case"instagram":a.classes+=a.site+" blackText";break;case"twitter":a.classes+=a.site+"2 blueText";break;case"tumblr":a.classes+=a.site+"2 indigoText";break;case"youtube":case"pinterest":a.classes+=a.site+" redText";break;default:a.classes+=a.site}}),a},g.popupWindow=function(a,b,c,d){var f,g,h,i,j;a&&(f=void 0===c?"300":"string"==typeof c||c instanceof String?c:c.toString(),g=void 0===d?"500":"string"==typeof c||c instanceof String?d:d.toString(),a&&b?h=e.open(a,b,"menubar=1,resizable=1,width="+f+",height="+g):a&&(h=e.open(a,"","menubar=1,resizable=1,width="+f+",height="+g)),h&&(j=parseInt(f,10),i=parseInt(g,10),h.moveTo(screen.width/2-j/2,screen.height/2-i/2)))},g.calendarLink=function(a,b,c){if(!a||!b||!c)return"";var d=b.title,e=b.start.replace(/[\-:]/g,""),f=b.end.replace(/[\-:]/g,""),g=b.body,h=b._links.self.href,i=c.name+" - "+c.street_address+" "+c.locality+", "+c.region+" "+c.postal_code,j="";switch(a){case"google":j="https://www.google.com/calendar/render?action=template&text="+d+"&dates="+e+"/"+f+"&details="+g+"&location="+i+"&pli=1&uid=&sf=true&output=xml";break;case"yahoo":j="https://calendar.yahoo.com/?v=60&TITLE="+d+"&ST="+e+"&in_loc="+i+"&in_st="+i+"&DESC="+g+"&URL="+h}return j},g.icalLink=function(a,b){if(!a||!b)return"";var c=(new Date).toJSON().toString().replace(/[\-.:]/g,""),d="http://nypl.org/"+a._links.self.href,f="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NYPL//NONSGML v1.0//EN\nMETHOD:PUBLISH\nBEGIN:VEVENT\nUID:"+(new Date).getTime()+"\nDTSTAMP:"+c+"\nATTENDEE;CN=My Self ;\nORGANIZER;CN=NYPL:\nDTSTART:"+a.start.replace(/[\-:]/g,"")+"\nDTEND:"+a.end.replace(/[\-:]/g,"")+"\nLOCATION:"+b+"\nDESCRIPTION:"+a.body+"\nURL;VALUE=URI:"+d+"\nSUMMARY:"+a.title+"\nEND:VEVENT\nEND:VCALENDAR",g="data:text/calendar;chartset=utf-8,"+encodeURI(f);return e.open(g),g},g.calcDistance=function(a,b){if(!a)return[];var c={latitude:b.latitude||b.lat,longitude:b.longitude||b["long"]};return _.each(a,function(a){var b,d,e=[];a.geolocation&&a.geolocation.coordinates&&(e=a.geolocation.coordinates),b=a.lat||e[1],d=a["long"]||e[0],a.distance=f.getDistance(c.latitude,c.longitude,b,d)}),a},g.checkDistance=function(a){var b=_.pluck(a,"distance");return _.min(b)>25?!0:!1},g.returnHTML=function(a){return c.trustAsHtml(a)},g.divisionHasAppointment=function(a,b){return _.contains(a,b)},g.researchLibraryOrder=function(a,b){return _.indexOf(a,b)},g.scrollToHash=function(){b.hash()&&d(function(){a()},900)},g.createHash=function(a){b.hash(a),this.scrollToHash()},g}a.$inject=["$rootScope"],b.$inject=["$anchorScroll","$location","$sce","$timeout","$window","nyplCoordinatesService"],angular.module("nypl_locations").factory("nyplUtility",b).factory("requestNotificationChannel",a),angular.module("nypl_widget").factory("nyplUtility",b).factory("requestNotificationChannel",a)}();