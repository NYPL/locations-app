/*!
 __                                            __    
/\ \                      __                  /\ \__
\ \ \        ___     ___ /\_\    ___      __  \ \ ,_\   ___   _ __
 \ \ \  __  / __`\  /'___\/\ \ /' _ `\  /'__`\ \ \ \/  / __`\/\`'__\
  \ \ \_\ \/\ \_\ \/\ \__/\ \ \/\ \/\ \/\ \_\.\_\ \ \_/\ \_\ \ \ \/ 
   \ \____/\ \____/\ \____\\ \_\ \_\ \_\ \__/.\_\\ \__\ \____/\ \_\ 
    \/___/  \/___/  \/____/ \/_/\/_/\/_/\/__/\/_/ \/__/\/___/  \/_/ 
*/
var nypl_locations=angular.module("nypl_locations",["ngSanitize","ui.router","ngAnimate","locationService","coordinateService","nyplFeedback","nyplSearch","nyplSSO","nyplNavigation","nyplBreadcrumbs","angulartics","angulartics.google.analytics","newrelic-timing"]);nypl_locations.constant("_",window._),nypl_locations.config(["$analyticsProvider","$locationProvider","$stateProvider","$urlRouterProvider","$crumbProvider",function(a,b,c,d,e){"use strict";function f(a,b,c){return c.singleLocation(a.location).then(function(a){return a.location})["catch"](function(a){throw a})}function g(a,b,c,d){var e=d.singleDivision(b.division),f=d.singleDivision(b.subdivision);return a.all([e,f]).then(function(a){var b=(a[0].division,a[1].division);return b})}function h(a,b,c){return c.singleDivision(a.division).then(function(a){return a.division})["catch"](function(a){throw a})}function i(a,b){return b.allDivisions().then(function(a){return a.divisions})["catch"](function(a){throw a})}function j(a,b,c){return c.amenities(a.amenity).then(function(a){return a})["catch"](function(a){throw a})}function k(a){return a.getConfig()}a.virtualPageviews(!1),b.html5Mode(!0),f.$inject=["$stateParams","config","nyplLocationsService"],g.$inject=["$q","$stateParams","config","nyplLocationsService"],h.$inject=["$stateParams","config","nyplLocationsService"],i.$inject=["config","nyplLocationsService"],j.$inject=["$stateParams","config","nyplLocationsService"],k.$inject=["nyplLocationsService"],e.setOptions({primaryState:{name:"Home",customUrl:"http://nypl.org"},secondaryState:{name:"Locations",customUrl:"home.index"}}),d.rule(function(a,b){var c=b.url();return"/"===c[c.length-1]?c.slice(0,-1):void 0}),d.otherwise("/404"),c.state("home",{url:"/","abstract":!0,templateUrl:"views/locations.html",controller:"LocationsCtrl",label:"Locations",resolve:{config:k}}).state("home.index",{templateUrl:"views/location-list-view.html",url:"",label:"Locations"}).state("home.list",{templateUrl:"views/location-list-view.html",url:"list",label:"Locations"}).state("home.map",{templateUrl:"views/location-map-view.html",url:"map",controller:"MapCtrl",label:"Locations"}).state("subdivision",{url:"/divisions/:division/:subdivision",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:k,division:g},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("division",{url:"/divisions/:division",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:k,division:h},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("research-collections",{url:"/research-collections",templateUrl:"views/research-collections.html",controller:"CollectionsCtrl",label:"Collections",resolve:{config:k,divisions:i}}).state("amenities",{url:"/amenities",templateUrl:"views/amenities.html",controller:"AmenitiesCtrl",label:"Amenities",resolve:{config:k,amenities:j},data:{crumbName:"Amenities"}}).state("amenity",{url:"/amenities/id/:amenity",templateUrl:"views/amenities.html",controller:"AmenityCtrl",label:"Amenities",resolve:{config:k,amenity:j},data:{parentState:"amenities",crumbName:"{{amenity.amenity.name}}"}}).state("amenities-at-location",{url:"/amenities/loc/:location",templateUrl:"views/amenitiesAtLibrary.html",controller:"AmenitiesAtLibraryCtrl",resolve:{config:k,location:f},data:{parentState:"amenities",crumbName:"{{location.name}}"}}).state("404",{url:"/404",templateUrl:"views/404.html"}).state("location",{url:"/:location",templateUrl:"views/location.html",controller:"LocationCtrl",resolve:{config:k,location:f},data:{crumbName:"{{location.name}}"}})}]),nypl_locations.run(["$analytics","$state","$rootScope","$location",function(a,b,c,d){c.$on("$stateChangeStart",function(){c.close_feedback=!0}),c.$on("$viewContentLoaded",function(){a.pageTrack("/locations"+d.path()),c.current_url=d.absUrl()}),c.$on("$stateChangeError",function(){b.go("404")})}]),nypl_locations.config(["$httpProvider",function(a){"use strict";var b,c=["$q","$injector","$location",function(a,c,d){function e(a){return b=b||c.get("$http"),b.pendingRequests.length<1&&(g=g||c.get("requestNotificationChannel"),g.requestEnded()),a}function f(e){var f=e.status;return b=b||c.get("$http"),b.pendingRequests.length<1&&(g=g||c.get("requestNotificationChannel"),g.requestEnded()),404===f?(d.path("/404"),a.reject(e)):a.reject(e)}var g;return function(a){return g=g||c.get("requestNotificationChannel"),g.requestStarted(),a.then(e,f)}}];a.responseInterceptors.push(c)}]);var nypl_widget=angular.module("nypl_widget",["ngSanitize","ui.router","locationService","coordinateService","angulartics","angulartics.google.analytics"]).config(["$locationProvider","$stateProvider","$urlRouterProvider",function(a,b){"use strict";function c(a,b,c){return c.singleLocation(a.location).then(function(a){return a.location})["catch"](function(a){throw a})}function d(a,b,c,d){var e=d.singleDivision(b.division),f=d.singleDivision(b.subdivision);return a.all([e,f]).then(function(a){var b=(a[0],a[1].division);return b})}function e(a,b,c){return c.singleDivision(a.division).then(function(a){return a.division})["catch"](function(a){throw a})}function f(a){return a.getConfig()}c.$inject=["$stateParams","config","nyplLocationsService"],d.$inject=["$q","$stateParams","config","nyplLocationsService"],e.$inject=["$stateParams","config","nyplLocationsService"],f.$inject=["nyplLocationsService"],a.html5Mode(!0),b.state("subdivision",{url:"/widget/divisions/:division/:subdivision",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:f,data:d}}).state("division",{url:"/widget/divisions/:division",templateUrl:"views/widget.html",controller:"WidgetCtrl",label:"Division",resolve:{config:f,data:e}}).state("widget",{url:"/widget/:location",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:f,data:c}})}]);nypl_widget.run(["$rootScope","nyplUtility",function(a,b){a.holiday=b.holidayClosings()}]),function(a,b,c){"use strict";function d(){var a={primaryState:{name:null,customUrl:null},secondaryState:{name:null,customUrl:null}};this.setOptions=function(c){b.extend(a,c)},this.$get=["$state","$stateParams",function(b,c){var d=function(a,d){var e,f;for(e=0,f=a.length;f>e;e+=1)if(a[e].name===d.name)return;d["abstract"]||d.customUrl&&(d.url=b.href(d.name,c||{}),a.unshift(d))};return{getConfigChain:function(){var b=[];return a.secondaryState&&d(b,a.secondaryState),a.primaryState&&d(b,a.primaryState),b}}}]}function e(a,d,e){return{restrict:"E",templateUrl:"scripts/components/nypl_breadcrumbs/nypl_breadcrumbs.html",scope:{crumbName:"@"},link:function(f){function g(a,c){var d,e=a.split("."),f=c;for(d=0;d<e.length;d+=1)b.isDefined(f[e[d]])&&(f=f[e[d]]);return f}function h(a){var b,c=a;return a["abstract"]===!0&&("undefined"!=typeof f.abstractProxyProperty?(b=g(f.abstractProxyProperty,a),c=b?d.get(b):!1):c=!1),c}function i(b){var c,d,e;return f.crumbName?(d=g(f.crumbName,b),c="undefined"!=typeof b.locals?b.locals.globals:b,d===!1?!1:"undefined"==typeof d?b.name:c?e=a(d)(c):void 0):b.name}function j(a){var b,d,e,f,g=a,h=g.data.parentState,i={},j="undefined"!=typeof a.locals?a.locals.globals:a;return"object"==typeof j&&h&&j.$stateParams?(d=n(a),b=m(j,h),e=l(j),f=k(j),d&&b&&(i={displayName:d,route:b}),e&&f&&(i.division={name:e,route:f}),i?i:c):c}function k(a){var b,d,e=a,f="division";return"object"==typeof e?(Object.keys(e).forEach(function(a){"$stateParams"!==a&&(d=e[a])}),d._embedded!==c&&d._embedded.parent&&d._embedded.parent.slug?(b=d._embedded.parent.slug,f+'({ "'+f+'":"'+b+'"})'):c):c}function l(a){var b,d,e=a;return"object"==typeof e?(Object.keys(e).forEach(function(a){"$stateParams"!==a&&(d=e[a])}),d._embedded!==c&&d._embedded.parent&&d._embedded.parent.name?b=d._embedded.parent.name:c):c}function m(a,b){var d,e,f=a,g=b;return"object"==typeof f&&g?(Object.keys(f).forEach(function(a){"$stateParams"!==a&&(e=f[a])}),e.amenity?e.amenity.id&&(d=e.amenity.id):e._embedded&&e._embedded.location&&e._embedded.location.slug&&(d=e._embedded.location.slug),d?g+'({ "'+g+'":"'+d+'"})':g):c}function n(b){var e,f,g=b.data.parentState,h=d.get(g),i="undefined"!=typeof b.locals?b.locals.globals:b;if(h){if(e=a(h.data.crumbName)(i))return e;if("object"==typeof i)return Object.keys(i).forEach(function(a){"$stateParams"!==a&&(f=i[a])}),f.amenity?f.amenity.name&&(e=f.amenity.name):f._embedded&&f._embedded.location&&f._embedded.location.name&&(e=f._embedded.location.name),e?e:g}return c}function o(a,b){var c,d=!1;for(c=0;c<b.length;c++)b[c].route===a.name&&(d=!0);return d}function p(){var a,b,c,g,k=[],l=d.$current,m=e.getConfigChain();if(m)for(a=0;a<m.length;a+=1)k.push({displayName:m[a].name,route:m[a].customUrl});for(g=j(l),g&&(g.displayName&&g.route&&k.push({displayName:g.displayName,route:g.route}),g.division&&k.push({displayName:g.division.name,route:g.division.route}));l&&""!==l.name;)b=h(l),b&&(c=i(b),c===!1||o(b,k)||k.push({displayName:c,route:b.name})),l.parent&&(l=l.parent);f.breadcrumbs=k}f.breadcrumbs=[],""!==d.$current.name&&p(),f.$on("$stateChangeSuccess",function(){p()})}}}e.$inject=["$interpolate","$state","$crumb"],b.module("nyplBreadcrumbs",[]).provider("$crumb",d).directive("nyplBreadcrumbs",e)}(window,window.angular),function(){"use strict";function a(a,b){var c=null,d={};return d.geolocationAvailable=function(){return b.navigator||b.navigator.geolocation?!0:!1},d.getBrowserCoordinates=function(){var d=a.defer();return this.geolocationAvailable()?b.navigator.geolocation.getCurrentPosition(function(a){c=a.coords,d.resolve(c)},function(a){switch(a.code){case a.PERMISSION_DENIED:d.reject(new Error("Permission denied."));break;case a.POSITION_UNAVAILABLE:d.reject(new Error("The position is currently unavailable."));break;case a.TIMEOUT:d.reject(new Error("The request timed out."));break;default:d.reject(new Error("Unknown error."))}},{enableHighAccuracy:!0,timeout:5e3,maximumAge:6e5}):d.reject(new Error("Your browser does not support Geolocation.")),d.promise},d.getDistance=function(a,b,c,d){if(!(a&&d&&c&&d))return void 0;var e,f=Math.PI*a/180,g=Math.PI*c/180,h=b-d,i=Math.PI*h/180;return e=Math.sin(f)*Math.sin(g)+Math.cos(f)*Math.cos(g)*Math.cos(i),e=Math.acos(e),e=180*e/Math.PI,e=60*e*1.1515,Math.ceil(100*e)/100},d}a.$inject=["$q","$window"],angular.module("coordinateService",[]).factory("nyplCoordinatesService",a)}(),function(){"use strict";function a(a,b){return{restrict:"E",templateUrl:"scripts/components/nypl_feedback/nypl_feedback.html",replace:!0,scope:{height:"@",width:"@",url:"@",side:"@"},link:function(c,d){var e="right";c.trusted_url=a.trustAsResourceUrl(c.url),c.feedback="Feedback","left"===c.side?(d.addClass("left"),e="left"):d.addClass("right"),b.$watch("close_feedback",function(a){a&&(b.close_feedback=!1,d.removeClass("open"),c.feedback="Feedback")}),d.find("a").click(function(){d.toggleClass("open"),c.feedback=d.hasClass("open")?"Close":"Feedback",c.$apply()})}}}a.$inject=["$sce","$rootScope"],angular.module("nyplFeedback",[]).directive("nyplFeedback",a)}(),function(){"use strict";function a(a,b){var c,d,e="?callback=JSON_CALLBACK",f="Could not reach API",g={};return g.getConfig=function(){var a=b.defer();return d?a.resolve(d):(d=window.locations_cfg.config,d?(c=d.api_root+"/"+d.api_version,a.resolve(d)):a.reject(f+": config")),a.promise},g.allLocations=function(){var d=b.defer();return a.jsonp(c+"/locations"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": locations")}),d.promise},g.singleLocation=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": location")}),g.promise},g.allDivisions=function(){var d=b.defer();return a.jsonp(c+"/divisions/?callback=JSON_CALLBACK",{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": division")}),d.promise},g.singleDivision=function(d){var g=b.defer();return a.jsonp(c+"/divisions/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": division")}),g.promise},g.amenities=function(d){var g=b.defer(),h=d?"/amenities/"+d:"/amenities";return a.jsonp(c+h+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": amenities")}),g.promise},g.amenitiesAtLibrary=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+"/amenities"+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": library-amenity")}),g.promise},g.alerts=function(){var d=b.defer();return a.jsonp(c+"/alerts"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": site-wide alerts")}),d.promise},g.terms=function(){var d=b.defer();return a.jsonp(c+"/terms?callback=JSON_CALLBACK",{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": terms")}),d.promise},g}a.$inject=["$http","$q"],angular.module("locationService",[]).factory("nyplLocationsService",a)}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_navigation.html",link:function(d){$(".dropDown").hover(function(){$(this).addClass("openDropDown")},function(){$(this).removeClass("openDropDown")}),c.$watch("current_url",function(){d.logout_url="https://nypl.bibliocommons.com/user/logout?destination="+c.current_url}),$(".mobile-login").click(function(c){c.preventDefault(),a.logged_in()?b.location.href=d.logout_url:$(".sso-login").toggleClass("visible")}),d.menuLabel="Log In",a.logged_in()&&(d.menuLabel="Log Out")}}}function b(){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_collapsed_buttons.html",link:function(a,b){var c=b.find(".nav-open-button"),d=b.find(".search-open-button");c.click(function(){return $(this).toggleClass("open"),d.removeClass("open"),$("#search-block-form-input").removeClass("open-search"),$(".search-options-resp").removeClass("open"),$("#search-top").removeClass("open"),$("#main-nav").toggleClass("open-navigation"),$(".sso-login").removeClass("visible"),!1}),d.click(function(){return $(this).toggleClass("open"),c.removeClass("open"),$("#search-block-form-input").toggleClass("open-search"),$("#search-top").toggleClass("open"),$("#main-nav").removeClass("open-navigation"),$(".sso-login").removeClass("visible"),!1})}}}a.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplNavigation",[]).directive("nyplNavigation",a).directive("nyplCollapsedButtons",b)}(),function(){"use strict";function a(a){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_search/nypl_search.html",link:function(b,c){function d(a){var b=a.closest("li");return b.hasClass("search-the-catalog")?l.term.attr("placeholder",l.prompt.catalog):b.hasClass("search-the-website")?l.term.attr("placeholder",l.prompt.site):l.term.attr("placeholder",l.prompt.default_val)}function e(){return $.trim(l.term.val())}function f(a){return void 0===a&&(a="Please enter a search term"),l.term.addClass("error").attr("placeholder",a)}function g(){return l.term.removeClass("error").attr("placeholder","")}function h(){return!l.mobile_flag.is(":visible")}function i(a){return void 0===a&&(a=l.choices.find("input[type=radio]:checked").parent()),$.trim(a.text()).toLowerCase()}function j(b){var c,d=e();return void 0===b&&(b=i()),0===d.length?(f(),a.eventTrack("Empty Search",{category:"Header Search",label:""}),!1):("nypl.org"===b?(c=window.location.protocol+"//nypl.org/search/apachesolr_search/"+d,a.eventTrack("Submit Search",{category:"Header Search",label:d})):(c="http://nypl.bibliocommons.com/search?t=smart&q="+d+"&commit=Search&searchOpt=catalogue",a.eventTrack("Submit Catalog Search",{category:"Header Search",label:d})),window.location=c,!1)}function k(){angular.element("html").click(function(){c.find(".pseudo-select").removeClass("open"),c.find(".error").removeClass("error")});var b=c;l.term=b.find("#search-block-form-input"),l.search_button=b.find(".search_button"),l.choices=b.find(".pseudo-select"),l.mobile_flag=b.find(".search-button"),l.prompt={default_val:l.term.attr("placeholder"),catalog:"Search the catalog",site:"Search NYPL.org"},b.click(function(a){a.stopPropagation()}),b.find("#search-block-form").submit(function(){return l.search_button.click(),!1}),l.term.focus(function(){l.choices.addClass("open"),a.eventTrack("Focused",{category:"Header Search",label:"Search Box"})}),l.term.focus(function(){g()}),b.find(".search-button").click(function(){return j()}),l.choices.find("li input").click(function(){d(angular.element(this)),a.eventTrack("Select",{category:"Header Search",label:i()})}),l.choices.find("li").click(function(){h()&&(0===e().length?f():j(i(angular.element(this))))})}var l={};k()}}}a.$inject=["$analytics"],angular.module("nyplSearch",["angulartics","angulartics.google.analytics"]).directive("nyplSearch",a)}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_sso/nypl_sso.html",link:function(d){function e(d,e,f,g){var h="";a.remembered()&&(d.val(a.remember()),f.attr("checked",!0)),f.click(function(){$(this).is(":checked")||a.forget()}),c.$watch("current_url",function(){h=c.current_url}),g.click(function(c){var g="https://nypl.bibliocommons.com/user/login?destination=";c.preventDefault(),f.is(":checked")&&a.remember(d.val()),g+=h.replace("#","%23")+"&",g+="name="+d.val(),g+="&user_pin="+e.val(),b.location.href=g})}function f(b){var c={username:"#username",pin:"#pin",remember_checkbox:"#remember_me",login_button:"#login-form-submit"},d=$.extend({},c,b);a.logged_in()&&h.addClass("logged-in"),e($(d.username),$(d.pin),$(d.remember_checkbox),$(d.login_button))}function g(){c.$watch("current_url",function(){d.logout_url="https://nypl.bibliocommons.com/user/logout?destination="+c.current_url}),d.header_button_label="LOG IN",a.logged_in()&&(d.header_button_label=a.login(),i.addClass("logged-in")),i.click(function(){h.toggleClass("visible")})}{var h=$(".sso-login"),i=$(".login-button"),j=$("#header-news_signup input[type=email]"),k=$("#header-news_signup input[type=submit]");$(".header-newsletter-signup")}j.focus(function(){$(".newsletter_policy").slideDown()}),j.blur(function(){$(".newsletter_policy").slideUp()}),k.click(function(){return""===j.val()?(j.focus(),!1):void 0}),f(),g()}}}function b(){var a={};return a.login=function(){return $.cookie("bc_username")},a.logged_in=function(){return!(!this.login()||null===this.login())},a.remember=function(a){return a?$.cookie("remember_me",a,{path:"/"}):$.cookie("remember_me")},a.remembered=function(){var a=this.remember();return!(!a||null===a)},a.forget=function(){return $.removeCookie("remember_me",{path:"/"})},a}a.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplSSO",[]).service("ssoStatus",b).directive("nyplSso",a)}(),function(){"use strict";function a(a,b,c,d,e){a.title="Amenities",b.amenitiesCategories=e.createAmenitiesCategories(c.amenities)}function b(a,b,c){var d=c.amenity,e=d.name;a.title=e,b.amenity=d,b.locations=d._embedded.locations,b.amenity_name=e}function c(a,b,c,d,e){var f=e.allAmenitiesArray(d._embedded.amenities);b.amenitiesCategories=e.createAmenitiesCategories(f),a.title=d.name,b.location=d}a.$inject=["$rootScope","$scope","amenities","config","nyplAmenities"],b.$inject=["$rootScope","$scope","amenity","config"],c.$inject=["$rootScope","$scope","config","location","nyplAmenities"],angular.module("nypl_locations").controller("AmenityCtrl",b).controller("AmenitiesCtrl",a).controller("AmenitiesAtLibraryCtrl",c)}(),function(){"use strict";function a(a,b,c,d,e,f,g){var h,i=g.getResearchValues(),j=c.research_order||["SASB","LPA","SC","SIBL"],k=function(a){_.each(a,function(a){a.hours&&(a.hoursToday=f.hoursToday(a.hours))})},l=function(){return e.terms().then(function(b){console.log(b.terms),a.terms=b.terms})},m=function(){return e.singleLocation("sibl").then(function(b){k([b.location]),h=b.location,h._embedded.location={id:"SIBL"},d.push(h),a.divisionLocations.push(h)})};a.active_filter="subjects",b.title="Research Collections",a.divisions=d,a.subterms=i.subterms,a.activeFilter=!1,a.filteredDivisions=i.filteredDivisions||d,a.divisionLocations=_.chain(d).pluck("_embedded").flatten().pluck("location").indexBy("id").sortBy(function(a){return f.researchLibraryOrder(j,a.id)}).flatten().value(),console.log(a.divisionLocations),m(),l(),a.setSubterms=function(b,c){var d;a.active_filter=c.name,g.setResearchValue("subterms",d),a.selected=b,a.activeFilter=!1,a.selectedSubterm=void 0},a.filterDivisionsBy=function(b,c){var d=c.id;subjectFilter,console.log(b),console.log(c),a.selectedSubterm=b,a.filteredDivisions=a.divisions.filter(function(a){var b;return a.terms?_.each(a.terms,function(a){b||(b=_.find(a.terms,function(a){return a.id===d}))}):a._embedded.location&&(b=a._embedded.location.id===d),!!b}),g.setResearchValue("filteredDivisions",a.filteredDivisions)},a.setLocations=function(b){if(a.activeFilter=a.activeFilter===!1?!0:!1,a.selected=void 0,a.selectedSubterm=void 0,!b)throw new Error("Could not determine filtered locations. Check API response");a.subterms=a.activeFilter===!0?b:void 0},k(a.divisions)}a.$inject=["$scope","$rootScope","config","divisions","nyplLocationsService","nyplUtility","researchCollectionService"],angular.module("nypl_locations").controller("CollectionsCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e){var f=c.divisions_with_appointments;b.division=d,b.location=d._embedded.location,a.title=d.name,b.calendarLink=e.calendarLink,b.icalLink=e.icalLink,d.hours&&(b.hoursToday=e.hoursToday(d.hours),d.hours.exceptions&&(d.hours.exceptions.description=e.returnHTML(d.hours.exceptions.description))),d._embedded.divisions&&_.each(d._embedded.divisions,function(a){a.hoursToday=e.hoursToday(a.hours)}),b.division.social_media=e.socialMediaColor(d.social_media),b.has_appointment=e.divisionHasAppointment(f,d.id)}a.$inject=["$rootScope","$scope","config","division","nyplUtility"],angular.module("nypl_locations").controller("DivisionCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k){var l,m=j.getSearchValues(),n=e.research_order||["SASB","LPA","SC","SIBL"],o={coords:{},address:""},p=function(a){b.predicate=a},q=function(a,b){_.each(a,function(a){a[b]=""})},r=function(){b.searchMarker=!1,b.researchBranches=!1,b.userMarker=!1,b.reverse=!1,b.searchTerm="",b.geolocationAddressOrSearchQuery="",b.select_library_for_map="",p("name"),q(b.locations,"distance"),q(b.locations,"highlight")},s=function(){f.geolocationAvailable()&&(b.geolocationOn=!0)},t=function(){return"home.map"===d.current.name},u=function(){return f.getBrowserCoordinates().then(function(a){return o.coords=_.pick(a,"latitude","longitude"),o})},v=function(a){if(b.locations=i.calcDistance(b.locations,a.coords),i.checkDistance(b.locations))throw r(),new Error("You are not within 25 miles of any NYPL library.");return a.coords},w=function(){b.locationStart=o.coords.latitude+","+o.coords.longitude,b.userMarker=!0,t()||d.go("home.map"),p("distance"),g.createMarker("user",o.coords,"Your Current Location"),b.drawUserMarker()},x=function(a){return j.resetSearchValues(),g.reverseGeocoding({lat:a.latitude,lng:a.longitude}).then(function(a){return b.geolocationAddressOrSearchQuery=a,j.setSearchValue("resultsNear",a).setSearchValue("locations",b.locations),a})},y=function(a){return j.setSearchValue("searchTerm",a),g.geocodeAddress(a).then(function(a){return{coords:a,searchTerm:a.name}})["catch"](function(a){throw a})},z=function(a){var c=b.locations,d=a.coords,e=a.searchTerm;if(c=i.calcDistance(c,d),i.checkDistance(c))throw b.searchError=e,g.panMap(),new Error("The search query is too far");return b.userMarker=!1,g.removeMarker("user"),j.setSearchValue("resultsNear",a.searchTerm),b.geolocationAddressOrSearchQuery=e,b.searchError="",c},A=function(a,c,d){q(a,"highlight"),_.each(c,function(a){a.highlight="active",a.distance=""}),a=_.sortBy(a,function(a){return a[d]}),a=_.difference(a,c),b.locations=_.union(c,a),j.setSearchValue("locations",b.locations),p("")},B=function(){var a=[angular.element(".locations-list-view tbody"),angular.element(".locations-data-wrapper")];_.each(a,function(a){$(a).animate({scrollTop:"0px"},1e3)})},C=function(a){b.location_type=a},D=function(){m.locations?(b.locations=m.locations,b.searchTerm=m.searchTerm,b.geolocationAddressOrSearchQuery=m.resultsNear,b.searchMarker=m.searchMarker,b.searchMarker&&g.drawSearchMarker(),p(b.geolocationAddressOrSearchQuery?"distance":"name")):b.loadLocations()};b.loadLocations=function(){return h.allLocations().then(function(a){var c=k.getAmenityConfig(e);return l=a.locations,b.locations=l,_.each(b.locations,function(a){var b=i.getAddressString(a,!0),d={};a.geolocation&&a.geolocation.coordinates&&(d={latitude:a.geolocation.coordinates[1],longitude:a.geolocation.coordinates[0]}),a.hoursToday=i.hoursToday,a.locationDest=i.getAddressString(a),a.amenities_list=k.getHighlightedAmenities(a._embedded.amenities,c.global,c.local),a.branchException=i.branchException(a.hours),a.research_order=i.researchLibraryOrder(n,a.id),!g.doesMarkerExist(a.slug)&&a.geolocation&&g.createMarker(a.slug,d,b)}),r(),j.setSearchValue("locations",b.locations),l})["catch"](function(a){throw d.go("404"),a})},b.scrollPage=function(){var a,b=angular.element(".container__all-locations"),d=parseInt(b.css("width"),10);601>d&&(a=angular.element(".map-search__results").offset()||angular.element(".search__results").offset(),c(function(){angular.element("body").animate({scrollTop:a.top},1e3)},1e3))},b.viewMapLibrary=function(a){var c=_.where(b.locations,{slug:a});b.select_library_for_map=a,b.searchMarker=!1,t()?g.hideSearchInfowindow().panExistingMarker(a):d.go("home.map"),A(b.locations,c,"name"),b.scrollPage()},b.useGeolocation=function(){g.removeMarker("search"),r(),b.scrollPage(),B(),u().then(v).then(x).then(w)["catch"](function(a){b.distanceError=a.message,b.geolocationOn=!1})},b.clearSearch=function(){j.resetSearchValues(),C(),g.showAllLibraries().removeMarker("user"),t()&&g.removeMarker("search").hideInfowindow().panMap(),r(),B()},b.drawUserMarker=function(){g.doesMarkerExist("user")&&g.panExistingMarker("user")},b.geocodeAddress=function(a){!a||a.length<3||(b.geolocationAddressOrSearchQuery="",b.searchError="",C(),b.researchBranches=!1,g.showAllLibraries(),b.searchTerm=a,a=j.searchWordFilter(a),B(),t()||d.go("home.map"),y(a).then(function(a){return g.createSearchMarker(a.coords,a.searchTerm),z(a)}).then(function(a){b.scrollPage(),b.searchMarker=!0,j.setSearchValue("searchMarker",!0),g.drawSearchMarker(),A(a,[],"distance")})["catch"](function(){g.removeMarker("search"),b.searchMarker=!1,j.resetSearchValues(),r()}))},b.showResearch=function(){g.hideInfowindow(),B(),b.researchBranches=!b.researchBranches,b.researchBranches?(g.showResearchLibraries().panMap(),C("research"),p("research_order")):(g.showAllLibraries().panMap(),C(),p("name"))},a.title="Locations",b.$state=d,D(),s()}function b(a,b,c){var d=function(){b(function(){a.locations&&(c.showAllLibraries(),a.researchBranches&&c.showResearchLibraries())},1200)},e=function(){b(function(){c.drawMap({lat:40.7532,"long":-73.9822},12,"all-locations-map").drawLegend("all-locations-map-legend"),a.locations&&c.showAllLibraries(),d(),a.drawUserMarker(),a.searchMarker&&c.drawSearchMarker(),a.researchBranches&&c.showResearchLibraries(),a.select_library_for_map&&c.panExistingMarker(a.select_library_for_map),a.scrollPage()},1200)};e(),a.panToLibrary=function(b){c.hideSearchInfowindow().panExistingMarker(b),a.scrollPage()}}function c(a,b,c,d,e,f,g,h){var i=e._embedded.amenities,j=h.getAmenityConfig(d),k=function(){return f.getBrowserCoordinates().then(function(a){var d=_.pick(a,"latitude","longitude");c(function(){b.locationStart=d.latitude+","+d.longitude})})};k(),b.location=e,a.title=e.name,e.hours.exceptions&&(e.hours.exceptions.description=g.returnHTML(e.hours.exceptions.description)),_.each(e._embedded.amenities,function(a){a.amenity=h.addAmenitiesIcon(a.amenity)}),e.amenities_list=h.getHighlightedAmenities(i,j.global,j.local),b.calendarLink=g.calendarLink,b.icalLink=g.icalLink,b.location.social_media=g.socialMediaColor(b.location.social_media),e.hours&&(b.hoursToday=g.hoursToday(e.hours)),e._embedded.exhibitions&&_.each(e._embedded.exhibitions,function(a){a.start&&a.end&&(a.prettyDate=g.formatDate(a.start,a.end))}),_.each(e._embedded.divisions,function(a){a.hoursToday=g.hoursToday(a.hours)}),_.each(e._embedded.features,function(a){a.body=g.returnHTML(a.body)}),b.locationDest=g.getAddressString(e),d.closed_img&&(b.location.images.closed=d.closed_img)}a.$inject=["$rootScope","$scope","$timeout","$state","config","nyplCoordinatesService","nyplGeocoderService","nyplLocationsService","nyplUtility","nyplSearch","nyplAmenities"],b.$inject=["$scope","$timeout","nyplGeocoderService"],c.$inject=["$rootScope","$scope","$timeout","config","location","nyplCoordinatesService","nyplUtility","nyplAmenities"],angular.module("nypl_locations").controller("LocationsCtrl",a).controller("MapCtrl",b).controller("LocationCtrl",c)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){b.title=g.name,c.data=g,c.locinator_url="http://www.nypl.org/locations"+a.path().substr(7),c.widget_name=g.name,g._embedded.location&&(c.division=!0,c.data.images.exterior=g.images.interior),f.closed_img&&(c.data.images.closed=f.closed_img),g.hours&&(c.hoursToday=i.hoursToday(g.hours)),c.data.social_media=i.socialMediaColor(c.data.social_media),c.locationDest=i.getAddressString(g)}a.$inject=["$location","$rootScope","$scope","$timeout","$window","config","data","nyplCoordinatesService","nyplUtility"],angular.module("nypl_widget").controller("WidgetCtrl",a)}(),function(){"use strict";function a(a){return{restrict:"A",link:function(b,c){var d=function(){c.addClass("show")},e=function(){c.removeClass("show")};c.hasClass("show")&&c.removeClass("show"),a.onRequestStarted(b,d),a.onRequestEnded(b,e)}}}function b(){return{restrict:"E",templateUrl:"scripts/directives/templates/todaysHours.html",replace:!0,scope:{hours:"@",holiday:"="}}}function c(){return{restrict:"E",templateUrl:"scripts/directives/templates/emailus.html",replace:!0,scope:{link:"@"}}}function d(a){return{restrict:"E",templateUrl:"scripts/directives/templates/librarianchat.html",replace:!0,link:function(b,c){b.openChat=function(){a.popupWindow("http://www.nypl.org/ask-librarian","NYPL Chat",210,450),c.hasClass("active")||c.addClass("active")}}}}function e(a){return function(b){b.$on("$stateChangeStart",function(){a.scrollTo(0,0)})}}function f(a){function b(a){var b=new Date(a),c=new Date;return b.getTime()>c.getTime()?!0:!1}return{restrict:"E",templateUrl:"scripts/directives/templates/registration.html",replace:!0,scope:{registration:"=",status:"=",link:"="},link:function(c){c.online=!1,c.registration&&(c.eventRegStarted=b(c.registration.start),"Online"==c.registration.type?(c.online=!0,c.reg_msg=c.eventRegStarted?"Online, opens "+a("date")(c.registration.start,"MM/dd"):"Online"):c.reg_msg=c.registration.type)}}}function g(a,b,c){return{restrict:"E",templateUrl:"scripts/directives/templates/alerts.html",replace:!0,link:function(d){var e;a(function(){b.alerts().then(function(a){e=a.alerts,d.sitewidealert=c.alerts(e)})},200)}}}function h(){function a(a,b){var c=new Date(a),d=new Date(b),e=new Date;return c.getTime()<=e.getTime()&&d.getTime()>=e.getTime()?!1:!0}return{restrict:"E",templateUrl:"scripts/directives/templates/library-alert.html",replace:!0,scope:{exception:"="},link:function(b){b.exception&&(b.alertExpired=a(b.exception.start,b.exception.end),""!==b.exception.description&&b.alertExpired===!1&&(b.libraryAlert=b.exception.description))}}}function i(){function a(a,b,c){var d=c.collapse,e=c.className||"open",f=c.duration||"fast";a.$eval(d)||b.hide(),a.$watch(d,function(a,c){a!==c&&(a?b.stop(!0,!0).slideDown(f).addClass(e):b.stop(!0,!0).slideUp(f).removeClass(e))})}return{link:a,restrict:"A"}}function j(a,b){return{restrict:"E",templateUrl:"scripts/directives/templates/fundraising.html",replace:!0,scope:{fundraising:"=fundraising",category:"@"},link:function(c){c.fundraising||a(function(){b.getConfig().then(function(a){var b=a.fundraising;
c.fundraising={appeal:b.appeal,statement:b.statement,button_label:b.button_label,link:b.link}})},200)}}}function k(){return{restrict:"E",templateUrl:"scripts/directives/templates/sidebar-widgets.html",replace:!0,scope:{donateButton:"@",nyplAsk:"@"},link:function(a,b,c){var d="https://secure3.convio.net/nypl/site/SPageServer?pagename=donation_form&JServSessionIdr003=dwcz55yj27.app304a&s_src=FRQ14ZZ_SWBN";a.donateUrl=c.donateurl||d}}}function l(a){return{restrict:"E",templateUrl:"scripts/directives/templates/footer.html",replace:!0,scope:{},link:function(b,c){var d,e=c.find(".footerlinks a");e.click(function(){d=angular.element(this).attr("href"),a.eventTrack("Click",{category:"footer",label:d})})}}}function m(a,b){return{restrict:"AEC",templateUrl:"scripts/directives/templates/autofill.html",scope:{data:"=",model:"=ngModel",mapView:"&",geoSearch:"&"},link:function(c,d,e,f){function g(){c.$watch("model",function(a){f.updateSearchText(c.data,a)}),c.$on("$stateChangeSuccess",function(){f.resetSearchTerms(),f.closeAutofill()})}c.focused=!1,c.activated=!1,c.geocodingactive=!1,c.filtered=[],c.items,c.active,c.currentIndex;var h=angular.element(document.getElementById("searchTerm")),i=angular.element(document.getElementsByTagName("html"));h.bind("focus",function(){c.$apply(function(){f.openAutofill()})}),h.bind("click",function(a){a.stopPropagation()}),h.bind("keyup",function(d){13===d.keyCode&&c.$apply(function(){c.activated?c.active.slug?(c.activated=!1,f.closeAutofill(),c.model=c.active.name,a.go("location",{location:c.active.slug})):(c.geoSearch({term:c.model}),c.geocodingactive=!1,c.activated=!1,h.blur()&&f.closeAutofill()):f.setSearchText(c.model)?(c.model=c.items[0].name,f.closeAutofill(),b.eventTrack("Accept",{category:"Locations",label:c.model}),a.go("location",{location:c.items[0].slug})):(c.geoSearch({term:c.model}),h.blur()&&f.closeAutofill())}),39===d.keyCode&&c.$apply(function(){f.setSearchText(c.model)}),8===d.keyCode&&c.$apply(function(){c.lookahead=""}),27===d.keyCode}),h.bind("keydown",function(a){(9===a.keyCode||13===a.keyCode||27===a.keyCode)&&a.preventDefault(),38===a.keyCode&&(a.preventDefault(),c.$apply(function(){c.activated?f.activatePreviousItem():f.activateFirstItem()})),40===a.keyCode&&(a.preventDefault(),c.$apply(function(){c.activated?f.activateNextItem():f.activateFirstItem(),f.activateGeocodingItem()}))}),i.bind("click",function(){c.$apply(function(){f.closeAutofill()})}),g()},controller:["$scope",function(a){a.lookahead="",a.currentWord="",a.completeWord="",this.closeAutofill=function(){return a.focused=!1},this.openAutofill=function(){return a.focused=!0},this.activate=function(a){return a},this.activateFirstItem=function(){a.active=a.filtered[0],a.currentIndex=a.filtered.indexOf(a.active),a.activated=!0},this.activateNextItem=function(){a.geocodingactive=!1,a.currentIndex<a.filtered.length&&a.currentIndex>=0?(a.currentIndex=a.filtered.indexOf(a.active)+1,a.active=this.activate(a.filtered[a.currentIndex])):(a.active=void 0,a.currentIndex=-1)},this.activatePreviousItem=function(){a.geocodingactive=!1,-1===a.currentIndex?(a.currentIndex=a.filtered.length-1,a.active=this.activate(a.filtered[a.currentIndex])):a.currentIndex<=a.filtered.length&&a.currentIndex>0&&(a.currentIndex=a.currentIndex-1,a.active=this.activate(a.filtered[a.currentIndex]))},this.activateGeocodingItem=function(){!a.active&&a.activated&&(a.active=this.activate(a.model),a.geocodingactive=!0)},this.setSearchText=function(){return a.completeWord!==a.model&&""!==a.completeWord&&""!==a.model?a.model=a.completeWord:void 0},this.resetSearchTerms=function(){a.lookahead="",a.currentWord=""},this.filterStartsWith=function(a,b){return _.filter(a,function(a){return a.name?a.name.substring(0,b.length).toLowerCase()===b.toLowerCase():!1})},this.filterTermWithin=function(a,b){return _.filter(a,function(a){return a.name?a.name.toLowerCase().indexOf(b.toLowerCase())>=0:!1})},this.updateSearchText=function(b,c){return""!==c&&c&&b&&c.length>1?(a.items=this.filterStartsWith(b,c),a.filtered=this.filterTermWithin(b,c),a.items[0]?(a.lookahead=a.items[0].name.substring(c.length),a.currentWord=c):this.resetSearchTerms(),a.completeWord=a.currentWord+a.lookahead):void 0}}]}}a.$inject=["requestNotificationChannel"],d.$inject=["nyplUtility"],e.$inject=["$window"],f.$inject=["$filter"],g.$inject=["$timeout","nyplLocationsService","nyplUtility"],h.$inject=["nyplUtility"],j.$inject=["$timeout","nyplLocationsService"],l.$inject=["$analytics"],m.$inject=["$state","$analytics"],angular.module("nypl_locations").directive("loadingWidget",a).directive("todayshours",b).directive("emailusbutton",c).directive("librarianchatbutton",d).directive("scrolltop",e).directive("eventRegistration",f).directive("nyplSiteAlerts",g).directive("nyplLibraryAlert",h).directive("nyplFundraising",j).directive("nyplSidebar",k).directive("nyplAutofill",m).directive("collapse",i).directive("nyplFooter",l),angular.module("nypl_widget").directive("todayshours",b).directive("nyplFundraising",j).directive("librarianchatbutton",d).directive("emailusbutton",c)}(),function(){"use strict";function a(){function a(a){var b=a.split(":"),c=(parseInt(b[0],10)+11)%12+1,d=b[1],e=b[0]>=12?"pm":"am";return c+":"+d+e}return function(b){var c=void 0!==b&&void 0!==b.today?b.today:b;return c?null===c.open?"Closed":a(c.open)+" - "+a(c.close):(console.log("timeFormat() filter function error: Argument is not defined or empty, verify API response for time"),"")}}function b(){return function(a){return new Date(a).toISOString()}}function c(){return function(a){return"string"==typeof a?a.replace(/(^|\s)([a-z])/g,function(a){return a.toUpperCase()}):a}}function d(){function a(a){return a=a.split(":"),_.object(["hours","mins","meridian","military"],[(parseInt(a[0],10)+11)%12+1,a[1],a[0]>=12?"pm":"am",a[0]])}return function(b,c){var d,e,f,g,h,i,j,k=new Date,l=k.getHours();if(b){if(g=b.today,h=b.tomorrow,g.open&&(d=a(g.open)),g.close&&(e=a(g.close)),!g.open||!g.close)return console.log("Returned object is undefined for open/closed elems"),"Closed today";if(null!==h.open&&(i=a(h.open)),null!==h.close&&(j=a(h.close)),l>=e.military)return i||j?"Open tomorrow "+i.hours+(0!==parseInt(i.mins,10)?":"+i.mins:"")+i.meridian+"-"+j.hours+(0!==parseInt(j.mins,10)?":"+j.mins:"")+j.meridian:"Closed today";switch(i&&l>=0&&l<i.military&&(c="long"),c){case"short":f="Open today until "+e.hours+(0!==parseInt(e.mins,10)?":"+e.mins:"")+e.meridian;break;case"long":f="Open today "+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian+"-"+e.hours+(0!==parseInt(e.mins,10)?":"+e.mins:"")+e.meridian;break;default:f=d.hours+":"+d.mins+d.meridian+"-"+e.hours+":"+e.mins+e.meridian}return f}return"Not available"}}function e(){return function(a,b,c){return"string"!=typeof a?a:a.length<200?a:(isNaN(b)&&(b=200),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c)}}angular.module("nypl_locations").filter("timeFormat",a).filter("dateToISO",b).filter("capitalize",c).filter("hoursTodayFormat",d).filter("truncate",e),angular.module("nypl_widget").filter("hoursTodayFormat",d)}(),function(){"use strict";function a(){var a={},b=function(a,b){return a instanceof Array?_.sortBy(a,function(a){return a.amenity?a.amenity[b]?a[b]:a.amenity[b]:void 0}):void 0};return a.addAmenitiesIcon=function(a){return a&&a.category?(a.icon=this.getCategoryIcon(a.category),a.icon=this.getAmenityIcon(a.id,a.icon),a):void 0},a.getCategoryIcon=function(a,b){var c=b||"";switch(a){case"Computer Services":c="icon-screen2";break;case"Circulation":c="icon-book";break;case"Printing and Copy Services":c="icon-copy";break;case"Facilities":c="icon-library";break;case"Assistive Technologies":c="icon-accessibility2"}return c},a.getAmenityIcon=function(a,b){var c=b||"";switch(a){case 7967:c="icon-connection";break;case 7965:c="icon-laptop";break;case 7966:c="icon-print";break;case 7968:c="icon-power-cord";break;case 7971:case 7972:c="icon-box-add"}return c},a.allAmenitiesArray=function(a){return a?_.chain(a).pluck("amenity").flatten(!0).value():void 0},a.getAmenityCategories=function(a){return a?_.chain(a).pluck("category").flatten(!0).unique().value():void 0},a.createAmenitiesCategories=function(a){var b,c,d=["Computer Services","Circulation","Printing and Copy Services","Facilities","Assistive Technologies"],e=[],f=this;if(a)return b=this.getAmenityCategories(a),_.each(b,function(b){c={},c.amenities=_.where(a,{category:b}),c.name=b,c.icon=f.getCategoryIcon(b),c.amenities.length&&(e[_.indexOf(d,b)]=c)}),e},a.getHighlightedAmenities=function(a,c,d){var e=a,f=[];if(a&&a.length&&c&&d)return e=b(e,"rank"),f=e.splice(0,c),e=b(e,"location_rank"),e=e.splice(0,d),f=_.union(f,e)},a.getAmenityConfig=function(a,b,c){var d={},e=b||3,f=c||2;return a&&a.featured_amenities?(d.global=a.featured_amenities.global||e,d.local=a.featured_amenities.local||f):(d.global=e,d.local=f),d},a}angular.module("nypl_locations").factory("nyplAmenities",a)}(),function(){"use strict";function a(a){var b,c,d=[],e=new google.maps.Marker({icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}),f=new google.maps.InfoWindow,g=new google.maps.InfoWindow,h={},i=function(a){return _.findWhere(d,{id:a})},j=function(a,c){h.hideInfowindow(),g.setContent(c),g.open(b,a)},k=function(a){var b=i(a);h.doesMarkerExist(a)&&b.marker.setMap(null)},l=function(a){var c=i(a);c&&c.marker.setMap(b)};return h.geocodeAddress=function(b){var c=a.defer(),d={},e=new google.maps.Geocoder,f=new google.maps.LatLng(40.49,-74.26),g=new google.maps.LatLng(40.91,-73.77),h=new google.maps.LatLngBounds(f,g),i={address:b,bounds:h,region:"US",componentRestrictions:{country:"US",locality:"New York"}};return e.geocode(i,function(a,b){b===google.maps.GeocoderStatus.OK?(d.lat=a[0].geometry.location.lat(),d["long"]=a[0].geometry.location.lng(),d.name=a[0].formatted_address,c.resolve(d)):c.reject(new Error(b))}),c.promise},h.reverseGeocoding=function(b){var c,d=a.defer(),e=new google.maps.Geocoder,f=new google.maps.LatLng(b.lat,b.lng);return e.geocode({latLng:f},function(a,b){b===google.maps.GeocoderStatus.OK?(c=a[0].formatted_address,d.resolve(c)):d.reject(new Error(b))}),d.promise},h.drawMap=function(a,c,d){var e=new google.maps.LatLng(a.lat,a["long"]),f={zoom:c,center:e,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,streetViewControl:!1};return b=new google.maps.Map(document.getElementById(d),f),this},h.drawLegend=function(a){var c=document.getElementById(a);return b.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(c),c.className="show-legend",this},h.panMap=function(a){var c,d,e=new google.maps.LatLng(40.7632,-73.9822);if(b)return a?(c=a.getPosition(),d=14):(c=e,d=12),b.panTo(c),b.setZoom(d),this},h.showResearchLibraries=function(){var a=["schwarzman","lpa","sibl","schomburg","user"];return _.each(d,function(b){_.contains(a,b.id)||k(b.id)}),this},h.showAllLibraries=function(){return d&&_.each(d,function(a){l(a.id)}),this},h.createMarker=function(a,b,c){var e,f=new google.maps.LatLng(b.latitude,b.longitude),g={position:f,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"};"user"===a&&(g.icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",g.zIndex=1e3,g.animation=google.maps.Animation.DROP),e=new google.maps.Marker(g),d.push({id:a,marker:e,text:c}),google.maps.event.addListener(e,"click",function(){j(e,c)})},h.hideInfowindow=function(){return g.close(),this},h.doesMarkerExist=function(a){return!!i(a)},h.createSearchMarker=function(a,b){var c=b.replace(","," <br>").replace(","," <br>"),d=new google.maps.LatLng(a.lat,a["long"]);e.setPosition(d),f.setContent(c)},h.drawSearchMarker=function(){return c||(e.setMap(b),this.panMap(e),f.open(b,e),this.hideInfowindow(),google.maps.event.addListener(e,"click",function(){f.open(b,e)})),this},h.hideSearchInfowindow=function(){return f.close(),this},h.removeMarker=function(a){return a?("search"===a?e.setMap(null):k(a),this):this},h.panExistingMarker=function(a){var b=i(a),c=b.marker;return(void 0===c.getMap()||null===c.getMap())&&l(a),this.panMap(c),j(b.marker,b.text),this},h}a.$inject=["$q"],angular.module("nypl_locations").factory("nyplGeocoderService",a)}(),function(){"use strict";function a(){var a={},b={};return a.setResearchValue=function(a,c){return b[a]=c,this},a.getResearchValues=function(){return b},a.resetResearchValues=function(){return b={},this},a}a.$inject=["$filter"],angular.module("nypl_locations").factory("researchCollectionService",a)}(),function(){"use strict";function a(a){var b={},c={};return b.setSearchValue=function(a,b){return c[a]=b,this},b.getSearchValues=function(){return c},b.resetSearchValues=function(){return c={},this},b.idLocationSearch=function(a,b){var c=[];if(a&&b)return b.length>=2&&b.length<=4&&(c=_.where(a,{id:b.toUpperCase()})),c},b.locationSearch=function(b,c){var d,e;if(b&&c&&!(c.length<3))return d=a("filter")(b,c),e=a("filter")(b,c,!0),d},b.searchWordFilter=function(a){var b=["branch"];if(a)return _.each(b,function(b){a=a.replace(b,"")}),a},b}a.$inject=["$filter"],angular.module("nypl_locations").factory("nyplSearch",a)}(),function(){"use strict";function a(a){var b="_START_REQUEST_",c="_END_REQUEST_",d={};return d.requestStarted=function(){a.$broadcast(b)},d.requestEnded=function(){a.$broadcast(c)},d.onRequestStarted=function(a,c){a.$on(b,function(a){c(a)})},d.onRequestEnded=function(a,b){a.$on(c,function(a){b(a)})},d}function b(a,b,c){var d={};return d.hoursToday=function(a){var b,c=new Date,d=c.getDay(),e=d+1;return a&&(b={today:{day:a.regular[d].day,open:a.regular[d].open,close:a.regular[d].close},tomorrow:{day:a.regular[e%7].day,open:a.regular[e%7].open,close:a.regular[e%7].close}}),b},d.formatDate=function(a,b){var c,d=["January","February","March","April","May","June","July","August","September","October","November","December"];if(this.numDaysFromToday=function(a,b){return Math.round((a.valueOf()-b.valueOf())/1e3/86400-.5)},a&&b){var e=new Date(a),f=new Date(b),g=new Date,h=this.numDaysFromToday(f,g);if(!h)return;c=365>=h?e.getTime()<=g.getTime()&&f.getTime()>=g.getTime()?"Now through "+d[f.getUTCMonth()]+" "+f.getUTCDate()+", "+f.getUTCFullYear():e.getTime()>g.getTime()&&f.getTime()>=g.getTime()?"Opening "+d[e.getUTCMonth()]+" "+e.getUTCDate()+", "+e.getUTCFullYear():d[e.getUTCMonth()]+" "+e.getUTCDate()+", "+e.getUTCFullYear()+" through "+d[f.getUTCMonth()]+" "+f.getUTCDate()+", "+f.getUTCFullYear():"Ongoing"}return c},d.branchException=function(a){var b={};if(a){if(!a.exceptions)return null;if(""!==a.exceptions.description.trim())return b.desc=a.exceptions.description,a.exceptions.start&&(b.start=a.exceptions.start),a.exceptions.end&&(b.end=a.exceptions.end),b}return null},d.getAddressString=function(a,b){if(!a)return"";var c=" ",d=a.name;return b&&(c="<br />",d="<a href='/locations/"+a.slug+"'>"+a.name+"</a>"),d+c+a.street_address+c+a.locality+", "+a.region+", "+a.postal_code},d.socialMediaColor=function(a){return _.each(a,function(a){switch(a.classes="icon-",a.site){case"facebook":a.classes+=a.site+" blueDarkerText";break;case"foursquare":a.classes+=a.site+" blueText";break;case"instagram":a.classes+=a.site+" blackText";break;case"twitter":a.classes+=a.site+"2 blueText";break;case"tumblr":a.classes+=a.site+"2 indigoText";break;case"youtube":case"pinterest":a.classes+=a.site+" redText";break;default:a.classes+=a.site}}),a},d.alerts=function(a){var b,c,d=new Date,e=[];return a&&Array.isArray(a)&&a.length>0&&(_.each(a,function(a){b=new Date(a.start),c=new Date(a.end),d>=b&&c>=d&&e.push(a.body)}),!angular.isUndefined(e))?_.uniq(e):null},d.holidayClosings=function(a){function b(a,b){return a.getFullYear()===b.getFullYear()&&a.getDate()===b.getDate()&&a.getMonth()===b.getMonth()}var c,d=a||new Date,e=[{day:new Date(2014,11,31),title:"The Library will close at 3 p.m. today"},{day:new Date(2015,0,1),title:"Closed for New Year's Day"},{day:new Date(2015,0,19),title:"Closed for Martin Luther King, Jr. Day"},{day:new Date(2015,1,16),title:"Closed for Presidents' Day"},{day:new Date(2015,3,5),title:"Closed for Easter"},{day:new Date(2015,4,23),title:"Closed for Memorial Day weekend"},{day:new Date(2015,4,24),title:"Closed for Memorial Day weekend"},{day:new Date(2015,4,25),title:"Closed for Memorial Day weekend"},{day:new Date(2015,6,4),title:"Closed for Independence Day"}];return c=_.filter(e,function(a){return b(a.day,d)?a:void 0}),c.length>0?{day:c[0].day,title:c[0].title}:void 0},d.popupWindow=function(a,c,d,e){var f,g,h,i,j;a&&(f=void 0===d?"300":"string"==typeof d||d instanceof String?d:d.toString(),g=void 0===e?"500":"string"==typeof d||d instanceof String?e:e.toString(),a&&c?h=b.open(a,c,"menubar=1,resizable=1,width="+f+",height="+g):a&&(h=b.open(a,"","menubar=1,resizable=1,width="+f+",height="+g)),h&&(j=parseInt(f,10),i=parseInt(g,10),h.moveTo(screen.width/2-j/2,screen.height/2-i/2)))},d.calendarLink=function(a,b,c){if(!a||!b||!c)return"";var d=b.title,e=b.start.replace(/[\-:]/g,""),f=b.end.replace(/[\-:]/g,""),g=b.body,h=b._links.self.href,i=c.name+" - "+c.street_address+" "+c.locality+", "+c.region+" "+c.postal_code,j="";switch(a){case"google":j="https://www.google.com/calendar/render?action=template&text="+d+"&dates="+e+"/"+f+"&details="+g+"&location="+i+"&pli=1&uid=&sf=true&output=xml";break;case"yahoo":j="https://calendar.yahoo.com/?v=60&TITLE="+d+"&ST="+e+"&in_loc="+i+"&in_st="+i+"&DESC="+g+"&URL="+h}return j},d.icalLink=function(a,c){if(!a||!c)return"";var d=(new Date).toJSON().toString().replace(/[\-.:]/g,""),e="http://nypl.org/"+a._links.self.href,f="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NYPL//NONSGML v1.0//EN\nMETHOD:PUBLISH\nBEGIN:VEVENT\nUID:"+(new Date).getTime()+"\nDTSTAMP:"+d+"\nATTENDEE;CN=My Self ;\nORGANIZER;CN=NYPL:\nDTSTART:"+a.start.replace(/[\-:]/g,"")+"\nDTEND:"+a.end.replace(/[\-:]/g,"")+"\nLOCATION:"+c+"\nDESCRIPTION:"+a.body+"\nURL;VALUE=URI:"+e+"\nSUMMARY:"+a.title+"\nEND:VEVENT\nEND:VCALENDAR",g="data:text/calendar;chartset=utf-8,"+encodeURI(f);return b.open(g),g},d.calcDistance=function(a,b){if(!a)return[];var d={latitude:b.latitude||b.lat,longitude:b.longitude||b["long"]};return _.each(a,function(a){var b,e,f=[];a.geolocation&&a.geolocation.coordinates&&(f=a.geolocation.coordinates),b=a.lat||f[1],e=a["long"]||f[0],a.distance=c.getDistance(d.latitude,d.longitude,b,e)}),a},d.checkDistance=function(a){var b=_.pluck(a,"distance");return _.min(b)>25?!0:!1},d.returnHTML=function(b){return a.trustAsHtml(b)},d.divisionHasAppointment=function(a,b){return _.contains(a,b)},d.researchLibraryOrder=function(a,b){return _.indexOf(a,b)},d}a.$inject=["$rootScope"],b.$inject=["$sce","$window","nyplCoordinatesService"],angular.module("nypl_locations").factory("nyplUtility",b).factory("requestNotificationChannel",a),angular.module("nypl_widget").factory("nyplUtility",b).factory("requestNotificationChannel",a)}();