/*!
 __                                            __    
/\ \                      __                  /\ \__
\ \ \        ___     ___ /\_\    ___      __  \ \ ,_\   ___   _ __
 \ \ \  __  / __`\  /'___\/\ \ /' _ `\  /'__`\ \ \ \/  / __`\/\`'__\
  \ \ \_\ \/\ \_\ \/\ \__/\ \ \/\ \/\ \/\ \_\.\_\ \ \_/\ \_\ \ \ \/ 
   \ \____/\ \____/\ \____\\ \_\ \_\ \_\ \__/.\_\\ \__\ \____/\ \_\ 
    \/___/  \/___/  \/____/ \/_/\/_/\/_/\/__/\/_/ \/__/\/___/  \/_/ 
*/
var nypl_locations=angular.module("nypl_locations",["ngSanitize","ui.router","ngAnimate","locationService","coordinateService","nyplFeedback","nyplSearch","nyplSSO","nyplNavigation","nyplBreadcrumbs","angulartics","angulartics.google.analytics","pascalprecht.translate"]);nypl_locations.constant("_",window._),nypl_locations.config(["$locationProvider","$translateProvider","$stateProvider","$urlRouterProvider","$crumbProvider",function($locationProvider,$translateProvider,$stateProvider,$urlRouterProvider,$crumbProvider){"use strict";function LoadLocation($stateParams,config,nyplLocationsService){return nyplLocationsService.singleLocation($stateParams.location).then(function(data){return data.location}).catch(function(err){throw err})}function LoadSubDivision($q,$stateParams,config,nyplLocationsService){var division=nyplLocationsService.singleDivision($stateParams.division),subdivision=nyplLocationsService.singleDivision($stateParams.subdivision);return $q.all([division,subdivision]).then(function(data){var subdiv=(data[0],data[1].division);return subdiv})}function LoadDivision($stateParams,config,nyplLocationsService){return nyplLocationsService.singleDivision($stateParams.division).then(function(data){return data.division}).catch(function(err){throw err})}function Amenities($stateParams,config,nyplLocationsService){return nyplLocationsService.amenities($stateParams.amenity).then(function(data){return data}).catch(function(error){throw error})}function getConfig(nyplLocationsService){return nyplLocationsService.getConfig()}$locationProvider.html5Mode(!0),$translateProvider.useStaticFilesLoader({prefix:"/languages/",suffix:".json"}),$translateProvider.preferredLanguage("en"),LoadLocation.$inject=["$stateParams","config","nyplLocationsService"],LoadSubDivision.$inject=["$q","$stateParams","config","nyplLocationsService"],LoadDivision.$inject=["$stateParams","config","nyplLocationsService"],Amenities.$inject=["$stateParams","config","nyplLocationsService"],getConfig.$inject=["nyplLocationsService"],$crumbProvider.setOptions({primaryState:{name:"Home",customUrl:"http://nypl.org"},secondaryState:{name:"Locations",customUrl:"home.index"}}),$urlRouterProvider.rule(function($injector,$location){var path=$location.url();return"/"===path[path.length-1]?path.slice(0,-1):void 0}),$stateProvider.state("home",{url:"/","abstract":!0,templateUrl:"views/locations.html",controller:"LocationsCtrl",label:"Locations",resolve:{config:getConfig}}).state("home.index",{templateUrl:"views/location-list-view.html",url:"",label:"Locations"}).state("home.list",{templateUrl:"views/location-list-view.html",url:"list",label:"Locations"}).state("home.map",{templateUrl:"views/location-map-view.html",url:"map",controller:"MapCtrl",label:"Locations"}).state("subdivision",{url:"/divisions/:division/:subdivision",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:getConfig,division:LoadSubDivision},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("division",{url:"/divisions/:division",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:getConfig,division:LoadDivision},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("amenities",{url:"/amenities",templateUrl:"/views/amenities.html",controller:"AmenitiesCtrl",label:"Amenities",resolve:{config:getConfig,amenities:Amenities},data:{crumbName:"Amenities"}}).state("amenity",{url:"/amenities/id/:amenity",templateUrl:"views/amenities.html",controller:"AmenityCtrl",label:"Amenities",resolve:{config:getConfig,amenity:Amenities},data:{parentState:"amenities",crumbName:"{{amenity.amenity.name}}"}}).state("amenities-at-location",{url:"/amenities/loc/:location",templateUrl:"views/amenitiesAtLibrary.html",controller:"AmenitiesAtLibraryCtrl",resolve:{config:getConfig,location:LoadLocation},data:{parentState:"amenities",crumbName:"{{location.name}}"}}).state("404",{url:"/404",templateUrl:"views/404.html"}).state("location",{url:"/:location",templateUrl:"views/location.html",controller:"LocationCtrl",resolve:{config:getConfig,location:LoadLocation},data:{crumbName:"{{location.name}}"}})}]),nypl_locations.run(["$state","$rootScope","$location",function($state,$rootScope,$location){$rootScope.$on("$stateChangeStart",function(){$rootScope.close_feedback=!0}),$rootScope.$on("$stateChangeSuccess",function(){$rootScope.current_url=$location.absUrl()}),$rootScope.$on("$stateChangeError",function(){$state.go("404")})}]),nypl_locations.config(["$httpProvider",function($httpProvider){"use strict";var $http,interceptor=["$q","$injector","$location",function($q,$injector,$location){function success(response){return $http=$http||$injector.get("$http"),$http.pendingRequests.length<1&&(notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestEnded()),response}function error(response){var status=response.status;return $http=$http||$injector.get("$http"),$http.pendingRequests.length<1&&(notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestEnded()),404===status?($location.path("/404"),$q.reject(response)):$q.reject(response)}var notificationChannel;return function(promise){return notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestStarted(),promise.then(success,error)}}];$httpProvider.responseInterceptors.push(interceptor)}]),angular.module("nypl_widget",["ngSanitize","ui.router","locationService","coordinateService","angulartics","angulartics.google.analytics"]).config(["$locationProvider","$stateProvider","$urlRouterProvider",function($locationProvider,$stateProvider){"use strict";function LoadLocation($stateParams,config,nyplLocationsService){return nyplLocationsService.singleLocation($stateParams.location).then(function(data){return data.location}).catch(function(err){throw err})}function LoadSubDivision($q,$stateParams,config,nyplLocationsService){var division=nyplLocationsService.singleDivision($stateParams.division),subdivision=nyplLocationsService.singleDivision($stateParams.subdivision);return $q.all([division,subdivision]).then(function(data){var subdiv=(data[0],data[1].division);return subdiv})}function LoadDivision($stateParams,config,nyplLocationsService){return nyplLocationsService.singleDivision($stateParams.division).then(function(data){return data.division}).catch(function(err){throw err})}function getConfig(nyplLocationsService){return nyplLocationsService.getConfig()}LoadLocation.$inject=["$stateParams","config","nyplLocationsService"],LoadSubDivision.$inject=["$q","$stateParams","config","nyplLocationsService"],LoadDivision.$inject=["$stateParams","config","nyplLocationsService"],getConfig.$inject=["nyplLocationsService"],$locationProvider.html5Mode(!0),$stateProvider.state("subdivision",{url:"/widget/divisions/:division/:subdivision",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:getConfig,data:LoadSubDivision}}).state("division",{url:"/widget/divisions/:division",templateUrl:"views/widget.html",controller:"WidgetCtrl",label:"Division",resolve:{config:getConfig,data:LoadDivision}}).state("widget",{url:"/widget/:location",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:getConfig,data:LoadLocation}})}]),function(window,angular,undefined){"use strict";function $Crumb(){var options={primaryState:{name:null,customUrl:null},secondaryState:{name:null,customUrl:null}};this.setOptions=function(opts){angular.extend(options,opts)},this.$get=["$state","$stateParams",function($state,$stateParams){var addStateToChain=function(chain,state){var i,len;for(i=0,len=chain.length;len>i;i+=1)if(chain[i].name===state.name)return;state.abstract||state.customUrl&&(state.url=$state.href(state.name,$stateParams||{}),chain.unshift(state))};return{getConfigChain:function(){var chain=[];return options.secondaryState&&addStateToChain(chain,options.secondaryState),options.primaryState&&addStateToChain(chain,options.primaryState),chain}}}]}function nyplBreadcrumbs($interpolate,$state,$crumb){return{restrict:"E",templateUrl:"scripts/components/nypl_breadcrumbs/nypl_breadcrumbs.html",scope:{crumbName:"@"},link:function(scope){function getObjectValue(objectPath,context){var i,propertyArray=objectPath.split("."),propertyReference=context;for(i=0;i<propertyArray.length;i+=1)angular.isDefined(propertyReference[propertyArray[i]])&&(propertyReference=propertyReference[propertyArray[i]]);return propertyReference}function getWorkingState(currentState){var proxyStateName,workingState=currentState;return currentState.abstract===!0&&("undefined"!=typeof scope.abstractProxyProperty?(proxyStateName=getObjectValue(scope.abstractProxyProperty,currentState),workingState=proxyStateName?$state.get(proxyStateName):!1):workingState=!1),workingState}function getCrumbName(currentState){var interpolationContext,propertyReference,displayName;return scope.crumbName?(propertyReference=getObjectValue(scope.crumbName,currentState),interpolationContext="undefined"!=typeof currentState.locals?currentState.locals.globals:currentState,propertyReference===!1?!1:"undefined"==typeof propertyReference?currentState.name:interpolationContext?displayName=$interpolate(propertyReference)(interpolationContext):void 0):currentState.name}function getParentState(currentState){var parentStateRoute,parentStateName,parentDivisionName,parentDivisionRoute,currState=currentState,parentStateSetting=currState.data.parentState,parentStateObj={},context="undefined"!=typeof currentState.locals?currentState.locals.globals:currentState;return"object"==typeof context&&parentStateSetting&&context.$stateParams?(parentStateName=getParentName(currentState),parentStateRoute=getParentRoute(context,parentStateSetting),parentDivisionName=getParentDivisionName(context),parentDivisionRoute=getParentDivisionRoute(context),parentStateName&&parentStateRoute&&(parentStateObj={displayName:parentStateName,route:parentStateRoute}),parentDivisionName&&parentDivisionRoute&&(parentStateObj.division={name:parentDivisionName,route:parentDivisionRoute}),parentStateObj?parentStateObj:undefined):undefined}function getParentDivisionRoute(context){var parentRoute,parentData,currentContext=context,divisionState="division";return"object"==typeof currentContext?(Object.keys(currentContext).forEach(function(key){"$stateParams"!==key&&(parentData=currentContext[key])}),parentData._embedded!==undefined&&parentData._embedded.parent&&parentData._embedded.parent.slug?(parentRoute=parentData._embedded.parent.slug,divisionState+'({ "'+divisionState+'":"'+parentRoute+'"})'):undefined):undefined}function getParentDivisionName(context){var parentName,parentData,currentContext=context;return"object"==typeof currentContext?(Object.keys(currentContext).forEach(function(key){"$stateParams"!==key&&(parentData=currentContext[key])}),parentData._embedded!==undefined&&parentData._embedded.parent&&parentData._embedded.parent.name?parentName=parentData._embedded.parent.name:undefined):undefined}function getParentRoute(context,parentStateSetting){var parentRoute,parentData,currentContext=context,stateSetting=parentStateSetting;return"object"==typeof currentContext&&stateSetting?(Object.keys(currentContext).forEach(function(key){"$stateParams"!==key&&(parentData=currentContext[key])}),parentData.amenity?parentData.amenity.id&&(parentRoute=parentData.amenity.id):parentData._embedded&&parentData._embedded.location&&parentData._embedded.location.slug&&(parentRoute=parentData._embedded.location.slug),parentRoute?stateSetting+'({ "'+stateSetting+'":"'+parentRoute+'"})':stateSetting):undefined}function getParentName(currentState){var parentStateName,parentData,parentStateSetting=currentState.data.parentState,parentStateData=$state.get(parentStateSetting),context="undefined"!=typeof currentState.locals?currentState.locals.globals:currentState;if(parentStateData){if(parentStateName=$interpolate(parentStateData.data.crumbName)(context))return parentStateName;if("object"==typeof context)return Object.keys(context).forEach(function(key){"$stateParams"!==key&&(parentData=context[key])}),parentData.amenity?parentData.amenity.name&&(parentStateName=parentData.amenity.name):parentData._embedded&&parentData._embedded.location&&parentData._embedded.location.name&&(parentStateName=parentData._embedded.location.name),parentStateName?parentStateName:parentStateSetting}return undefined}function stateAlreadyInBreadcrumbs(state,breadcrumbs){var i,alreadyUsed=!1;for(i=0;i<breadcrumbs.length;i++)breadcrumbs[i].route===state.name&&(alreadyUsed=!0);return alreadyUsed}function initCrumbs(){var i,workingState,displayName,parentState,breadcrumbs=[],currentState=$state.$current,configStates=$crumb.getConfigChain();if(configStates)for(i=0;i<configStates.length;i+=1)breadcrumbs.push({displayName:configStates[i].name,route:configStates[i].customUrl});for(parentState=getParentState(currentState),parentState&&(parentState.displayName&&parentState.route&&breadcrumbs.push({displayName:parentState.displayName,route:parentState.route}),parentState.division&&breadcrumbs.push({displayName:parentState.division.name,route:parentState.division.route}));currentState&&""!==currentState.name;)workingState=getWorkingState(currentState),workingState&&(displayName=getCrumbName(workingState),displayName===!1||stateAlreadyInBreadcrumbs(workingState,breadcrumbs)||breadcrumbs.push({displayName:displayName,route:workingState.name})),currentState.parent&&(currentState=currentState.parent);scope.breadcrumbs=breadcrumbs}scope.breadcrumbs=[],""!==$state.$current.name&&initCrumbs(),scope.$on("$stateChangeSuccess",function(){initCrumbs()})}}}nyplBreadcrumbs.$inject=["$interpolate","$state","$crumb"],angular.module("nyplBreadcrumbs",[]).provider("$crumb",$Crumb).directive("nyplBreadcrumbs",nyplBreadcrumbs)}(window,window.angular),function(){"use strict";function nyplCoordinatesService($q,$window){var geoCoords=null,coordinatesService={};return coordinatesService.geolocationAvailable=function(){return $window.navigator||$window.navigator.geolocation?!0:!1},coordinatesService.getBrowserCoordinates=function(){var defer=$q.defer();return this.geolocationAvailable()?$window.navigator.geolocation.getCurrentPosition(function(position){geoCoords=position.coords,defer.resolve(geoCoords)},function(error){switch(error.code){case error.PERMISSION_DENIED:defer.reject(new Error("Permission denied."));break;case error.POSITION_UNAVAILABLE:defer.reject(new Error("The position is currently unavailable."));break;case error.TIMEOUT:defer.reject(new Error("The request timed out."));break;default:defer.reject(new Error("Unknown error."))}},{enableHighAccuracy:!0,timeout:5e3,maximumAge:6e5}):defer.reject(new Error("Your browser does not support Geolocation.")),defer.promise},coordinatesService.getDistance=function(lat1,lon1,lat2,lon2){if(!(lat1&&lon2&&lat2&&lon2))return void 0;var distance,radlat1=Math.PI*lat1/180,radlat2=Math.PI*lat2/180,theta=lon1-lon2,radtheta=Math.PI*theta/180;return distance=Math.sin(radlat1)*Math.sin(radlat2)+Math.cos(radlat1)*Math.cos(radlat2)*Math.cos(radtheta),distance=Math.acos(distance),distance=180*distance/Math.PI,distance=60*distance*1.1515,Math.ceil(100*distance)/100},coordinatesService}nyplCoordinatesService.$inject=["$q","$window"],angular.module("coordinateService",[]).factory("nyplCoordinatesService",nyplCoordinatesService)}(),function(){"use strict";function nyplFeedback($sce,$rootScope){return{restrict:"E",templateUrl:"scripts/components/nypl_feedback/nypl_feedback.html",replace:!0,scope:{height:"@",width:"@",url:"@",side:"@"},link:function(scope,element){var arrow_direction="right";scope.trusted_url=$sce.trustAsResourceUrl(scope.url),scope.feedback="Feedback","left"===scope.side?(element.addClass("left"),arrow_direction="left"):element.addClass("right"),$rootScope.$watch("close_feedback",function(newVal){newVal&&($rootScope.close_feedback=!1,element.removeClass("open"),scope.feedback="Feedback")}),element.find("a").click(function(){element.toggleClass("open"),scope.feedback=element.hasClass("open")?"Close":"Feedback",scope.$apply()})}}}nyplFeedback.$inject=["$sce","$rootScope"],angular.module("nyplFeedback",[]).directive("nyplFeedback",nyplFeedback)}(),function(){"use strict";function nyplLocationsService($http,$q){var api,config,apiError="Could not reach API",locationsApi={};return locationsApi.getConfig=function(){var defer=$q.defer();return config?defer.resolve(config):$http.get("/config",{cache:!0}).success(function(data){api=data.config.api_root,config=data.config,defer.resolve(config)}).error(function(){defer.reject(apiError+": config")}),defer.promise},locationsApi.allLocations=function(){var defer=$q.defer();return $http.jsonp(api+"/locations?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": locations")}),defer.promise},locationsApi.singleLocation=function(location){var defer=$q.defer();return $http.jsonp(api+"/locations/"+location+"?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": location")}),defer.promise},locationsApi.singleDivision=function(division){var defer=$q.defer();return $http.jsonp(api+"/divisions/"+division+"?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": division")}),defer.promise},locationsApi.amenities=function(amenity){var defer=$q.defer(),url=amenity?"/amenities/"+amenity:"/amenities";return $http.jsonp(api+url+"?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": amenities")}),defer.promise},locationsApi.amenitiesAtLibrary=function(location){var defer=$q.defer();return $http.jsonp(api+"/locations/"+location+"/amenities?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": library-amenity")}),defer.promise},locationsApi.alerts=function(){var defer=$q.defer();return $http.jsonp(api+"/alerts?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": site-wide alerts")}),defer.promise},locationsApi}nyplLocationsService.$inject=["$http","$q"],angular.module("locationService",[]).factory("nyplLocationsService",nyplLocationsService)}(),function(){"use strict";function nyplNavigation(ssoStatus,$window,$rootScope){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_navigation.html",link:function(scope){$(".dropDown").hover(function(){$(this).addClass("openDropDown")},function(){$(this).removeClass("openDropDown")});var logout_url;$rootScope.$watch("current_url",function(){logout_url="https://nypl.bibliocommons.com/user/logout?destination="+$rootScope.current_url}),$(".mobile-login").click(function(e){e.preventDefault(),ssoStatus.logged_in()?$window.location.href=logout_url:$(".sso-login").toggleClass("visible")}),scope.menuLabel="Log In",ssoStatus.logged_in()&&(scope.menuLabel="Log Out")}}}function nyplCollapsedButtons(){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_collapsed_buttons.html",link:function(scope,element){var navBtn=element.find(".nav-open-button"),searchBtn=element.find(".search-open-button");navBtn.click(function(){return $(this).toggleClass("open"),searchBtn.removeClass("open"),$("#search-block-form-input").removeClass("open-search"),$(".search-options-resp").removeClass("open"),$("#search-top").removeClass("open"),$("#main-nav").toggleClass("open-navigation"),$(".sso-login").removeClass("visible"),!1}),searchBtn.click(function(){return $(this).toggleClass("open"),navBtn.removeClass("open"),$("#search-block-form-input").toggleClass("open-search"),$("#search-top").toggleClass("open"),$("#main-nav").removeClass("open-navigation"),$(".sso-login").removeClass("visible"),!1})}}}nyplNavigation.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplNavigation",[]).directive("nyplNavigation",nyplNavigation).directive("nyplCollapsedButtons",nyplCollapsedButtons)}(),function(){"use strict";function nyplSearch(){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_search/nypl_search.html",link:function(scope,element){function setPrompt(lmnt){var item=lmnt.closest("li");return item.hasClass("search-the-catalog")?o.term.attr("placeholder",o.prompt.catalog):item.hasClass("search-the-website")?o.term.attr("placeholder",o.prompt.site):o.term.attr("placeholder",o.prompt.default_val)}function searchTerm(){return $.trim(o.term.val())}function setError(err){return void 0===err&&(err="Please enter a search term"),o.term.addClass("error").attr("placeholder",err)}function clearError(){return o.term.removeClass("error").attr("placeholder","")}function isMobile(){return!o.mobile_flag.is(":visible")}function getChoice(choice){return void 0===choice&&(choice=o.choices.find("input[type=radio]:checked").parent()),$.trim(choice.text()).toLowerCase()}function doSearch(scope){var target,term=searchTerm();return void 0===scope&&(scope=getChoice()),0===term.length?(setError(),!1):(target="nypl.org"===scope?window.location.protocol+"//nypl.org/search/apachesolr_search/"+term:"http://nypl.bibliocommons.com/search?t=smart&q="+term+"&commit=Search&searchOpt=catalogue",window.location=target,!1)}function init(){angular.element("html").click(function(){element.find(".pseudo-select").removeClass("open"),element.find(".error").removeClass("error")});var lmnt=element;o.term=lmnt.find("#search-block-form-input"),o.search_button=lmnt.find(".search_button"),o.choices=lmnt.find(".pseudo-select"),o.mobile_flag=lmnt.find(".search-button"),o.prompt={default_val:o.term.attr("placeholder"),catalog:"Search the catalog",site:"Search NYPL.org"},lmnt.click(function(e){e.stopPropagation()}),lmnt.find("#search-block-form").submit(function(){return o.search_button.click(),!1}),o.term.focus(function(){o.choices.addClass("open")}),o.term.focus(function(){clearError()}),lmnt.find(".search-button").click(function(){return doSearch()}),o.choices.find("li input").click(function(){setPrompt(angular.element(this))}),o.choices.find("li").click(function(){isMobile()&&(0===searchTerm().length?setError():doSearch(getChoice(angular.element(this))))})}var o={};init()}}}angular.module("nyplSearch",[]).directive("nyplSearch",nyplSearch)}(),function(){"use strict";function nyplSSO(ssoStatus,$window,$rootScope){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_sso/nypl_sso.html",link:function(scope){function makeForm(username,pin,checkbox,button){var current_url="";ssoStatus.remembered()&&(username.val(ssoStatus.remember()),checkbox.attr("checked",!0)),checkbox.click(function(){$(this).is(":checked")||ssoStatus.forget()}),$rootScope.$watch("current_url",function(){current_url=$rootScope.current_url}),button.click(function(e){var url="https://nypl.bibliocommons.com/user/login?destination=";e.preventDefault(),checkbox.is(":checked")&&ssoStatus.remember(username.val()),url+=current_url.replace("#","%23")+"&",url+="name="+username.val(),url+="&user_pin="+pin.val(),$window.location.href=url})}function initForm(options){var defaults={username:"#username",pin:"#pin",remember_checkbox:"#remember_me",login_button:"#login-form-submit"},settings=$.extend({},defaults,options);ssoStatus.logged_in()&&ssoLoginElement.addClass("logged-in"),makeForm($(settings.username),$(settings.pin),$(settings.remember_checkbox),$(settings.login_button))}function userButton(){$rootScope.$watch("current_url",function(){scope.logout_url="https://nypl.bibliocommons.com/user/logout?destination="+$rootScope.current_url}),scope.header_button_label="LOG IN",ssoStatus.logged_in()&&(scope.header_button_label=ssoStatus.login(),ssoUserButton.addClass("logged-in")),ssoUserButton.click(function(){ssoLoginElement.toggleClass("visible")})}var ssoLoginElement=$(".sso-login"),ssoUserButton=$(".login-button");initForm(),userButton()}}}function ssoStatus(){var ssoStatus={};return ssoStatus.login=function(){return $.cookie("bc_username")},ssoStatus.logged_in=function(){return!(!this.login()||null===this.login())},ssoStatus.remember=function(name){return name?$.cookie("remember_me",name,{path:"/"}):$.cookie("remember_me")},ssoStatus.remembered=function(){var remember_me=this.remember();return!(!remember_me||null===remember_me)},ssoStatus.forget=function(){return $.removeCookie("remember_me",{path:"/"})},ssoStatus}nyplSSO.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplSSO",[]).service("ssoStatus",ssoStatus).directive("nyplSso",nyplSSO)}(),function(){"use strict";function AmenitiesCtrl($rootScope,$scope,amenities,config,nyplAmenities){$rootScope.title="Amenities",$scope.amenitiesCategories=nyplAmenities.createAmenitiesCategories(amenities.amenities)}function AmenityCtrl($rootScope,$scope,amenity){var amenityProper=amenity.amenity,name=amenityProper.name;$rootScope.title=name,$scope.amenity=amenityProper,$scope.locations=amenityProper._embedded.locations,$scope.amenity_name=name}function AmenitiesAtLibraryCtrl($rootScope,$scope,config,location,nyplAmenities){var updatedAmenities=nyplAmenities.allAmenitiesArray(location._embedded.amenities);$scope.amenitiesCategories=nyplAmenities.createAmenitiesCategories(updatedAmenities),$rootScope.title=location.name,$scope.location=location}AmenitiesCtrl.$inject=["$rootScope","$scope","amenities","config","nyplAmenities"],AmenityCtrl.$inject=["$rootScope","$scope","amenity","config"],AmenitiesAtLibraryCtrl.$inject=["$rootScope","$scope","config","location","nyplAmenities"],angular.module("nypl_locations").controller("AmenityCtrl",AmenityCtrl).controller("AmenitiesCtrl",AmenitiesCtrl).controller("AmenitiesAtLibraryCtrl",AmenitiesAtLibraryCtrl)}(),function(){"use strict";function DivisionCtrl($rootScope,$scope,config,division,nyplUtility){var divisionsWithApt=config.divisions_with_appointments;$scope.division=division,$scope.location=division._embedded.location,$rootScope.title=division.name,$scope.calendarLink=nyplUtility.calendarLink,$scope.icalLink=nyplUtility.icalLink,division.hours.exceptions&&(division.hours.exceptions.description=nyplUtility.returnHTML(division.hours.exceptions.description)),division.hours&&($scope.hoursToday=nyplUtility.hoursToday(division.hours)),division._embedded.divisions&&_.each(division._embedded.divisions,function(division){division.hoursToday=nyplUtility.hoursToday(division.hours)}),$scope.division.social_media=nyplUtility.socialMediaColor(division.social_media),$scope.has_appointment=nyplUtility.divisionHasAppointment(divisionsWithApt,division.id)}DivisionCtrl.$inject=["$rootScope","$scope","config","division","nyplUtility"],angular.module("nypl_locations").controller("DivisionCtrl",DivisionCtrl)}(),function(){"use strict";function LocationsCtrl($rootScope,$scope,$timeout,$state,config,nyplCoordinatesService,nyplGeocoderService,nyplLocationsService,nyplUtility,nyplSearch,nyplAmenities){var locations,searchValues=nyplSearch.getSearchValues(),research_order=config.research_order||["SASB","LPA","SC","SIBL"],user={coords:{},address:""},sortListBy=function(type){$scope.predicate=type},resetProperty=function(arr,property){_.each(arr,function(location){location[property]=""})},resetPage=function(){$scope.searchMarker=!1,$scope.researchBranches=!1,$scope.userMarker=!1,$scope.reverse=!1,$scope.searchTerm="",$scope.geolocationAddressOrSearchQuery="",$scope.select_library_for_map="",sortListBy("name"),resetProperty($scope.locations,"distance"),resetProperty($scope.locations,"highlight")},geolocationAvailable=function(){nyplCoordinatesService.geolocationAvailable()&&($scope.geolocationOn=!0)},isMapPage=function(){return"home.map"===$state.current.name},loadUserCoordinates=function(){return nyplCoordinatesService.getBrowserCoordinates().then(function(position){return user.coords=_.pick(position,"latitude","longitude"),user})},checkUserDistance=function(user){if($scope.locations=nyplUtility.calcDistance($scope.locations,user.coords),nyplUtility.checkDistance($scope.locations))throw resetPage(),new Error("You are not within 25 miles of any NYPL library.");return user.coords},loadUserVariables=function(){$scope.locationStart=user.coords.latitude+","+user.coords.longitude,$scope.userMarker=!0,isMapPage()||$state.go("home.map"),sortListBy("distance"),nyplGeocoderService.createMarker("user",user.coords,"Your Current Location"),$scope.drawUserMarker()},loadReverseGeocoding=function(coords){return nyplSearch.resetSearchValues(),nyplGeocoderService.reverseGeocoding({lat:coords.latitude,lng:coords.longitude}).then(function(address){return $scope.geolocationAddressOrSearchQuery=address,nyplSearch.setSearchValue("resultsNear",address).setSearchValue("locations",$scope.locations),address})},loadGeocoding=function(searchTerm){return nyplSearch.setSearchValue("searchTerm",searchTerm),nyplGeocoderService.geocodeAddress(searchTerm).then(function(coords){return{coords:coords,searchTerm:coords.name}}).catch(function(error){throw error})},searchByCoordinates=function(searchObj){var locationsCopy=$scope.locations,coords=searchObj.coords,searchterm=searchObj.searchTerm;if(locationsCopy=nyplUtility.calcDistance(locationsCopy,coords),nyplUtility.checkDistance(locationsCopy))throw $scope.searchError=searchterm,nyplGeocoderService.panMap(),new Error("The search query is too far");return $scope.userMarker=!1,nyplGeocoderService.removeMarker("user"),nyplSearch.setSearchValue("resultsNear",searchObj.searchTerm),$scope.geolocationAddressOrSearchQuery=searchterm,$scope.searchError="",locationsCopy},organizeLocations=function(locations,filteredLocations,sortByFilter){resetProperty(locations,"highlight"),_.each(filteredLocations,function(location){location.highlight="active",location.distance=""}),locations=_.sortBy(locations,function(location){return location[sortByFilter]}),locations=_.difference(locations,filteredLocations),$scope.locations=_.union(filteredLocations,locations),nyplSearch.setSearchValue("locations",$scope.locations),sortListBy("")},scrollListTop=function(){var scrollable_lists=[angular.element(".locations-list-view tbody"),angular.element(".locations-data-wrapper")];_.each(scrollable_lists,function(list){$(list).animate({scrollTop:"0px"},1e3)})},showLibrariesTypeOf=function(type){$scope.location_type=type},loadPreviousStateOrNewState=function(){searchValues.locations?($scope.locations=searchValues.locations,$scope.searchTerm=searchValues.searchTerm,$scope.geolocationAddressOrSearchQuery=searchValues.resultsNear,$scope.searchMarker=searchValues.searchMarker,$scope.searchMarker&&nyplGeocoderService.drawSearchMarker(),sortListBy($scope.geolocationAddressOrSearchQuery?"distance":"name")):$scope.loadLocations()};$scope.loadLocations=function(){return nyplLocationsService.allLocations().then(function(data){var amenitiesCount=nyplAmenities.getAmenityConfig(config);return locations=data.locations,$scope.locations=locations,_.each($scope.locations,function(location){var locationAddress=nyplUtility.getAddressString(location,!0),markerCoordinates={};location.geolocation&&location.geolocation.coordinates&&(markerCoordinates={latitude:location.geolocation.coordinates[1],longitude:location.geolocation.coordinates[0]}),location.hoursToday=nyplUtility.hoursToday,location.locationDest=nyplUtility.getAddressString(location),location.amenities_list=nyplAmenities.getHighlightedAmenities(location._embedded.amenities,amenitiesCount.global,amenitiesCount.local),location.branchException=nyplUtility.branchException(location.hours),location.research_order=nyplUtility.researchLibraryOrder(research_order,location.id),!nyplGeocoderService.doesMarkerExist(location.slug)&&location.geolocation&&nyplGeocoderService.createMarker(location.slug,markerCoordinates,locationAddress)}),resetPage(),nyplSearch.setSearchValue("locations",$scope.locations),locations
}).catch(function(error){throw $state.go("404"),error})},$scope.scrollPage=function(){var top,content=angular.element(".container__all-locations"),containerWidth=parseInt(content.css("width"),10);601>containerWidth&&(top=angular.element(".map-search__results").offset()||angular.element(".search__results").offset(),$timeout(function(){angular.element("body").animate({scrollTop:top.top},1e3)},1e3))},$scope.viewMapLibrary=function(library_id){var location=_.where($scope.locations,{slug:library_id});$scope.select_library_for_map=library_id,$scope.searchMarker=!1,isMapPage()?nyplGeocoderService.hideSearchInfowindow().panExistingMarker(library_id):$state.go("home.map"),organizeLocations($scope.locations,location,"name"),$scope.scrollPage()},$scope.useGeolocation=function(){nyplGeocoderService.removeMarker("search"),resetPage(),$scope.scrollPage(),scrollListTop(),loadUserCoordinates().then(checkUserDistance).then(loadReverseGeocoding).then(loadUserVariables).catch(function(error){$scope.distanceError=error.message,$scope.geolocationOn=!1})},$scope.clearSearch=function(){nyplSearch.resetSearchValues(),showLibrariesTypeOf(),nyplGeocoderService.showAllLibraries().removeMarker("user"),isMapPage()&&nyplGeocoderService.removeMarker("search").hideInfowindow().panMap(),resetPage(),scrollListTop()},$scope.drawUserMarker=function(){nyplGeocoderService.doesMarkerExist("user")&&nyplGeocoderService.panExistingMarker("user")},$scope.geocodeAddress=function(searchTerm){!searchTerm||searchTerm.length<3||($scope.geolocationAddressOrSearchQuery="",$scope.searchError="",showLibrariesTypeOf(),$scope.researchBranches=!1,nyplGeocoderService.showAllLibraries(),$scope.searchTerm=searchTerm,searchTerm=nyplSearch.searchWordFilter(searchTerm),scrollListTop(),isMapPage()||$state.go("home.map"),loadGeocoding(searchTerm).then(function(searchObj){return nyplGeocoderService.createSearchMarker(searchObj.coords,searchObj.searchTerm),searchByCoordinates(searchObj)}).then(function(locations){$scope.scrollPage(),$scope.searchMarker=!0,nyplSearch.setSearchValue("searchMarker",!0),nyplGeocoderService.drawSearchMarker(),organizeLocations(locations,[],"distance")}).catch(function(){nyplGeocoderService.removeMarker("search"),$scope.searchMarker=!1,nyplSearch.resetSearchValues(),resetPage()}))},$scope.showResearch=function(){nyplGeocoderService.hideInfowindow(),scrollListTop(),$scope.researchBranches=!$scope.researchBranches,$scope.researchBranches?(nyplGeocoderService.showResearchLibraries().panMap(),showLibrariesTypeOf("research"),sortListBy("research_order")):(nyplGeocoderService.showAllLibraries().panMap(),showLibrariesTypeOf(),sortListBy("name"))},$rootScope.title="Locations",$scope.$state=$state,loadPreviousStateOrNewState(),geolocationAvailable()}function MapCtrl($scope,$timeout,nyplGeocoderService){var loadMapMarkers=function(){$timeout(function(){$scope.locations&&(nyplGeocoderService.showAllLibraries(),$scope.researchBranches&&nyplGeocoderService.showResearchLibraries())},1200)},drawMap=function(){$timeout(function(){nyplGeocoderService.drawMap({lat:40.7532,"long":-73.9822},12,"all-locations-map").drawLegend("all-locations-map-legend"),$scope.locations&&nyplGeocoderService.showAllLibraries(),loadMapMarkers(),$scope.drawUserMarker(),$scope.searchMarker&&nyplGeocoderService.drawSearchMarker(),$scope.researchBranches&&nyplGeocoderService.showResearchLibraries(),$scope.select_library_for_map&&nyplGeocoderService.panExistingMarker($scope.select_library_for_map),$scope.scrollPage()},1200)};drawMap(),$scope.panToLibrary=function(slug){nyplGeocoderService.hideSearchInfowindow().panExistingMarker(slug),$scope.scrollPage()}}function LocationCtrl($rootScope,$scope,$timeout,config,location,nyplCoordinatesService,nyplUtility,nyplAmenities){var amenities=location._embedded.amenities,amenitiesCount=nyplAmenities.getAmenityConfig(config),loadUserCoordinates=function(){return nyplCoordinatesService.getBrowserCoordinates().then(function(position){var userCoords=_.pick(position,"latitude","longitude");$timeout(function(){$scope.locationStart=userCoords.latitude+","+userCoords.longitude})})};loadUserCoordinates(),$scope.location=location,$rootScope.title=location.name,location.hours.exceptions&&(location.hours.exceptions.description=nyplUtility.returnHTML(location.hours.exceptions.description)),_.each(location._embedded.amenities,function(amenity){amenity.amenity=nyplAmenities.addAmenitiesIcon(amenity.amenity)}),location.amenities_list=nyplAmenities.getHighlightedAmenities(amenities,amenitiesCount.global,amenitiesCount.local),$scope.calendarLink=nyplUtility.calendarLink,$scope.icalLink=nyplUtility.icalLink,$scope.location.social_media=nyplUtility.socialMediaColor($scope.location.social_media),location.hours&&($scope.hoursToday=nyplUtility.hoursToday(location.hours)),location._embedded.exhibitions&&_.each(location._embedded.exhibitions,function(exh){exh.start&&exh.end&&(exh.prettyDate=nyplUtility.formatDate(exh.start,exh.end))}),_.each(location._embedded.divisions,function(division){division.hoursToday=nyplUtility.hoursToday(division.hours)}),_.each(location._embedded.features,function(feature){feature.body=nyplUtility.returnHTML(feature.body)}),$scope.locationDest=nyplUtility.getAddressString(location),config.closed_img&&($scope.location.images.closed=config.closed_img)}LocationsCtrl.$inject=["$rootScope","$scope","$timeout","$state","config","nyplCoordinatesService","nyplGeocoderService","nyplLocationsService","nyplUtility","nyplSearch","nyplAmenities"],MapCtrl.$inject=["$scope","$timeout","nyplGeocoderService"],LocationCtrl.$inject=["$rootScope","$scope","$timeout","config","location","nyplCoordinatesService","nyplUtility","nyplAmenities"],angular.module("nypl_locations").controller("LocationsCtrl",LocationsCtrl).controller("MapCtrl",MapCtrl).controller("LocationCtrl",LocationCtrl)}(),function(){"use strict";function WidgetCtrl($location,$rootScope,$scope,$timeout,$window,config,data,nyplCoordinatesService,nyplUtility){config.self;$rootScope.title=data.name,$scope.data=data,$scope.locinator_url="http://locations-beta.nypl.org"+$location.path().substr(7),$scope.widget_name=data.name,data._embedded.location&&($scope.division=!0,$scope.data.images.exterior=data.images.interior),config.closed_img&&($scope.data.images.closed=config.closed_img),data.hours&&($scope.hoursToday=nyplUtility.hoursToday(data.hours)),$scope.data.social_media=nyplUtility.socialMediaColor($scope.data.social_media),$scope.locationDest=nyplUtility.getAddressString(data)}WidgetCtrl.$inject=["$location","$rootScope","$scope","$timeout","$window","config","data","nyplCoordinatesService","nyplUtility"],angular.module("nypl_widget").controller("WidgetCtrl",WidgetCtrl)}(),function(){"use strict";function loadingWidget(requestNotificationChannel){return{restrict:"A",link:function(scope,element){var startRequestHandler=function(){element.addClass("show")},endRequestHandler=function(){element.removeClass("show")};element.hasClass("show")&&element.removeClass("show"),requestNotificationChannel.onRequestStarted(scope,startRequestHandler),requestNotificationChannel.onRequestEnded(scope,endRequestHandler)}}}function nyplTranslate(){return{restrict:"E",templateUrl:"scripts/directives/templates/translatebuttons.html",replace:!0,controller:function($scope,$translate){$scope.translate=function(language){$translate.use(language)}}}}function todayshours(){return{restrict:"E",templateUrl:"scripts/directives/templates/todaysHours.html",replace:!0,scope:{hours:"@"}}}function emailusbutton(){return{restrict:"E",templateUrl:"scripts/directives/templates/emailus.html",replace:!0,scope:{link:"@"}}}function librarianchatbutton(nyplUtility){return{restrict:"E",templateUrl:"scripts/directives/templates/librarianchat.html",replace:!0,link:function(scope,element){scope.openChat=function(){nyplUtility.popupWindow("http://www.nypl.org/ask-librarian","NYPL Chat",210,450),element.hasClass("active")||element.addClass("active")}}}}function scrolltop($window){return function(scope){scope.$on("$stateChangeStart",function(){$window.scrollTo(0,0)})}}function eventRegistration($filter){function eventStarted(startDate){var sDate=new Date(startDate),today=new Date;return sDate.getTime()>today.getTime()?!0:!1}return{restrict:"E",templateUrl:"scripts/directives/templates/registration.html",replace:!0,scope:{registration:"=",status:"=",link:"="},link:function(scope){scope.online=!1,scope.registration&&(scope.eventRegStarted=eventStarted(scope.registration.start),"Online"==scope.registration.type?(scope.online=!0,scope.reg_msg=scope.eventRegStarted?"Online, opens "+$filter("date")(scope.registration.start,"MM/dd"):"Online"):scope.reg_msg=scope.registration.type)}}}function nyplSiteAlerts($timeout,nyplLocationsService,nyplUtility){return{restrict:"E",templateUrl:"scripts/directives/templates/alerts.html",replace:!0,link:function(scope){var alerts;$timeout(function(){nyplLocationsService.alerts().then(function(data){alerts=data.alerts,scope.sitewidealert=nyplUtility.alerts(alerts)})},200)}}}function nyplLibraryAlert(){function alertExpired(startDate,endDate){var sDate=new Date(startDate),eDate=new Date(endDate),today=new Date;return sDate.getTime()<=today.getTime()&&eDate.getTime()>=today.getTime()?!1:!0}return{restrict:"E",templateUrl:"scripts/directives/templates/library-alert.html",replace:!0,scope:{exception:"="},link:function(scope){scope.exception&&(scope.alertExpired=alertExpired(scope.exception.start,scope.exception.end),""!==scope.exception.description&&scope.alertExpired===!1&&(scope.libraryAlert=scope.exception.description))}}}function collapse(){function link($scope,element,attributes){var exp=attributes.collapse,class_name=attributes.className||"open",duration=attributes.duration||"fast";$scope.$eval(exp)||element.hide(),$scope.$watch(exp,function(newVal,oldVal){newVal!==oldVal&&(newVal?element.stop(!0,!0).slideDown(duration).addClass(class_name):element.stop(!0,!0).slideUp(duration).removeClass(class_name))})}return{link:link,restrict:"A"}}function nyplFundraising($timeout,nyplLocationsService){return{restrict:"E",templateUrl:"scripts/directives/templates/fundraising.html",replace:!0,scope:{fundraising:"=fundraising",category:"@"},link:function(scope){scope.fundraising||$timeout(function(){nyplLocationsService.getConfig().then(function(data){var fundraising=data.fundraising;scope.fundraising={appeal:fundraising.appeal,statement:fundraising.statement,button_label:fundraising.button_label,link:fundraising.link}})},200)}}}function nyplSidebar(){return{restrict:"E",templateUrl:"scripts/directives/templates/sidebar-widgets.html",replace:!0,scope:{donateButton:"@",nyplAsk:"@"},link:function(scope,elem,attrs){var url="https://secure3.convio.net/nypl/site/SPageServer?pagename=donation_form&JServSessionIdr003=dwcz55yj27.app304a&s_src=FRQ14ZZ_SWBN";scope.donateUrl=attrs.donateurl||url}}}function nyplAutofill($state,$analytics){return{restrict:"AEC",templateUrl:"scripts/directives/templates/autofill.html",scope:{data:"=",model:"=ngModel",mapView:"&",geoSearch:"&"},link:function($scope,elem,attrs,controller){function initAutofill(){$scope.$watch("model",function(newValue){controller.updateSearchText($scope.data,newValue)}),$scope.$on("$stateChangeSuccess",function(){controller.resetSearchTerms(),controller.closeAutofill()})}$scope.focused=!1,$scope.activated=!1,$scope.geocodingactive=!1,$scope.filtered=[],$scope.items,$scope.active,$scope.currentIndex;var input=angular.element(document.getElementById("searchTerm")),html=angular.element(document.getElementsByTagName("html"));input.bind("focus",function(){$scope.$apply(function(){controller.openAutofill()})}),input.bind("click",function(e){e.stopPropagation()}),input.bind("keyup",function(e){13===e.keyCode&&$scope.$apply(function(){$scope.activated?$scope.active.slug?($scope.activated=!1,controller.closeAutofill(),$scope.model=$scope.active.name,$state.go("location",{location:$scope.active.slug})):($scope.geoSearch({term:$scope.model}),$scope.geocodingactive=!1,$scope.activated=!1,input.blur()&&controller.closeAutofill()):controller.setSearchText($scope.model)?($scope.model=$scope.items[0].name,controller.closeAutofill(),$analytics.eventTrack("Accept",{category:"Locations",label:$scope.model}),$state.go("location",{location:$scope.items[0].slug})):($scope.geoSearch({term:$scope.model}),input.blur()&&controller.closeAutofill())}),39===e.keyCode&&$scope.$apply(function(){controller.setSearchText($scope.model)}),8===e.keyCode&&$scope.$apply(function(){$scope.lookahead=""}),27===e.keyCode}),input.bind("keydown",function(e){(9===e.keyCode||13===e.keyCode||27===e.keyCode)&&e.preventDefault(),38===e.keyCode&&(e.preventDefault(),$scope.$apply(function(){$scope.activated?controller.activatePreviousItem():controller.activateFirstItem()})),40===e.keyCode&&(e.preventDefault(),$scope.$apply(function(){$scope.activated?controller.activateNextItem():controller.activateFirstItem(),controller.activateGeocodingItem()}))}),html.bind("click",function(){$scope.$apply(function(){controller.closeAutofill()})}),initAutofill()},controller:function($scope){$scope.lookahead="",$scope.currentWord="",$scope.completeWord="",this.closeAutofill=function(){return $scope.focused=!1},this.openAutofill=function(){return $scope.focused=!0},this.activate=function(item){return item},this.activateFirstItem=function(){$scope.active=$scope.filtered[0],$scope.currentIndex=$scope.filtered.indexOf($scope.active),$scope.activated=!0},this.activateNextItem=function(){$scope.geocodingactive=!1,$scope.currentIndex<$scope.filtered.length&&$scope.currentIndex>=0?($scope.currentIndex=$scope.filtered.indexOf($scope.active)+1,$scope.active=this.activate($scope.filtered[$scope.currentIndex])):($scope.active=void 0,$scope.currentIndex=-1)},this.activatePreviousItem=function(){$scope.geocodingactive=!1,-1===$scope.currentIndex?($scope.currentIndex=$scope.filtered.length-1,$scope.active=this.activate($scope.filtered[$scope.currentIndex])):$scope.currentIndex<=$scope.filtered.length&&$scope.currentIndex>0&&($scope.currentIndex=$scope.currentIndex-1,$scope.active=this.activate($scope.filtered[$scope.currentIndex]))},this.activateGeocodingItem=function(){!$scope.active&&$scope.activated&&($scope.active=this.activate($scope.model),$scope.geocodingactive=!0)},this.setSearchText=function(){return $scope.completeWord!==$scope.model&&""!==$scope.completeWord&&""!==$scope.model?$scope.model=$scope.completeWord:void 0},this.resetSearchTerms=function(){$scope.lookahead="",$scope.currentWord=""},this.filterStartsWith=function(data,searchTerm){return _.filter(data,function(elem){return elem.name?elem.name.substring(0,searchTerm.length).toLowerCase()===searchTerm.toLowerCase():!1})},this.filterTermWithin=function(data,searchTerm){return _.filter(data,function(elem){return elem.name?elem.name.toLowerCase().indexOf(searchTerm.toLowerCase())>=0:!1})},this.updateSearchText=function(data,searchTerm){return""!==searchTerm&&searchTerm&&data&&searchTerm.length>1?($scope.items=this.filterStartsWith(data,searchTerm),$scope.filtered=this.filterTermWithin(data,searchTerm),$scope.items[0]?($scope.lookahead=$scope.items[0].name.substring(searchTerm.length),$scope.currentWord=searchTerm):this.resetSearchTerms(),$scope.completeWord=$scope.currentWord+$scope.lookahead):void 0}}}}loadingWidget.$inject=["requestNotificationChannel"],librarianchatbutton.$inject=["nyplUtility"],scrolltop.$inject=["$window"],eventRegistration.$inject=["$filter"],nyplSiteAlerts.$inject=["$timeout","nyplLocationsService","nyplUtility"],nyplLibraryAlert.$inject=["nyplUtility"],nyplFundraising.$inject=["$timeout","nyplLocationsService"],nyplAutofill.$inject=["$state","$analytics"],angular.module("nypl_locations").directive("loadingWidget",loadingWidget).directive("nyplTranslate",nyplTranslate).directive("todayshours",todayshours).directive("emailusbutton",emailusbutton).directive("librarianchatbutton",librarianchatbutton).directive("scrolltop",scrolltop).directive("eventRegistration",eventRegistration).directive("nyplSiteAlerts",nyplSiteAlerts).directive("nyplLibraryAlert",nyplLibraryAlert).directive("nyplFundraising",nyplFundraising).directive("nyplSidebar",nyplSidebar).directive("nyplAutofill",nyplAutofill).directive("collapse",collapse),angular.module("nypl_widget").directive("todayshours",todayshours).directive("nyplFundraising",nyplFundraising).directive("librarianchatbutton",librarianchatbutton).directive("emailusbutton",emailusbutton)}(),function(){"use strict";function timeFormat(){function clockTime(time){var components=time.split(":"),hours=(parseInt(components[0],10)+11)%12+1,minutes=components[1],meridiem=components[0]>=12?"pm":"am";return hours+":"+minutes+meridiem}return function(timeObj){var time=void 0!==timeObj&&void 0!==timeObj.today?timeObj.today:timeObj;return time?null===time.open?"Closed":clockTime(time.open)+" - "+clockTime(time.close):(console.log("timeFormat() filter function error: Argument is not defined or empty, verify API response for time"),"")}}function dateToISO(){return function(input){return new Date(input).toISOString()}}function capitalize(){return function(input){return"string"==typeof input?input.replace(/(^|\s)([a-z])/g,function(str){return str.toUpperCase()}):input}}function hoursTodayFormat(){function getHoursObject(time){return time=time.split(":"),_.object(["hours","mins","meridian","military"],[(parseInt(time[0],10)+11)%12+1,time[1],time[0]>=12?"pm":"am",time[0]])}return function(elem,type){var open_time,closed_time,formatted_time,today,tomorrow,tomorrow_open_time,tomorrow_close_time,now=new Date,hour_now_military=now.getHours();if(elem){if(today=elem.today,tomorrow=elem.tomorrow,today.open&&(open_time=getHoursObject(today.open)),today.close&&(closed_time=getHoursObject(today.close)),!today.open||!today.close)return console.log("Returned object is undefined for open/closed elems"),"Closed today";if(null!==tomorrow.open&&(tomorrow_open_time=getHoursObject(tomorrow.open)),null!==tomorrow.close&&(tomorrow_close_time=getHoursObject(tomorrow.close)),hour_now_military>=closed_time.military)return tomorrow_open_time||tomorrow_close_time?"Open tomorrow "+tomorrow_open_time.hours+(0!==parseInt(tomorrow_open_time.mins,10)?":"+tomorrow_open_time.mins:"")+tomorrow_open_time.meridian+"-"+tomorrow_close_time.hours+(0!==parseInt(tomorrow_close_time.mins,10)?":"+tomorrow_close_time.mins:"")+tomorrow_close_time.meridian:"Closed today";switch(tomorrow_open_time&&hour_now_military>=0&&hour_now_military<tomorrow_open_time.military&&(type="long"),type){case"short":formatted_time="Open today until "+closed_time.hours+(0!==parseInt(closed_time.mins,10)?":"+closed_time.mins:"")+closed_time.meridian;break;case"long":formatted_time="Open today "+open_time.hours+(0!==parseInt(open_time.mins,10)?":"+open_time.mins:"")+open_time.meridian+"-"+closed_time.hours+(0!==parseInt(closed_time.mins,10)?":"+closed_time.mins:"")+closed_time.meridian;break;default:formatted_time=open_time.hours+":"+open_time.mins+open_time.meridian+"-"+closed_time.hours+":"+closed_time.mins+closed_time.meridian}return formatted_time}return"Not available"}}function truncate(){return function(text,length,end){return"string"!=typeof text?text:text.length<200?text:(isNaN(length)&&(length=200),void 0===end&&(end="..."),text.length<=length||text.length-end.length<=length?text:String(text).substring(0,length-end.length)+end)}}angular.module("nypl_locations").filter("timeFormat",timeFormat).filter("dateToISO",dateToISO).filter("capitalize",capitalize).filter("hoursTodayFormat",hoursTodayFormat).filter("truncate",truncate),angular.module("nypl_widget").filter("hoursTodayFormat",hoursTodayFormat)}(),function(){"use strict";function nyplAmenities(){var amenities={},sortAmenitiesList=function(list,sortBy){return list instanceof Array?_.sortBy(list,function(item){return item.amenity?item.amenity[sortBy]?item[sortBy]:item.amenity[sortBy]:void 0}):void 0};return amenities.addAmenitiesIcon=function(amenity){return amenity&&amenity.category?(amenity.icon=this.getCategoryIcon(amenity.category),amenity.icon=this.getAmenityIcon(amenity.id,amenity.icon),amenity):void 0},amenities.getCategoryIcon=function(category,default_icon){var icon=default_icon||"";switch(category){case"Computer Services":icon="icon-screen2";break;case"Circulation":icon="icon-book";break;case"Printing and Copy Services":icon="icon-copy";break;case"Facilities":icon="icon-library";break;case"Assistive Technologies":icon="icon-accessibility2"}return icon},amenities.getAmenityIcon=function(id,default_icon){var icon=default_icon||"";switch(id){case 7967:icon="icon-connection";break;case 7965:icon="icon-laptop";break;case 7966:icon="icon-print";break;case 7968:icon="icon-power-cord";break;case 7971:case 7972:icon="icon-box-add"}return icon},amenities.allAmenitiesArray=function(amenities){return amenities?_.chain(amenities).pluck("amenity").flatten(!0).value():void 0},amenities.getAmenityCategories=function(amenities){return amenities?_.chain(amenities).pluck("category").flatten(!0).unique().value():void 0},amenities.createAmenitiesCategories=function(amenities){var categoryNames,categoryObj,default_order=["Computer Services","Circulation","Printing and Copy Services","Facilities","Assistive Technologies"],categories=[],self=this;if(amenities)return categoryNames=this.getAmenityCategories(amenities),_.each(categoryNames,function(category){categoryObj={},categoryObj.amenities=_.where(amenities,{category:category}),categoryObj.name=category,categoryObj.icon=self.getCategoryIcon(category),categoryObj.amenities.length&&(categories[_.indexOf(default_order,category)]=categoryObj)}),categories},amenities.getHighlightedAmenities=function(amenities,rank,loc_rank){var initial_list=amenities,amenities_list=[];if(amenities&&amenities.length&&rank&&loc_rank)return initial_list=sortAmenitiesList(initial_list,"rank"),amenities_list=initial_list.splice(0,rank),initial_list=sortAmenitiesList(initial_list,"location_rank"),initial_list=initial_list.splice(0,loc_rank),amenities_list=_.union(amenities_list,initial_list)},amenities.getAmenityConfig=function(config,globalDefault,localDefault){var obj={},global=globalDefault||3,local=localDefault||2;return config&&config.featured_amenities?(obj.global=config.featured_amenities.global||global,obj.local=config.featured_amenities.local||local):(obj.global=global,obj.local=local),obj},amenities}angular.module("nypl_locations").factory("nyplAmenities",nyplAmenities)}(),function(){"use strict";function nyplGeocoderService($q){var map,filteredLocation,markers=[],searchMarker=new google.maps.Marker({icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}),searchInfoWindow=new google.maps.InfoWindow,infowindow=new google.maps.InfoWindow,geocoderService={},getMarkerFromList=function(id){return _.findWhere(markers,{id:id})},showInfowindow=function(marker,text){geocoderService.hideInfowindow(),infowindow.setContent(text),infowindow.open(map,marker)},removeMarkerFromMap=function(id){var markerObj=getMarkerFromList(id);geocoderService.doesMarkerExist(id)&&markerObj.marker.setMap(null)},addMarkerToMap=function(id){var markerObj=getMarkerFromList(id);markerObj&&markerObj.marker.setMap(map)};return geocoderService.geocodeAddress=function(address){var defer=$q.defer(),coords={},geocoder=new google.maps.Geocoder,sw_bound=new google.maps.LatLng(40.49,-74.26),ne_bound=new google.maps.LatLng(40.91,-73.77),bounds=new google.maps.LatLngBounds(sw_bound,ne_bound),geocodeOptions={address:address,bounds:bounds,region:"US",componentRestrictions:{country:"US",locality:"New York"}};return geocoder.geocode(geocodeOptions,function(result,status){status===google.maps.GeocoderStatus.OK?(coords.lat=result[0].geometry.location.k,coords.long=result[0].geometry.location.B||result[0].geometry.location.A,coords.name=result[0].formatted_address,defer.resolve(coords)):defer.reject(new Error(status))}),defer.promise},geocoderService.reverseGeocoding=function(coords){var address,defer=$q.defer(),geocoder=new google.maps.Geocoder,latlng=new google.maps.LatLng(coords.lat,coords.lng);return geocoder.geocode({latLng:latlng},function(result,status){status===google.maps.GeocoderStatus.OK?(address=result[0].formatted_address,defer.resolve(address)):defer.reject(new Error(status))}),defer.promise},geocoderService.drawMap=function(coords,zoom,id){var locationCoords=new google.maps.LatLng(coords.lat,coords.long),mapOptions={zoom:zoom,center:locationCoords,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,streetViewControl:!1};return map=new google.maps.Map(document.getElementById(id),mapOptions),this},geocoderService.drawLegend=function(id){var mapLegend=document.getElementById(id);return map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(mapLegend),mapLegend.className="show-legend",this},geocoderService.panMap=function(marker){var position,zoom,sasbLocation=new google.maps.LatLng(40.7632,-73.9822);if(map)return marker?(position=marker.getPosition(),zoom=14):(position=sasbLocation,zoom=12),map.panTo(position),map.setZoom(zoom),this},geocoderService.showResearchLibraries=function(){var list=["schwarzman","lpa","sibl","schomburg","user"];return _.each(markers,function(marker){_.contains(list,marker.id)||removeMarkerFromMap(marker.id)}),this},geocoderService.showAllLibraries=function(){return markers&&_.each(markers,function(marker){addMarkerToMap(marker.id)}),this},geocoderService.createMarker=function(id,location,text){var marker,position=new google.maps.LatLng(location.latitude,location.longitude),markerOptions={position:position,icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"};"user"===id&&(markerOptions.icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png",markerOptions.zIndex=1e3,markerOptions.animation=google.maps.Animation.DROP),marker=new google.maps.Marker(markerOptions),markers.push({id:id,marker:marker,text:text}),google.maps.event.addListener(marker,"click",function(){showInfowindow(marker,text)})},geocoderService.hideInfowindow=function(){return infowindow.close(),this},geocoderService.doesMarkerExist=function(id){return!!getMarkerFromList(id)},geocoderService.createSearchMarker=function(coords,text){var searchTerm=text.replace(","," <br>").replace(","," <br>"),panCoords=new google.maps.LatLng(coords.lat,coords.long);searchMarker.setPosition(panCoords),searchInfoWindow.setContent(searchTerm)},geocoderService.drawSearchMarker=function(){return filteredLocation||(searchMarker.setMap(map),this.panMap(searchMarker),searchInfoWindow.open(map,searchMarker),this.hideInfowindow(),google.maps.event.addListener(searchMarker,"click",function(){searchInfoWindow.open(map,searchMarker)})),this},geocoderService.hideSearchInfowindow=function(){return searchInfoWindow.close(),this},geocoderService.removeMarker=function(id){return id?("search"===id?searchMarker.setMap(null):removeMarkerFromMap(id),this):this},geocoderService.panExistingMarker=function(id){var markerObj=getMarkerFromList(id),marker=markerObj.marker;return(void 0===marker.getMap()||null===marker.getMap())&&addMarkerToMap(id),this.panMap(marker),showInfowindow(markerObj.marker,markerObj.text),this},geocoderService}nyplGeocoderService.$inject=["$q"],angular.module("nypl_locations").factory("nyplGeocoderService",nyplGeocoderService)}(),function(){"use strict";function nyplSearch($filter){var search={},searchValues={};return search.setSearchValue=function(prop,val){return searchValues[prop]=val,this},search.getSearchValues=function(){return searchValues},search.resetSearchValues=function(){return searchValues={},this},search.idLocationSearch=function(locations,searchTerm){var IDFilter=[];if(locations&&searchTerm)return searchTerm.length>=2&&searchTerm.length<=4&&(IDFilter=_.where(locations,{id:searchTerm.toUpperCase()})),IDFilter},search.locationSearch=function(locations,searchTerm){var lazyFilter,strictFilter;if(locations&&searchTerm&&!(searchTerm.length<3))return lazyFilter=$filter("filter")(locations,searchTerm),strictFilter=$filter("filter")(locations,searchTerm,!0),lazyFilter},search.searchWordFilter=function(query){var words=["branch"];if(query)return _.each(words,function(word){query=query.replace(word,"")}),query},search}nyplSearch.$inject=["$filter"],angular.module("nypl_locations").factory("nyplSearch",nyplSearch)}(),function(){"use strict";function requestNotificationChannel($rootScope){var _START_REQUEST_="_START_REQUEST_",_END_REQUEST_="_END_REQUEST_",notificationChannel={};return notificationChannel.requestStarted=function(){$rootScope.$broadcast(_START_REQUEST_)},notificationChannel.requestEnded=function(){$rootScope.$broadcast(_END_REQUEST_)},notificationChannel.onRequestStarted=function($scope,handler){$scope.$on(_START_REQUEST_,function(event){handler(event)})},notificationChannel.onRequestEnded=function($scope,handler){$scope.$on(_END_REQUEST_,function(event){handler(event)})},notificationChannel}function nyplUtility($window,$sce,nyplCoordinatesService){var utility={};return utility.hoursToday=function(hours){var hoursToday,date=new Date,today=date.getDay(),tomorrow=today+1;return hours&&(hoursToday={today:{day:hours.regular[today].day,open:hours.regular[today].open,close:hours.regular[today].close},tomorrow:{day:hours.regular[tomorrow%7].day,open:hours.regular[tomorrow%7].open,close:hours.regular[tomorrow%7].close}}),hoursToday},utility.formatDate=function(startDate,endDate){var formattedDate,months=["January","February","March","April","May","June","July","August","September","October","November","December"];if(this.numDaysFromToday=function(date,today){return Math.round((date.valueOf()-today.valueOf())/1e3/86400-.5)},startDate&&endDate){var sDate=new Date(startDate),eDate=new Date(endDate),today=new Date,nDays=this.numDaysFromToday(eDate,today);if(!nDays)return;formattedDate=365>=nDays?sDate.getTime()<=today.getTime()&&eDate.getTime()>=today.getTime()?"Now through "+months[eDate.getUTCMonth()]+" "+eDate.getUTCDate()+", "+eDate.getUTCFullYear():sDate.getTime()>today.getTime()&&eDate.getTime()>=today.getTime()?"Opening "+months[sDate.getUTCMonth()]+" "+sDate.getUTCDate()+", "+sDate.getUTCFullYear():months[sDate.getUTCMonth()]+" "+sDate.getUTCDate()+", "+sDate.getUTCFullYear()+" through "+months[eDate.getUTCMonth()]+" "+eDate.getUTCDate()+", "+eDate.getUTCFullYear():"Ongoing"}return formattedDate},utility.branchException=function(hours){var exception={};if(hours){if(!hours.exceptions)return null;if(""!==hours.exceptions.description.trim())return exception.desc=hours.exceptions.description,hours.exceptions.start&&(exception.start=hours.exceptions.start),hours.exceptions.end&&(exception.end=hours.exceptions.end),exception}return null},utility.getAddressString=function(location,nicePrint){if(!location)return"";var addressBreak=" ",linkedName=location.name;return nicePrint&&(addressBreak="<br />",linkedName="<a href='/#/"+location.slug+"'>"+location.name+"</a>"),linkedName+addressBreak+location.street_address+addressBreak+location.locality+", "+location.region+", "+location.postal_code},utility.socialMediaColor=function(social_media){return _.each(social_media,function(sc){switch(sc.classes="icon-",sc.site){case"facebook":sc.classes+=sc.site+" blueDarkerText";break;case"foursquare":sc.classes+=sc.site+" blueText";break;case"instagram":sc.classes+=sc.site+" blackText";break;case"twitter":sc.classes+=sc.site+"2 blueText";break;case"tumblr":sc.classes+=sc.site+"2 indigoText";break;case"youtube":case"pinterest":sc.classes+=sc.site+" redText";break;default:sc.classes+=sc.site}}),social_media},utility.alerts=function(alerts){var alert_start,alert_end,today=new Date,todaysAlert="";return alerts&&Array.isArray(alerts)&&(_.each(alerts,function(alert){alert_start=new Date(alert.start),alert_end=new Date(alert.end),today>=alert_start&&alert_end>=today&&(todaysAlert+=alert.body+"\n")}),!angular.isUndefined(todaysAlert))?todaysAlert:null},utility.popupWindow=function(link,title,width,height){var w,h,popUp,popUp_h,popUp_w;link&&(w=void 0===width?"300":"string"==typeof width||width instanceof String?width:width.toString(),h=void 0===height?"500":"string"==typeof width||width instanceof String?height:height.toString(),link&&title?popUp=$window.open(link,title,"menubar=1,resizable=1,width="+w+",height="+h):link&&(popUp=$window.open(link,"","menubar=1,resizable=1,width="+w+",height="+h)),popUp&&(popUp_w=parseInt(w,10),popUp_h=parseInt(h,10),popUp.moveTo(screen.width/2-popUp_w/2,screen.height/2-popUp_h/2)))
},utility.calendarLink=function(type,event,location){if(!type||!event||!location)return"";var title=event.title,start_date=event.start.replace(/[\-:]/g,""),end_date=event.end.replace(/[\-:]/g,""),body=event.body,url=event._links.self.href,address=location.name+" - "+location.street_address+" "+location.locality+", "+location.region+" "+location.postal_code,calendar_link="";switch(type){case"google":calendar_link="https://www.google.com/calendar/render?action=template&text="+title+"&dates="+start_date+"/"+end_date+"&details="+body+"&location="+address+"&pli=1&uid=&sf=true&output=xml";break;case"yahoo":calendar_link="https://calendar.yahoo.com/?v=60&TITLE="+title+"&ST="+start_date+"&in_loc="+address+"&in_st="+address+"&DESC="+body+"&URL="+url}return calendar_link},utility.icalLink=function(event,address){if(!event||!address)return"";var currentTime=(new Date).toJSON().toString().replace(/[\-.:]/g,""),url="http://nypl.org/"+event._links.self.href,icsMSG="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NYPL//NONSGML v1.0//EN\nMETHOD:PUBLISH\nBEGIN:VEVENT\nUID:"+(new Date).getTime()+"\nDTSTAMP:"+currentTime+"\nATTENDEE;CN=My Self ;\nORGANIZER;CN=NYPL:\nDTSTART:"+event.start.replace(/[\-:]/g,"")+"\nDTEND:"+event.end.replace(/[\-:]/g,"")+"\nLOCATION:"+address+"\nDESCRIPTION:"+event.body+"\nURL;VALUE=URI:"+url+"\nSUMMARY:"+event.title+"\nEND:VEVENT\nEND:VCALENDAR",icalLink="data:text/calendar;chartset=utf-8,"+encodeURI(icsMSG);return $window.open(icalLink),icalLink},utility.calcDistance=function(locations,coords){if(!locations)return[];var searchCoordinates={latitude:coords.latitude||coords.lat,longitude:coords.longitude||coords.long};return _.each(locations,function(location){var locationLat,locationLong,locCoords=[];location.geolocation&&location.geolocation.coordinates&&(locCoords=location.geolocation.coordinates),locationLat=location.lat||locCoords[1],locationLong=location.long||locCoords[0],location.distance=nyplCoordinatesService.getDistance(searchCoordinates.latitude,searchCoordinates.longitude,locationLat,locationLong)}),locations},utility.checkDistance=function(locations){var distanceArray=_.pluck(locations,"distance");return _.min(distanceArray)>25?!0:!1},utility.returnHTML=function(html){return $sce.trustAsHtml(html)},utility.divisionHasAppointment=function(divisionsWithApts,id){return _.contains(divisionsWithApts,id)},utility.researchLibraryOrder=function(research_order,id){return _.indexOf(research_order,id)},utility}requestNotificationChannel.$inject=["$rootScope"],nyplUtility.$inject=["$window","$sce","nyplCoordinatesService"],angular.module("nypl_locations").factory("nyplUtility",nyplUtility).factory("requestNotificationChannel",requestNotificationChannel),angular.module("nypl_widget").factory("nyplUtility",nyplUtility).factory("requestNotificationChannel",requestNotificationChannel)}();