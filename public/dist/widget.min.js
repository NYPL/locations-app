/*!
 __                                            __    
/\ \                      __                  /\ \__
\ \ \        ___     ___ /\_\    ___      __  \ \ ,_\   ___   _ __
 \ \ \  __  / __`\  /'___\/\ \ /' _ `\  /'__`\ \ \ \/  / __`\/\`'__\
  \ \ \_\ \/\ \_\ \/\ \__/\ \ \/\ \/\ \/\ \_\.\_\ \ \_/\ \_\ \ \ \/ 
   \ \____/\ \____/\ \____\\ \_\ \_\ \_\ \__/.\_\\ \__\ \____/\ \_\ 
    \/___/  \/___/  \/____/ \/_/\/_/\/_/\/__/\/_/ \/__/\/___/  \/_/ 
*/
var nypl_locations=angular.module("nypl_locations",["ngSanitize","ui.router","ngAnimate","locationService","coordinateService","nyplFeedback","nyplSearch","nyplSSO","nyplNavigation","nyplBreadcrumbs","angulartics","angulartics.google.analytics","newrelic-timing","nyplAlerts"]);nypl_locations.constant("_",window._),nypl_locations.config(["$analyticsProvider","$locationProvider","$stateProvider","$urlRouterProvider","$crumbProvider","$nyplAlertsProvider",function(a,b,c,d,e,f){"use strict";function g(a,b,c){return c.singleLocation(a.location).then(function(a){return a.location})["catch"](function(a){throw a})}function h(a,b,c,d){var e=d.singleDivision(b.division),f=d.singleDivision(b.subdivision);return a.all([e,f]).then(function(a){var b=(a[0].division,a[1].division);return b})}function i(a,b,c){return c.singleDivision(a.division).then(function(a){return a.division})["catch"](function(a){throw a})}function j(a,b,c){return c.amenities(a.amenity).then(function(a){return a})["catch"](function(a){throw a})}function k(a){return a.getConfig()}g.$inject=["$stateParams","config","nyplLocationsService"],h.$inject=["$q","$stateParams","config","nyplLocationsService"],i.$inject=["$stateParams","config","nyplLocationsService"],j.$inject=["$stateParams","config","nyplLocationsService"],k.$inject=["nyplLocationsService"],a.virtualPageviews(!1),b.html5Mode(!0),f.setOptions({api_root:locations_cfg.config.api_root,api_version:locations_cfg.config.api_version}),e.setOptions({primaryState:{name:"Home",customUrl:"http://nypl.org"},secondaryState:{name:"Locations",customUrl:"home.index"}}),d.rule(function(a,b){var c=b.url();return"/"===c[c.length-1]?c.slice(0,-1):void 0}),moment.tz.setDefault("America/New_York"),d.otherwise("/404"),c.state("home",{url:"/","abstract":!0,templateUrl:"views/locations.html",controller:"LocationsCtrl",label:"Locations",resolve:{config:k}}).state("home.index",{templateUrl:"views/location-list-view.html",url:"",label:"Locations"}).state("home.list",{templateUrl:"views/location-list-view.html",url:"list",label:"Locations"}).state("home.map",{templateUrl:"views/location-map-view.html",url:"map",controller:"MapCtrl",label:"Locations"}).state("subdivision",{url:"/divisions/:division/:subdivision",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:k,division:h},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("division",{url:"/divisions/:division",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:k,division:i},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("amenities",{url:"/amenities",templateUrl:"views/amenities.html",controller:"AmenitiesCtrl",label:"Amenities",resolve:{config:k,amenities:j},data:{crumbName:"Amenities"}}).state("amenity",{url:"/amenities/id/:amenity",templateUrl:"views/amenities.html",controller:"AmenityCtrl",label:"Amenities",resolve:{config:k,amenity:j},data:{parentState:"amenities",crumbName:"{{amenity.amenity.name}}"}}).state("amenities-at-location",{url:"/amenities/loc/:location",templateUrl:"views/amenitiesAtLibrary.html",controller:"AmenitiesAtLibraryCtrl",resolve:{config:k,location:g},data:{parentState:"amenities",crumbName:"{{location.name}}"}}).state("404",{url:"/404",templateUrl:"views/404.html"}).state("location",{url:"/:location",templateUrl:"views/location.html",controller:"LocationCtrl",resolve:{config:k,location:g},data:{crumbName:"{{location.name}}"}})}]),nypl_locations.run(["$analytics","$state","$rootScope","$location",function(a,b,c,d){c.$on("$stateChangeStart",function(){c.close_feedback=!0}),c.$on("$viewContentLoaded",function(){a.pageTrack("/locations"+d.path()),c.current_url=d.absUrl()}),c.$on("$stateChangeError",function(){b.go("404")})}]),nypl_locations.config(["$httpProvider",function(a){"use strict";var b,c=["$q","$injector","$location",function(a,c,d){function e(a){return b=b||c.get("$http"),b.pendingRequests.length<1&&(g=g||c.get("requestNotificationChannel"),g.requestEnded()),a}function f(e){var f=e.status;return b=b||c.get("$http"),b.pendingRequests.length<1&&(g=g||c.get("requestNotificationChannel"),g.requestEnded()),404===f?(d.path("/404"),a.reject(e)):a.reject(e)}var g;return function(a){return g=g||c.get("requestNotificationChannel"),g.requestStarted(),a.then(e,f)}}];a.responseInterceptors.push(c)}]);var nypl_widget=angular.module("nypl_widget",["ngSanitize","ui.router","locationService","nyplAlerts","coordinateService","angulartics","angulartics.google.analytics"]).config(["$locationProvider","$stateProvider","$urlRouterProvider","$nyplAlertsProvider",function(a,b,c,d){"use strict";function e(a,b,c){return c.singleLocation(a.location).then(function(a){return a.location})["catch"](function(a){throw a})}function f(a,b,c,d){var e=d.singleDivision(b.division),f=d.singleDivision(b.subdivision);return a.all([e,f]).then(function(a){var b=(a[0],a[1].division);return b})}function g(a,b,c){return c.singleDivision(a.division).then(function(a){return a.division})["catch"](function(a){throw a})}function h(a){return a.getConfig()}e.$inject=["$stateParams","config","nyplLocationsService"],f.$inject=["$q","$stateParams","config","nyplLocationsService"],g.$inject=["$stateParams","config","nyplLocationsService"],h.$inject=["nyplLocationsService"],a.html5Mode(!0),d.setOptions({api_root:locations_cfg.config.api_root,api_version:locations_cfg.config.api_version}),b.state("subdivision",{url:"/widget/divisions/:division/:subdivision",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:h,data:f}}).state("division",{url:"/widget/divisions/:division",templateUrl:"views/widget.html",controller:"WidgetCtrl",label:"Division",resolve:{config:h,data:g}}).state("widget",{url:"/widget/:location",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:h,data:e}})}]);!function(){"use strict";function a(a,b){var c=null,d={};return d.geolocationAvailable=function(){return b.navigator||b.navigator.geolocation?!0:!1},d.getBrowserCoordinates=function(){var d=a.defer();return this.geolocationAvailable()?b.navigator.geolocation.getCurrentPosition(function(a){c=a.coords,d.resolve(c)},function(a){switch(a.code){case a.PERMISSION_DENIED:d.reject(new Error("Permission denied."));break;case a.POSITION_UNAVAILABLE:d.reject(new Error("The position is currently unavailable."));break;case a.TIMEOUT:d.reject(new Error("The request timed out."));break;default:d.reject(new Error("Unknown error."))}},{enableHighAccuracy:!0,timeout:5e3,maximumAge:6e5}):d.reject(new Error("Your browser does not support Geolocation.")),d.promise},d.getDistance=function(a,b,c,d){if(!(a&&d&&c&&d))return void 0;var e,f=Math.PI*a/180,g=Math.PI*c/180,h=b-d,i=Math.PI*h/180;return e=Math.sin(f)*Math.sin(g)+Math.cos(f)*Math.cos(g)*Math.cos(i),e=Math.acos(e),e=180*e/Math.PI,e=60*e*1.1515,Math.ceil(100*e)/100},d}a.$inject=["$q","$window"],angular.module("coordinateService",[]).factory("nyplCoordinatesService",a)}(),function(){"use strict";function a(a,b){var c,d,e="?callback=JSON_CALLBACK",f="Could not reach API",g={};return g.getConfig=function(){var a=b.defer();return d?a.resolve(d):(d=window.locations_cfg.config,d?(c=d.api_root+"/"+d.api_version,a.resolve(d)):a.reject(f+": config")),a.promise},g.allLocations=function(){var d=b.defer();return a.jsonp(c+"/locations"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": locations")}),d.promise},g.singleLocation=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": location")}),g.promise},g.singleDivision=function(d){var g=b.defer();return a.jsonp(c+"/divisions/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": division")}),g.promise},g.amenities=function(d){var g=b.defer(),h=d?"/amenities/"+d:"/amenities";return a.jsonp(c+h+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": amenities")}),g.promise},g.amenitiesAtLibrary=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+"/amenities"+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": library-amenity")}),g.promise},g.alerts=function(){var d=b.defer();return a.jsonp(c+"/alerts"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": site-wide alerts")}),d.promise},g}a.$inject=["$http","$q"],angular.module("locationService",[]).factory("nyplLocationsService",a)}(),function(){"use strict";function a(a){function b(a){var b=a.split(":"),c=parseInt(b[0],10);return c}function c(a){var b=a.split(":"),c=(parseInt(b[0],10)+11)%12+1,d=b[1],e=b[0]>=12?"pm":"am";return c+":"+d+e}function d(c,d){var e,f,g,h,i,j;return d.length||(e=moment(d.applies.start),f=moment(d.applies.end),h=b(c.open),i=b(c.close),g=f.isAfter(e,"day")?!0:!1,j=g||alert.infinite===!0?"Closed *":e.hours()<=h&&f.hours()>=i?"Closed *":h<e.hours()&&i<=f.hours()?"Closing early *":i>f.hours()&&h>=e.hours()?"Opening late *":"Change in hours *"),a.trustAsHtml(j)}return function(a){var b,e=void 0!==a&&void 0!==a.today?a.today:a;return e?(b=e.alert||null,null===e.open?"Closed":b?d(e,b):c(e.open)+" - "+c(e.close)):(console.log("timeFormat() filter error: Argument is not defined or empty, verify API response for time"),"")}}function b(){return function(a){return new Date(a).toISOString()}}function c(){return function(a){return"string"==typeof a?a.replace(/(^|\s)([a-z])/g,function(a){return a.toUpperCase()}):a}}function d(){function a(a){return a=a.split(":"),_.object(["hours","mins","meridian","military"],[(parseInt(a[0],10)+11)%12+1,a[1],a[0]>=12?"pm":"am",parseInt(a[0],10)])}return function(b){var c,d,e,f,g,h,i,j=moment(),k=j.get("hour");return b?(e=b.today,f=b.tomorrow,e.open&&e.close?(e.open&&(c=a(e.open)),e.close&&(d=a(e.close)),null!==f.alert&&(i=f.alert.closed_for||null),null!==f.open&&(g=a(f.open)),null!==f.close&&(h=a(f.close)),k>=d.military?i?"Tomorrow: "+i:g&&h?"Open tomorrow "+g.hours+(0!==parseInt(g.mins,10)?":"+g.mins:"")+g.meridian+"-"+h.hours+(0!==parseInt(h.mins,10)?":"+h.mins:"")+h.meridian:"Closed today":k<c.military?"Open today "+c.hours+(0!==parseInt(c.mins,10)?":"+c.mins:"")+c.meridian+"-"+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian:"Open today until "+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian):(console.log("Obj is undefined for open/close properties"),"Closed today")):"Not available"}}function e(){return function(a,b,c){return"string"!=typeof a?a:a.length<200?a:(isNaN(b)&&(b=200),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c)}}a.$inject=["$sce"],angular.module("nypl_locations").filter("timeFormat",a).filter("dateToISO",b).filter("capitalize",c).filter("hoursTodayFormat",d).filter("truncate",e),angular.module("nypl_widget").filter("hoursTodayFormat",d)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){b.title=g.name,c.data=g,c.locinator_url="http://www.nypl.org/locations"+a.path().substr(7),c.widget_name=g.name,g._embedded.location&&(c.division=!0,c.data.images.exterior=g.images.interior),f.closed_img&&(c.data.images.closed=f.closed_img),g.hours&&(c.hoursToday=i.hoursToday(g.hours)),c.data.social_media=i.socialMediaColor(c.data.social_media),c.locationDest=i.getAddressString(g)}a.$inject=["$location","$rootScope","$scope","$timeout","$window","config","data","nyplCoordinatesService","nyplUtility"],angular.module("nypl_widget").controller("WidgetCtrl",a)}(),function(){"use strict";function a(a){return{restrict:"A",link:function(b,c){var d=function(){c.addClass("show")},e=function(){c.removeClass("show")};c.hasClass("show")&&c.removeClass("show"),a.onRequestStarted(b,d),a.onRequestEnded(b,e)}}}function b(a,b,c){return{restrict:"EA",replace:!1,templateUrl:"scripts/directives/templates/todaysHours.html",scope:{hours:"=hours",alerts:"=alerts"},link:function(b,c,d,e){var f={},g=b.hours||null;b.alerts&&(f.current_global=a.filterAlerts(b.alerts,{scope:"all",only_closings:"current"}),f.current_location=a.filterAlerts(b.alerts,{scope:"location",only_closings:"current"}),f.current_division=a.filterAlerts(b.alerts,{scope:"division",only_closings:"current"}),f.all_closings=a.filterAlerts(b.alerts,{only_closings:"week"})),b.todaysHours=e.computeHoursToday(g,f),b.showIcon="true"===d.displayIcon?!0:!1},controller:["$scope",function(){this.getAlertMsg=function(a){return"Today: "+_.chain(a).pluck("closed_for").flatten(!0).first().value()},this.getLocationHours=function(a,d){return c("hoursTodayFormat")(b.hoursToday(a,d))},this.computeHoursToday=function(a,b){return a?b?b.current_global&&b.current_global.length?this.getAlertMsg(b.current_global):b.current_location&&b.current_location.length?this.getAlertMsg(b.current_location):b.current_division&&b.current_division.length?this.getAlertMsg(b.current_division):this.getLocationHours(a,b):this.getLocationHours(a):"Not available"}}]}}function c(a){return{restrict:"EA",templateUrl:"scripts/directives/templates/hours-table.html",replace:!0,scope:{hours:"=hours",alerts:"=alerts"},link:function(b,c,d,e){var f,g,h=angular.copy(b.hours)||null;b.alerts&&(g=a.filterAlerts(b.alerts,{only_closings:"week"})),g&&g.length&&(f=a.sortAlertsByScope(g)),b.dynamicWeekHours=f?e.findAlertsInWeek(h,f):null,b.regularWeekHours=b.hours||null,b.buttonText=f?"Regular hours":null,b.dynamicWeekHours&&c.addClass("hide-regular-hours"),b.toggleHoursTable=function(){c.hasClass("hide-regular-hours")?(c.removeClass("hide-regular-hours"),c.addClass("hide-dynamic-hours"),b.buttonText="Upcoming hours"):c.hasClass("hide-dynamic-hours")&&(c.removeClass("hide-dynamic-hours"),c.addClass("hide-regular-hours"),b.buttonText="Regular hours")}},controller:["$scope",function(){this.findAlertsInWeek=function(a,b){if(!a&&!b)return null;var c=this,d=moment().day(),e=_.each(a,function(a,e){a.is_today=e===d?!0:!1,a.date=c.assignDynamicDate(e),a.alert=c.assignCurrentDayAlert(b,a.date)});return e},this.assignDynamicDate=function(a){var b,c=moment();return b=moment().weekday(a<c.weekday()?a+7:a)},this.assignCurrentDayAlert=function(a,b){var c,d;return _.find(a,function(a){if(a.applies.start&&a.applies.end){if(c=moment(a.applies.start),d=moment(a.applies.end),a.infinite=!1,b.isBetween(c,d))return a;if(b.date()===c.date()&&b.date()<=d.date())return a;if(b.date()>c.date()&&b.date()<d.date())return a}else if(a.applies.start&&!a.applies.end)return a.infinite=!0,a})}}]}}function d(){return{restrict:"E",templateUrl:"scripts/directives/templates/emailus.html",replace:!0,scope:{link:"@"}}}function e(a){return{restrict:"E",templateUrl:"scripts/directives/templates/librarianchat.html",replace:!0,link:function(b,c){b.openChat=function(){a.popupWindow("http://www.nypl.org/ask-librarian","NYPL Chat",210,450),c.hasClass("active")||c.addClass("active")}}}}function f(a){return function(b){b.$on("$stateChangeStart",function(){a.scrollTo(0,0)})}}function g(a){function b(a){var b=new Date(a),c=new Date;return b.getTime()>c.getTime()?!0:!1}return{restrict:"E",templateUrl:"scripts/directives/templates/registration.html",replace:!0,scope:{registration:"=",status:"=",link:"="},link:function(c){c.online=!1,c.registration&&(c.eventRegStarted=b(c.registration.start),"Online"===c.registration.type?(c.online=!0,c.reg_msg=c.eventRegStarted?"Online, opens "+a("date")(c.registration.start,"MM/dd"):"Online"):c.reg_msg=c.registration.type)}}}function h(){function a(a,b,c){var d=c.collapse,e=c.className||"open",f=c.duration||"fast";a.$eval(d)||b.hide(),a.$watch(d,function(a,c){a!==c&&(a?b.stop(!0,!0).slideDown(f).addClass(e):b.stop(!0,!0).slideUp(f).removeClass(e))})}return{link:a,restrict:"A"}}function i(a,b){return{restrict:"E",templateUrl:"scripts/directives/templates/fundraising.html",replace:!0,scope:{fundraising:"=fundraising",category:"@"},link:function(c){c.fundraising||a(function(){b.getConfig().then(function(a){var b=a.fundraising;c.fundraising={appeal:b.appeal,statement:b.statement,button_label:b.button_label,link:b.link}})},200)}}}function j(){return{restrict:"E",templateUrl:"scripts/directives/templates/sidebar-widgets.html",replace:!0,scope:{donateButton:"@",nyplAsk:"@"},link:function(a,b,c){var d="https://secure3.convio.net/nypl/site/SPageServer?pagename=donation_form&JServSessionIdr003=dwcz55yj27.app304a&s_src=FRQ14ZZ_SWBN";a.donateUrl=c.donateurl||d}}}function k(a){return{restrict:"E",templateUrl:"scripts/directives/templates/footer.html",replace:!0,scope:{},link:function(b,c){var d,e=c.find(".footerlinks a");e.click(function(){d=angular.element(this).attr("href"),a.eventTrack("Click",{category:"footer",label:d})})}}}function l(a,b){return{restrict:"AEC",templateUrl:"scripts/directives/templates/autofill.html",scope:{data:"=",model:"=ngModel",mapView:"&",geoSearch:"&"},link:function(c,d,e,f){function g(){c.$watch("model",function(a){f.updateSearchText(c.data,a)}),c.$on("$stateChangeSuccess",function(){f.resetSearchTerms(),f.closeAutofill()})}c.focused=!1,c.activated=!1,c.geocodingactive=!1,c.filtered=[],c.items,c.active,c.currentIndex;var h=angular.element(document.getElementById("searchTerm")),i=angular.element(document.getElementsByTagName("html"));h.bind("focus",function(){c.$apply(function(){f.openAutofill()})}),h.bind("click",function(a){a.stopPropagation()}),h.bind("keyup",function(d){13===d.keyCode&&c.$apply(function(){c.activated?c.active.slug?(c.activated=!1,f.closeAutofill(),c.model=c.active.name,a.go("location",{location:c.active.slug})):(c.geoSearch({term:c.model}),c.geocodingactive=!1,c.activated=!1,h.blur()&&f.closeAutofill()):f.setSearchText(c.model)?(c.model=c.items[0].name,f.closeAutofill(),b.eventTrack("Accept",{category:"Locations",label:c.model}),a.go("location",{location:c.items[0].slug})):(c.geoSearch({term:c.model}),h.blur()&&f.closeAutofill())}),39===d.keyCode&&c.$apply(function(){f.setSearchText(c.model)}),8===d.keyCode&&c.$apply(function(){c.lookahead=""}),27===d.keyCode}),h.bind("keydown",function(a){(9===a.keyCode||13===a.keyCode||27===a.keyCode)&&a.preventDefault(),38===a.keyCode&&(a.preventDefault(),c.$apply(function(){c.activated?f.activatePreviousItem():f.activateFirstItem()})),40===a.keyCode&&(a.preventDefault(),c.$apply(function(){c.activated?f.activateNextItem():f.activateFirstItem(),f.activateGeocodingItem()}))}),i.bind("click",function(){c.$apply(function(){f.closeAutofill()})}),g()},controller:["$scope",function(a){a.lookahead="",a.currentWord="",a.completeWord="",this.closeAutofill=function(){return a.focused=!1},this.openAutofill=function(){return a.focused=!0},this.activate=function(a){return a},this.activateFirstItem=function(){a.active=a.filtered[0],a.currentIndex=a.filtered.indexOf(a.active),a.activated=!0},this.activateNextItem=function(){a.geocodingactive=!1,a.currentIndex<a.filtered.length&&a.currentIndex>=0?(a.currentIndex=a.filtered.indexOf(a.active)+1,a.active=this.activate(a.filtered[a.currentIndex])):(a.active=void 0,a.currentIndex=-1)},this.activatePreviousItem=function(){a.geocodingactive=!1,-1===a.currentIndex?(a.currentIndex=a.filtered.length-1,a.active=this.activate(a.filtered[a.currentIndex])):a.currentIndex<=a.filtered.length&&a.currentIndex>0&&(a.currentIndex=a.currentIndex-1,a.active=this.activate(a.filtered[a.currentIndex]))},this.activateGeocodingItem=function(){!a.active&&a.activated&&(a.active=this.activate(a.model),a.geocodingactive=!0)},this.setSearchText=function(){return a.completeWord!==a.model&&""!==a.completeWord&&""!==a.model?a.model=a.completeWord:void 0},this.resetSearchTerms=function(){a.lookahead="",a.currentWord=""},this.filterStartsWith=function(a,b){return _.filter(a,function(a){return a.name?a.name.substring(0,b.length).toLowerCase()===b.toLowerCase():!1})},this.filterTermWithin=function(a,b){return _.filter(a,function(a){return a.name?a.name.toLowerCase().indexOf(b.toLowerCase())>=0:!1})},this.updateSearchText=function(b,c){return""!==c&&c&&b&&c.length>1?(a.items=this.filterStartsWith(b,c),a.filtered=this.filterTermWithin(b,c),a.items[0]?(a.lookahead=a.items[0].name.substring(c.length),a.currentWord=c):this.resetSearchTerms(),a.completeWord=a.currentWord+a.lookahead):void 0}}]}}a.$inject=["requestNotificationChannel"],b.$inject=["nyplAlertsService","nyplUtility","$filter"],c.$inject=["nyplAlertsService"],e.$inject=["nyplUtility"],f.$inject=["$window"],g.$inject=["$filter"],i.$inject=["$timeout","nyplLocationsService"],k.$inject=["$analytics"],l.$inject=["$state","$analytics"],angular.module("nypl_locations").directive("loadingWidget",a).directive("todayshours",b).directive("hoursTable",c).directive("emailusbutton",d).directive("librarianchatbutton",e).directive("scrolltop",f).directive("eventRegistration",g).directive("nyplFundraising",i).directive("nyplSidebar",j).directive("nyplAutofill",l).directive("collapse",h).directive("nyplFooter",k),angular.module("nypl_widget").directive("todayshours",b).directive("nyplFundraising",i).directive("librarianchatbutton",e).directive("emailusbutton",d)}(),function(a,b,c){"use strict";function d(){var a={url_undefined:"$nyplAlerts: API URL could not be defined",api:"$nyplAlerts: Alerts API could not retrieve data"},d={api_root:null,api_version:null};this.setOptions=function(a){b.extend(d,a)},this.$get=["$http","$q",function(b,e){var f={};return f.generateApiUrl=function(a,b){if(!a||!b)return c;var d="?callback=JSON_CALLBACK",e=a+"/"+b+"/alerts"+d;return 0===a.indexOf("http://")||0===a.indexOf("https://")?e:"http://"+e},f.getGlobalAlerts=function(){var c=e.defer(),f=this.generateApiUrl(d.api_root,d.api_version);return f?b.jsonp(f,{cache:!0}).success(function(a){c.resolve(a.alerts)}).error(function(){c.reject(a.api)}):c.reject(a.url_undefined),c.promise},f.alerts=null,f.api_url=d.api_root||null,f.api_version=d.api_version||null,f}]}function e(){var a={};return a.currentAlerts=function(a){var b,c,d=moment();return _.filter(a,function(a){return a.display&&a.display.start&&a.display.end&&(b=moment(a.display.start),c=moment(a.display.end),b.valueOf()<=d.valueOf()&&c.valueOf()>=d.valueOf())?a:void 0})},a.currentClosingAlerts=function(a){var b,c,d=moment();return _.filter(a,function(a){if(a.applies)if(a.applies.start&&a.applies.end){if(b=moment(a.applies.start),c=moment(a.applies.end),b.valueOf()<=d.valueOf()&&c.valueOf()>=d.valueOf())return a;if(d.day()===b.day()&&c.day()===d.day()&&c.valueOf()>=d.valueOf())return a}else if(a.applies.start&&(b=moment(a.applies.start),b.valueOf()<=d.valueOf()))return a})},a.currentWeekClosingAlerts=function(a){var b,c=moment().startOf("day"),d=moment().add(7,"days").startOf("day");return _.filter(a,function(a){if(a.applies&&a.applies.start){if(b=moment(a.applies.start),d.valueOf()>=b.valueOf()&&c.valueOf()<=b.valueOf())return a;if(c.valueOf()>=b.valueOf())return a}})},a.allClosingAlerts=function(a){return a?_.filter(a,function(a){return a.applies&&a.applies.start?a:void 0}):void 0},a.sortAlertsByScope=function(a){return a?_.chain(a).sortBy(function(a){return"all"===a.scope.toLowerCase()}).sortBy(function(a){return"location"===a.scope.toLowerCase()}).sortBy(function(a){return"division"===a.scope.toLowerCase()}).value():void 0},a.removeDuplicates=function(a){return a?_.chain(a).indexBy("id").flatten().uniq(function(a){return a.msg?a.msg.toLowerCase():void 0}).value():void 0},a.isAlertExpired=function(a,b){if(a&&b){var c=moment(a),d=moment(b),e=moment();return c.valueOf()<=e.valueOf()&&d.valueOf()>=e.valueOf()?!1:!0}},a.filterAlerts=function(a,b){if(a){var c=this.removeDuplicates(a),d={scope:b?b.scope||null:null,current:b?b.current||!1:!1,only_closings:b?b.only_closings||!1:!1};return d.scope&&(c=_.where(c,{scope:d.scope})),"all"===d.only_closings?c=this.allClosingAlerts(c):"current"===d.only_closings?c=this.currentClosingAlerts(c):"week"===d.only_closings?c=this.currentWeekClosingAlerts(c):(d.current===!0&&(c=this.currentAlerts(c)),c)}},a.getHoursOrMessage=function(a){if(a&&a.closedFn){var b=a.message||"",d=a.open||!1,e=a.hours||c,f=a.hoursFn,g=a.closedFn;return d?b?b:f(e):g()}},a.activeClosings=function(a){var b=this.filterAlerts(a,{only_closings:"current"});return b&&b.length?!0:!1},a.getCurrentActiveMessage=function(a){if(a){var b=this.filterAlerts(a,{only_closings:"current"}),c=_.chain(b).pluck("closed_for").first().value();return c}},a}function f(){return{restrict:"E",template:"<div class='nypl-global-alerts' data-ng-if='$root.alerts.length'><div data-ng-repeat='alert in $root.alerts'><p data-ng-bind-html='alert.msg'></p></div></div>",replace:!0,scope:!1}}function g(a){return{restrict:"E",template:"<div class='nypl-location-alerts'data-ng-if='locationAlerts.length'><div data-ng-repeat='alert in locationAlerts'><p data-ng-bind-html='alert.msg'></p></div></div>",replace:!0,scope:{alerts:"=alerts",type:"@"},link:function(b){b.alerts&&b.type.length&&(b.locationAlerts=a.filterAlerts(b.alerts,{scope:b.type,current:!0}))}}}function h(a,b,c){a.getGlobalAlerts().then(function(d){var e=b.alerts||d;b.alerts=c.filterAlerts(e,{current:!0}),a.alerts=b.alerts||d})["catch"](function(a){throw a})}f.$inject=["$rootScope"],g.$inject=["nyplAlertsService"],h.$inject=["$nyplAlerts","$rootScope","nyplAlertsService"],b.module("nyplAlerts",["ngSanitize"]).provider("$nyplAlerts",d).service("nyplAlertsService",e).run(h).directive("nyplLocationAlerts",g).directive("nyplGlobalAlerts",f)}(window,window.angular),function(){"use strict";function a(a){var b="_START_REQUEST_",c="_END_REQUEST_",d={};return d.requestStarted=function(){a.$broadcast(b)},d.requestEnded=function(){a.$broadcast(c)},d.onRequestStarted=function(a,c){a.$on(b,function(a){c(a)})},d.onRequestEnded=function(a,b){a.$on(c,function(a){b(a)})},d}function b(a,b,c){var d={};return d.hoursToday=function(a,b){var c,d,e,f,g=moment().day(),h=moment().add(1,"days").startOf("day");return b&&b.all_closings&&b.all_closings.length&&(d=b.all_closings),a&&(d&&d.length&&(f=_.find(d,function(a){return a.applies?(e=moment(a.applies.start),"all"===a.scope&&e.isSame(h,"day")?a:"location"===a.scope&&e.isSame(h,"day")?a:"division"===a.scope&&e.isSame(h,"day")):void 0})),c={today:{day:a.regular[g].day,open:a.regular[g].open,close:a.regular[g].close},tomorrow:{day:a.regular[h.day()%7].day,open:a.regular[h.day()%7].open,close:a.regular[h.day()%7].close,alert:f||null}}),c},d.formatDate=function(a,b){var c,d=["January","February","March","April","May","June","July","August","September","October","November","December"];if(this.numDaysFromToday=function(a,b){return Math.round((a.valueOf()-b.valueOf())/1e3/86400-.5)},a&&b){var e=new Date(a),f=new Date(b),g=new Date,h=this.numDaysFromToday(f,g);if(!h)return;c=365>=h?e.getTime()<=g.getTime()&&f.getTime()>=g.getTime()?"Now through "+d[f.getUTCMonth()]+" "+f.getUTCDate()+", "+f.getUTCFullYear():e.getTime()>g.getTime()&&f.getTime()>=g.getTime()?"Opening "+d[e.getUTCMonth()]+" "+e.getUTCDate()+", "+e.getUTCFullYear():d[e.getUTCMonth()]+" "+e.getUTCDate()+", "+e.getUTCFullYear()+" through "+d[f.getUTCMonth()]+" "+f.getUTCDate()+", "+f.getUTCFullYear():"Ongoing"}return c},d.branchException=function(a){var b={};if(a){if(!a.exceptions)return null;if(""!==a.exceptions.description.trim())return b.desc=a.exceptions.description,a.exceptions.start&&(b.start=a.exceptions.start),a.exceptions.end&&(b.end=a.exceptions.end),b}return null},d.getAddressString=function(a,b){if(!a)return"";var c=" ",d=a.name;return b&&(c="<br />",d="<a href='/locations/"+a.slug+"'>"+a.name+"</a>"),d+c+a.street_address+c+a.locality+", "+a.region+", "+a.postal_code},d.socialMediaColor=function(a){return _.each(a,function(a){switch(a.classes="icon-",a.site){case"facebook":a.classes+=a.site+" blueDarkerText";break;case"foursquare":a.classes+=a.site+" blueText";break;case"instagram":a.classes+=a.site+" blackText";break;case"twitter":a.classes+=a.site+"2 blueText";break;case"tumblr":a.classes+=a.site+"2 indigoText";break;case"youtube":case"pinterest":a.classes+=a.site+" redText";break;default:a.classes+=a.site}}),a},d.popupWindow=function(a,c,d,e){var f,g,h,i,j;a&&(f=void 0===d?"300":"string"==typeof d||d instanceof String?d:d.toString(),g=void 0===e?"500":"string"==typeof d||d instanceof String?e:e.toString(),a&&c?h=b.open(a,c,"menubar=1,resizable=1,width="+f+",height="+g):a&&(h=b.open(a,"","menubar=1,resizable=1,width="+f+",height="+g)),h&&(j=parseInt(f,10),i=parseInt(g,10),h.moveTo(screen.width/2-j/2,screen.height/2-i/2)))},d.calendarLink=function(a,b,c){if(!a||!b||!c)return"";var d=b.title,e=b.start.replace(/[\-:]/g,""),f=b.end.replace(/[\-:]/g,""),g=b.body,h=b._links.self.href,i=c.name+" - "+c.street_address+" "+c.locality+", "+c.region+" "+c.postal_code,j="";switch(a){case"google":j="https://www.google.com/calendar/render?action=template&text="+d+"&dates="+e+"/"+f+"&details="+g+"&location="+i+"&pli=1&uid=&sf=true&output=xml";break;case"yahoo":j="https://calendar.yahoo.com/?v=60&TITLE="+d+"&ST="+e+"&in_loc="+i+"&in_st="+i+"&DESC="+g+"&URL="+h}return j},d.icalLink=function(a,c){if(!a||!c)return"";var d=(new Date).toJSON().toString().replace(/[\-.:]/g,""),e="http://nypl.org/"+a._links.self.href,f="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NYPL//NONSGML v1.0//EN\nMETHOD:PUBLISH\nBEGIN:VEVENT\nUID:"+(new Date).getTime()+"\nDTSTAMP:"+d+"\nATTENDEE;CN=My Self ;\nORGANIZER;CN=NYPL:\nDTSTART:"+a.start.replace(/[\-:]/g,"")+"\nDTEND:"+a.end.replace(/[\-:]/g,"")+"\nLOCATION:"+c+"\nDESCRIPTION:"+a.body+"\nURL;VALUE=URI:"+e+"\nSUMMARY:"+a.title+"\nEND:VEVENT\nEND:VCALENDAR",g="data:text/calendar;chartset=utf-8,"+encodeURI(f);return b.open(g),g},d.calcDistance=function(a,b){if(!a)return[];var d={latitude:b.latitude||b.lat,longitude:b.longitude||b["long"]};return _.each(a,function(a){var b,e,f=[];a.geolocation&&a.geolocation.coordinates&&(f=a.geolocation.coordinates),b=a.lat||f[1],e=a["long"]||f[0],a.distance=c.getDistance(d.latitude,d.longitude,b,e)}),a},d.checkDistance=function(a){var b=_.pluck(a,"distance");return _.min(b)>25?!0:!1},d.returnHTML=function(b){return a.trustAsHtml(b)},d.divisionHasAppointment=function(a,b){return _.contains(a,b)},d.researchLibraryOrder=function(a,b){return _.indexOf(a,b)},d}a.$inject=["$rootScope"],b.$inject=["$sce","$window","nyplCoordinatesService"],angular.module("nypl_locations").factory("nyplUtility",b).factory("requestNotificationChannel",a),angular.module("nypl_widget").factory("nyplUtility",b).factory("requestNotificationChannel",a)}();