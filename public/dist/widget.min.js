/*!
 __                                            __    
/\ \                      __                  /\ \__
\ \ \        ___     ___ /\_\    ___      __  \ \ ,_\   ___   _ __
 \ \ \  __  / __`\  /'___\/\ \ /' _ `\  /'__`\ \ \ \/  / __`\/\`'__\
  \ \ \_\ \/\ \_\ \/\ \__/\ \ \/\ \/\ \/\ \_\.\_\ \ \_/\ \_\ \ \ \/ 
   \ \____/\ \____/\ \____\\ \_\ \_\ \_\ \__/.\_\\ \__\ \____/\ \_\ 
    \/___/  \/___/  \/____/ \/_/\/_/\/_/\/__/\/_/ \/__/\/___/  \/_/ 
*/
!function(){"use strict";function nyplCoordinatesService($q,$window){var geoCoords=null,coordinatesService={};return coordinatesService.geolocationAvailable=function(){return $window.navigator||$window.navigator.geolocation?!0:!1},coordinatesService.getBrowserCoordinates=function(){var defer=$q.defer();return this.geolocationAvailable()?$window.navigator.geolocation.getCurrentPosition(function(position){geoCoords=position.coords,defer.resolve(geoCoords)},function(error){switch(error.code){case error.PERMISSION_DENIED:defer.reject(new Error("Permission denied."));break;case error.POSITION_UNAVAILABLE:defer.reject(new Error("The position is currently unavailable."));break;case error.TIMEOUT:defer.reject(new Error("The request timed out."));break;default:defer.reject(new Error("Unknown error."))}},{enableHighAccuracy:!0,timeout:5e3,maximumAge:6e5}):defer.reject(new Error("Your browser does not support Geolocation.")),defer.promise},coordinatesService.getDistance=function(lat1,lon1,lat2,lon2){if(!(lat1&&lon2&&lat2&&lon2))return void 0;var distance,radlat1=Math.PI*lat1/180,radlat2=Math.PI*lat2/180,theta=lon1-lon2,radtheta=Math.PI*theta/180;return distance=Math.sin(radlat1)*Math.sin(radlat2)+Math.cos(radlat1)*Math.cos(radlat2)*Math.cos(radtheta),distance=Math.acos(distance),distance=180*distance/Math.PI,distance=60*distance*1.1515,Math.ceil(100*distance)/100},coordinatesService}nyplCoordinatesService.$inject=["$q","$window"],angular.module("coordinateService",[]).factory("nyplCoordinatesService",nyplCoordinatesService)}(),function(){"use strict";function nyplLocationsService($http,$q){var api,config,apiError="Could not reach API",locationsApi={};return locationsApi.getConfig=function(){var defer=$q.defer();return config?defer.resolve(config):$http.get("/config",{cache:!0}).success(function(data){api=data.config.api_root,config=data.config,defer.resolve(config)}).error(function(){defer.reject(apiError+": config")}),defer.promise},locationsApi.allLocations=function(){var defer=$q.defer();return $http.jsonp(api+"/locations?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": locations")}),defer.promise},locationsApi.singleLocation=function(location){var defer=$q.defer();return $http.jsonp(api+"/locations/"+location+"?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": location")}),defer.promise},locationsApi.singleDivision=function(division){var defer=$q.defer();return $http.jsonp(api+"/divisions/"+division+"?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": division")}),defer.promise},locationsApi.amenities=function(amenity){var defer=$q.defer(),url=amenity?"/amenities/"+amenity:"/amenities";return $http.jsonp(api+url+"?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": amenities")}),defer.promise},locationsApi.amenitiesAtLibrary=function(location){var defer=$q.defer();return $http.jsonp(api+"/locations/"+location+"/amenities?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": library-amenity")}),defer.promise},locationsApi.alerts=function(){var defer=$q.defer();return $http.jsonp(api+"/alerts?callback=JSON_CALLBACK",{cache:!0}).success(function(data){defer.resolve(data)}).error(function(){defer.reject(apiError+": site-wide alerts")}),defer.promise},locationsApi}nyplLocationsService.$inject=["$http","$q"],angular.module("locationService",[]).factory("nyplLocationsService",nyplLocationsService)}();var nypl_locations=angular.module("nypl_locations",["ngSanitize","ui.router","ngAnimate","locationService","coordinateService","nyplFeedback","nyplSearch","nyplSSO","nyplNavigation","nyplBreadcrumbs","angulartics","angulartics.google.analytics","pascalprecht.translate"]);nypl_locations.constant("_",window._),nypl_locations.config(["$locationProvider","$translateProvider","$stateProvider","$urlRouterProvider","$crumbProvider",function($locationProvider,$translateProvider,$stateProvider,$urlRouterProvider,$crumbProvider){"use strict";function LoadLocation($stateParams,config,nyplLocationsService){return nyplLocationsService.singleLocation($stateParams.location).then(function(data){return data.location}).catch(function(err){throw err})}function LoadSubDivision($q,$stateParams,config,nyplLocationsService){var division=nyplLocationsService.singleDivision($stateParams.division),subdivision=nyplLocationsService.singleDivision($stateParams.subdivision);return $q.all([division,subdivision]).then(function(data){var subdiv=(data[0],data[1].division);return subdiv})}function LoadDivision($stateParams,config,nyplLocationsService){return nyplLocationsService.singleDivision($stateParams.division).then(function(data){return data.division}).catch(function(err){throw err})}function Amenities($stateParams,config,nyplLocationsService){return nyplLocationsService.amenities($stateParams.amenity).then(function(data){return data}).catch(function(error){throw error})}function getConfig(nyplLocationsService){return nyplLocationsService.getConfig()}$locationProvider.html5Mode(!0),$translateProvider.useStaticFilesLoader({prefix:"/languages/",suffix:".json"}),$translateProvider.preferredLanguage("en"),LoadLocation.$inject=["$stateParams","config","nyplLocationsService"],LoadSubDivision.$inject=["$q","$stateParams","config","nyplLocationsService"],LoadDivision.$inject=["$stateParams","config","nyplLocationsService"],Amenities.$inject=["$stateParams","config","nyplLocationsService"],getConfig.$inject=["nyplLocationsService"],$crumbProvider.setOptions({primaryState:{name:"Home",customUrl:"http://nypl.org"},secondaryState:{name:"Locations",customUrl:"home.index"}}),$urlRouterProvider.rule(function($injector,$location){var path=$location.url();return"/"===path[path.length-1]?path.slice(0,-1):void 0}),$stateProvider.state("home",{url:"/","abstract":!0,templateUrl:"views/locations.html",controller:"LocationsCtrl",label:"Locations",resolve:{config:getConfig}}).state("home.index",{templateUrl:"views/location-list-view.html",url:"",label:"Locations"}).state("home.list",{templateUrl:"views/location-list-view.html",url:"list",label:"Locations"}).state("home.map",{templateUrl:"views/location-map-view.html",url:"map",controller:"MapCtrl",label:"Locations"}).state("subdivision",{url:"/divisions/:division/:subdivision",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:getConfig,division:LoadSubDivision},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("division",{url:"/divisions/:division",templateUrl:"views/division.html",controller:"DivisionCtrl",label:"Division",resolve:{config:getConfig,division:LoadDivision},data:{parentState:"location",crumbName:"{{division.name}}"}}).state("amenities",{url:"/amenities",templateUrl:"/views/amenities.html",controller:"AmenitiesCtrl",label:"Amenities",resolve:{config:getConfig,amenities:Amenities},data:{crumbName:"Amenities"}}).state("amenity",{url:"/amenities/id/:amenity",templateUrl:"views/amenities.html",controller:"AmenityCtrl",label:"Amenities",resolve:{config:getConfig,amenity:Amenities},data:{parentState:"amenities",crumbName:"{{amenity.amenity.name}}"}}).state("amenities-at-location",{url:"/amenities/loc/:location",templateUrl:"views/amenitiesAtLibrary.html",controller:"AmenitiesAtLibraryCtrl",resolve:{config:getConfig,location:LoadLocation},data:{parentState:"amenities",crumbName:"{{location.name}}"}}).state("404",{url:"/404",templateUrl:"views/404.html"}).state("location",{url:"/:location",templateUrl:"views/location.html",controller:"LocationCtrl",resolve:{config:getConfig,location:LoadLocation},data:{crumbName:"{{location.name}}"}})}]),nypl_locations.run(["$state","$rootScope","$location",function($state,$rootScope,$location){$rootScope.$on("$stateChangeStart",function(){$rootScope.close_feedback=!0}),$rootScope.$on("$stateChangeSuccess",function(){$rootScope.current_url=$location.absUrl()}),$rootScope.$on("$stateChangeError",function(){$state.go("404")})}]),nypl_locations.config(["$httpProvider",function($httpProvider){"use strict";var $http,interceptor=["$q","$injector","$location",function($q,$injector,$location){function success(response){return $http=$http||$injector.get("$http"),$http.pendingRequests.length<1&&(notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestEnded()),response}function error(response){var status=response.status;return $http=$http||$injector.get("$http"),$http.pendingRequests.length<1&&(notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestEnded()),404===status?($location.path("/404"),$q.reject(response)):$q.reject(response)}var notificationChannel;return function(promise){return notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestStarted(),promise.then(success,error)}}];$httpProvider.responseInterceptors.push(interceptor)}]),angular.module("nypl_widget",["ngSanitize","ui.router","locationService","coordinateService","angulartics","angulartics.google.analytics"]).config(["$locationProvider","$stateProvider","$urlRouterProvider",function($locationProvider,$stateProvider){"use strict";function LoadLocation($stateParams,config,nyplLocationsService){return nyplLocationsService.singleLocation($stateParams.location).then(function(data){return data.location}).catch(function(err){throw err})}function LoadSubDivision($q,$stateParams,config,nyplLocationsService){var division=nyplLocationsService.singleDivision($stateParams.division),subdivision=nyplLocationsService.singleDivision($stateParams.subdivision);return $q.all([division,subdivision]).then(function(data){var subdiv=(data[0],data[1].division);return subdiv})}function LoadDivision($stateParams,config,nyplLocationsService){return nyplLocationsService.singleDivision($stateParams.division).then(function(data){return data.division}).catch(function(err){throw err})}function getConfig(nyplLocationsService){return nyplLocationsService.getConfig()}LoadLocation.$inject=["$stateParams","config","nyplLocationsService"],LoadSubDivision.$inject=["$q","$stateParams","config","nyplLocationsService"],LoadDivision.$inject=["$stateParams","config","nyplLocationsService"],getConfig.$inject=["nyplLocationsService"],$locationProvider.html5Mode(!0),$stateProvider.state("subdivision",{url:"/widget/divisions/:division/:subdivision",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:getConfig,data:LoadSubDivision}}).state("division",{url:"/widget/divisions/:division",templateUrl:"views/widget.html",controller:"WidgetCtrl",label:"Division",resolve:{config:getConfig,data:LoadDivision}}).state("widget",{url:"/widget/:location",templateUrl:"views/widget.html",controller:"WidgetCtrl",resolve:{config:getConfig,data:LoadLocation}})}]),function(){"use strict";function timeFormat(){function clockTime(time){var components=time.split(":"),hours=(parseInt(components[0],10)+11)%12+1,minutes=components[1],meridiem=components[0]>=12?"pm":"am";return hours+":"+minutes+meridiem}return function(timeObj){var time=void 0!==timeObj&&void 0!==timeObj.today?timeObj.today:timeObj;return time?null===time.open?"Closed":clockTime(time.open)+" - "+clockTime(time.close):(console.log("timeFormat() filter function error: Argument is not defined or empty, verify API response for time"),"")}}function dateToISO(){return function(input){return new Date(input).toISOString()}}function capitalize(){return function(input){return"string"==typeof input?input.replace(/(^|\s)([a-z])/g,function(str){return str.toUpperCase()}):input}}function hoursTodayFormat(){function getHoursObject(time){return time=time.split(":"),_.object(["hours","mins","meridian","military"],[(parseInt(time[0],10)+11)%12+1,time[1],time[0]>=12?"pm":"am",time[0]])}return function(elem,type){var open_time,closed_time,formatted_time,today,tomorrow,tomorrow_open_time,tomorrow_close_time,now=new Date,hour_now_military=now.getHours();if(elem){if(today=elem.today,tomorrow=elem.tomorrow,today.open&&(open_time=getHoursObject(today.open)),today.close&&(closed_time=getHoursObject(today.close)),!today.open||!today.close)return console.log("Returned object is undefined for open/closed elems"),"Closed today";if(null!==tomorrow.open&&(tomorrow_open_time=getHoursObject(tomorrow.open)),null!==tomorrow.close&&(tomorrow_close_time=getHoursObject(tomorrow.close)),hour_now_military>=closed_time.military)return tomorrow_open_time||tomorrow_close_time?"Open tomorrow "+tomorrow_open_time.hours+(0!==parseInt(tomorrow_open_time.mins,10)?":"+tomorrow_open_time.mins:"")+tomorrow_open_time.meridian+"-"+tomorrow_close_time.hours+(0!==parseInt(tomorrow_close_time.mins,10)?":"+tomorrow_close_time.mins:"")+tomorrow_close_time.meridian:"Closed today";switch(tomorrow_open_time&&hour_now_military>=0&&hour_now_military<tomorrow_open_time.military&&(type="long"),type){case"short":formatted_time="Open today until "+closed_time.hours+(0!==parseInt(closed_time.mins,10)?":"+closed_time.mins:"")+closed_time.meridian;break;case"long":formatted_time="Open today "+open_time.hours+(0!==parseInt(open_time.mins,10)?":"+open_time.mins:"")+open_time.meridian+"-"+closed_time.hours+(0!==parseInt(closed_time.mins,10)?":"+closed_time.mins:"")+closed_time.meridian;break;default:formatted_time=open_time.hours+":"+open_time.mins+open_time.meridian+"-"+closed_time.hours+":"+closed_time.mins+closed_time.meridian}return formatted_time}return"Not available"}}function truncate(){return function(text,length,end){return"string"!=typeof text?text:text.length<200?text:(isNaN(length)&&(length=200),void 0===end&&(end="..."),text.length<=length||text.length-end.length<=length?text:String(text).substring(0,length-end.length)+end)}}angular.module("nypl_locations").filter("timeFormat",timeFormat).filter("dateToISO",dateToISO).filter("capitalize",capitalize).filter("hoursTodayFormat",hoursTodayFormat).filter("truncate",truncate),angular.module("nypl_widget").filter("hoursTodayFormat",hoursTodayFormat)}(),function(){"use strict";function WidgetCtrl($location,$rootScope,$scope,$timeout,$window,config,data,nyplCoordinatesService,nyplUtility){config.self;$rootScope.title=data.name,$scope.data=data,$scope.locinator_url="http://locations-beta.nypl.org"+$location.path().substr(7),$scope.widget_name=data.name,data._embedded.location&&($scope.division=!0,$scope.data.images.exterior=data.images.interior),config.closed_img&&($scope.data.images.closed=config.closed_img),data.hours&&($scope.hoursToday=nyplUtility.hoursToday(data.hours)),$scope.data.social_media=nyplUtility.socialMediaColor($scope.data.social_media),$scope.locationDest=nyplUtility.getAddressString(data)}WidgetCtrl.$inject=["$location","$rootScope","$scope","$timeout","$window","config","data","nyplCoordinatesService","nyplUtility"],angular.module("nypl_widget").controller("WidgetCtrl",WidgetCtrl)}(),function(){"use strict";function loadingWidget(requestNotificationChannel){return{restrict:"A",link:function(scope,element){var startRequestHandler=function(){element.addClass("show")},endRequestHandler=function(){element.removeClass("show")};element.hasClass("show")&&element.removeClass("show"),requestNotificationChannel.onRequestStarted(scope,startRequestHandler),requestNotificationChannel.onRequestEnded(scope,endRequestHandler)}}}function nyplTranslate(){return{restrict:"E",templateUrl:"scripts/directives/templates/translatebuttons.html",replace:!0,controller:function($scope,$translate){$scope.translate=function(language){$translate.use(language)}}}}function todayshours(){return{restrict:"E",templateUrl:"scripts/directives/templates/todaysHours.html",replace:!0,scope:{hours:"@"}}}function emailusbutton(){return{restrict:"E",templateUrl:"scripts/directives/templates/emailus.html",replace:!0,scope:{link:"@"}}}function librarianchatbutton(nyplUtility){return{restrict:"E",templateUrl:"scripts/directives/templates/librarianchat.html",replace:!0,link:function(scope,element){scope.openChat=function(){nyplUtility.popupWindow("http://www.nypl.org/ask-librarian","NYPL Chat",210,450),element.hasClass("active")||element.addClass("active")}}}}function scrolltop($window){return function(scope){scope.$on("$stateChangeStart",function(){$window.scrollTo(0,0)})}}function eventRegistration($filter){function eventStarted(startDate){var sDate=new Date(startDate),today=new Date;return sDate.getTime()>today.getTime()?!0:!1}return{restrict:"E",templateUrl:"scripts/directives/templates/registration.html",replace:!0,scope:{registration:"=",status:"=",link:"="},link:function(scope){scope.online=!1,scope.registration&&(scope.eventRegStarted=eventStarted(scope.registration.start),"Online"==scope.registration.type?(scope.online=!0,scope.reg_msg=scope.eventRegStarted?"Online, opens "+$filter("date")(scope.registration.start,"MM/dd"):"Online"):scope.reg_msg=scope.registration.type)}}}function nyplSiteAlerts($timeout,nyplLocationsService,nyplUtility){return{restrict:"E",templateUrl:"scripts/directives/templates/alerts.html",replace:!0,link:function(scope){var alerts;$timeout(function(){nyplLocationsService.alerts().then(function(data){alerts=data.alerts,scope.sitewidealert=nyplUtility.alerts(alerts)})},200)}}}function nyplLibraryAlert(){function alertExpired(startDate,endDate){var sDate=new Date(startDate),eDate=new Date(endDate),today=new Date;return sDate.getTime()<=today.getTime()&&eDate.getTime()>=today.getTime()?!1:!0}return{restrict:"E",templateUrl:"scripts/directives/templates/library-alert.html",replace:!0,scope:{exception:"="},link:function(scope){scope.exception&&(scope.alertExpired=alertExpired(scope.exception.start,scope.exception.end),""!==scope.exception.description&&scope.alertExpired===!1&&(scope.libraryAlert=scope.exception.description))}}}function collapse(){function link($scope,element,attributes){var exp=attributes.collapse,class_name=attributes.className||"open",duration=attributes.duration||"fast";$scope.$eval(exp)||element.hide(),$scope.$watch(exp,function(newVal,oldVal){newVal!==oldVal&&(newVal?element.stop(!0,!0).slideDown(duration).addClass(class_name):element.stop(!0,!0).slideUp(duration).removeClass(class_name))})}return{link:link,restrict:"A"}}function nyplFundraising($timeout,nyplLocationsService){return{restrict:"E",templateUrl:"scripts/directives/templates/fundraising.html",replace:!0,scope:{fundraising:"=fundraising",category:"@"},link:function(scope){scope.fundraising||$timeout(function(){nyplLocationsService.getConfig().then(function(data){var fundraising=data.fundraising;scope.fundraising={appeal:fundraising.appeal,statement:fundraising.statement,button_label:fundraising.button_label,link:fundraising.link}})},200)}}}function nyplSidebar(){return{restrict:"E",templateUrl:"scripts/directives/templates/sidebar-widgets.html",replace:!0,scope:{donateButton:"@",nyplAsk:"@"},link:function(scope,elem,attrs){var url="https://secure3.convio.net/nypl/site/SPageServer?pagename=donation_form&JServSessionIdr003=dwcz55yj27.app304a&s_src=FRQ14ZZ_SWBN";scope.donateUrl=attrs.donateurl||url}}}function nyplAutofill($state,$analytics){return{restrict:"AEC",templateUrl:"scripts/directives/templates/autofill.html",scope:{data:"=",model:"=ngModel",mapView:"&",geoSearch:"&"},link:function($scope,elem,attrs,controller){function initAutofill(){$scope.$watch("model",function(newValue){controller.updateSearchText($scope.data,newValue)}),$scope.$on("$stateChangeSuccess",function(){controller.resetSearchTerms(),controller.closeAutofill()})}$scope.focused=!1,$scope.activated=!1,$scope.geocodingactive=!1,$scope.filtered=[],$scope.items,$scope.active,$scope.currentIndex;var input=angular.element(document.getElementById("searchTerm")),html=angular.element(document.getElementsByTagName("html"));input.bind("focus",function(){$scope.$apply(function(){controller.openAutofill()})}),input.bind("click",function(e){e.stopPropagation()}),input.bind("keyup",function(e){13===e.keyCode&&$scope.$apply(function(){$scope.activated?$scope.active.slug?($scope.activated=!1,controller.closeAutofill(),$scope.model=$scope.active.name,$state.go("location",{location:$scope.active.slug})):($scope.geoSearch({term:$scope.model}),$scope.geocodingactive=!1,$scope.activated=!1,input.blur()&&controller.closeAutofill()):controller.setSearchText($scope.model)?($scope.model=$scope.items[0].name,controller.closeAutofill(),$analytics.eventTrack("Accept",{category:"Locations",label:$scope.model}),$state.go("location",{location:$scope.items[0].slug})):($scope.geoSearch({term:$scope.model}),input.blur()&&controller.closeAutofill())}),39===e.keyCode&&$scope.$apply(function(){controller.setSearchText($scope.model)}),8===e.keyCode&&$scope.$apply(function(){$scope.lookahead=""}),27===e.keyCode}),input.bind("keydown",function(e){(9===e.keyCode||13===e.keyCode||27===e.keyCode)&&e.preventDefault(),38===e.keyCode&&(e.preventDefault(),$scope.$apply(function(){$scope.activated?controller.activatePreviousItem():controller.activateFirstItem()})),40===e.keyCode&&(e.preventDefault(),$scope.$apply(function(){$scope.activated?controller.activateNextItem():controller.activateFirstItem(),controller.activateGeocodingItem()}))}),html.bind("click",function(){$scope.$apply(function(){controller.closeAutofill()})}),initAutofill()},controller:function($scope){$scope.lookahead="",$scope.currentWord="",$scope.completeWord="",this.closeAutofill=function(){return $scope.focused=!1},this.openAutofill=function(){return $scope.focused=!0},this.activate=function(item){return item},this.activateFirstItem=function(){$scope.active=$scope.filtered[0],$scope.currentIndex=$scope.filtered.indexOf($scope.active),$scope.activated=!0},this.activateNextItem=function(){$scope.geocodingactive=!1,$scope.currentIndex<$scope.filtered.length&&$scope.currentIndex>=0?($scope.currentIndex=$scope.filtered.indexOf($scope.active)+1,$scope.active=this.activate($scope.filtered[$scope.currentIndex])):($scope.active=void 0,$scope.currentIndex=-1)},this.activatePreviousItem=function(){$scope.geocodingactive=!1,-1===$scope.currentIndex?($scope.currentIndex=$scope.filtered.length-1,$scope.active=this.activate($scope.filtered[$scope.currentIndex])):$scope.currentIndex<=$scope.filtered.length&&$scope.currentIndex>0&&($scope.currentIndex=$scope.currentIndex-1,$scope.active=this.activate($scope.filtered[$scope.currentIndex]))},this.activateGeocodingItem=function(){!$scope.active&&$scope.activated&&($scope.active=this.activate($scope.model),$scope.geocodingactive=!0)},this.setSearchText=function(){return $scope.completeWord!==$scope.model&&""!==$scope.completeWord&&""!==$scope.model?$scope.model=$scope.completeWord:void 0},this.resetSearchTerms=function(){$scope.lookahead="",$scope.currentWord=""},this.filterStartsWith=function(data,searchTerm){return _.filter(data,function(elem){return elem.name?elem.name.substring(0,searchTerm.length).toLowerCase()===searchTerm.toLowerCase():!1})},this.filterTermWithin=function(data,searchTerm){return _.filter(data,function(elem){return elem.name?elem.name.toLowerCase().indexOf(searchTerm.toLowerCase())>=0:!1})},this.updateSearchText=function(data,searchTerm){return""!==searchTerm&&searchTerm&&data&&searchTerm.length>1?($scope.items=this.filterStartsWith(data,searchTerm),$scope.filtered=this.filterTermWithin(data,searchTerm),$scope.items[0]?($scope.lookahead=$scope.items[0].name.substring(searchTerm.length),$scope.currentWord=searchTerm):this.resetSearchTerms(),$scope.completeWord=$scope.currentWord+$scope.lookahead):void 0}}}}loadingWidget.$inject=["requestNotificationChannel"],librarianchatbutton.$inject=["nyplUtility"],scrolltop.$inject=["$window"],eventRegistration.$inject=["$filter"],nyplSiteAlerts.$inject=["$timeout","nyplLocationsService","nyplUtility"],nyplLibraryAlert.$inject=["nyplUtility"],nyplFundraising.$inject=["$timeout","nyplLocationsService"],nyplAutofill.$inject=["$state","$analytics"],angular.module("nypl_locations").directive("loadingWidget",loadingWidget).directive("nyplTranslate",nyplTranslate).directive("todayshours",todayshours).directive("emailusbutton",emailusbutton).directive("librarianchatbutton",librarianchatbutton).directive("scrolltop",scrolltop).directive("eventRegistration",eventRegistration).directive("nyplSiteAlerts",nyplSiteAlerts).directive("nyplLibraryAlert",nyplLibraryAlert).directive("nyplFundraising",nyplFundraising).directive("nyplSidebar",nyplSidebar).directive("nyplAutofill",nyplAutofill).directive("collapse",collapse),angular.module("nypl_widget").directive("todayshours",todayshours).directive("nyplFundraising",nyplFundraising).directive("librarianchatbutton",librarianchatbutton).directive("emailusbutton",emailusbutton)}(),function(){"use strict";function requestNotificationChannel($rootScope){var _START_REQUEST_="_START_REQUEST_",_END_REQUEST_="_END_REQUEST_",notificationChannel={};return notificationChannel.requestStarted=function(){$rootScope.$broadcast(_START_REQUEST_)},notificationChannel.requestEnded=function(){$rootScope.$broadcast(_END_REQUEST_)},notificationChannel.onRequestStarted=function($scope,handler){$scope.$on(_START_REQUEST_,function(event){handler(event)})},notificationChannel.onRequestEnded=function($scope,handler){$scope.$on(_END_REQUEST_,function(event){handler(event)})},notificationChannel}function nyplUtility($window,$sce,nyplCoordinatesService){var utility={};return utility.hoursToday=function(hours){var hoursToday,date=new Date,today=date.getDay(),tomorrow=today+1;return hours&&(hoursToday={today:{day:hours.regular[today].day,open:hours.regular[today].open,close:hours.regular[today].close},tomorrow:{day:hours.regular[tomorrow%7].day,open:hours.regular[tomorrow%7].open,close:hours.regular[tomorrow%7].close}}),hoursToday},utility.formatDate=function(startDate,endDate){var formattedDate,months=["January","February","March","April","May","June","July","August","September","October","November","December"];if(this.numDaysFromToday=function(date,today){return Math.round((date.valueOf()-today.valueOf())/1e3/86400-.5)},startDate&&endDate){var sDate=new Date(startDate),eDate=new Date(endDate),today=new Date,nDays=this.numDaysFromToday(eDate,today);if(!nDays)return;formattedDate=365>=nDays?sDate.getTime()<=today.getTime()&&eDate.getTime()>=today.getTime()?"Now through "+months[eDate.getUTCMonth()]+" "+eDate.getUTCDate()+", "+eDate.getUTCFullYear():sDate.getTime()>today.getTime()&&eDate.getTime()>=today.getTime()?"Opening "+months[sDate.getUTCMonth()]+" "+sDate.getUTCDate()+", "+sDate.getUTCFullYear():months[sDate.getUTCMonth()]+" "+sDate.getUTCDate()+", "+sDate.getUTCFullYear()+" through "+months[eDate.getUTCMonth()]+" "+eDate.getUTCDate()+", "+eDate.getUTCFullYear():"Ongoing"}return formattedDate},utility.branchException=function(hours){var exception={};if(hours){if(!hours.exceptions)return null;if(""!==hours.exceptions.description.trim())return exception.desc=hours.exceptions.description,hours.exceptions.start&&(exception.start=hours.exceptions.start),hours.exceptions.end&&(exception.end=hours.exceptions.end),exception}return null},utility.getAddressString=function(location,nicePrint){if(!location)return"";var addressBreak=" ",linkedName=location.name;return nicePrint&&(addressBreak="<br />",linkedName="<a href='/#/"+location.slug+"'>"+location.name+"</a>"),linkedName+addressBreak+location.street_address+addressBreak+location.locality+", "+location.region+", "+location.postal_code},utility.socialMediaColor=function(social_media){return _.each(social_media,function(sc){switch(sc.classes="icon-",sc.site){case"facebook":sc.classes+=sc.site+" blueDarkerText";break;case"foursquare":sc.classes+=sc.site+" blueText";break;case"instagram":sc.classes+=sc.site+" blackText";break;case"twitter":sc.classes+=sc.site+"2 blueText";break;case"tumblr":sc.classes+=sc.site+"2 indigoText";break;case"youtube":case"pinterest":sc.classes+=sc.site+" redText";break;default:sc.classes+=sc.site}}),social_media},utility.alerts=function(alerts){var alert_start,alert_end,today=new Date,todaysAlert="";return alerts&&Array.isArray(alerts)&&(_.each(alerts,function(alert){alert_start=new Date(alert.start),alert_end=new Date(alert.end),today>=alert_start&&alert_end>=today&&(todaysAlert+=alert.body+"\n")}),!angular.isUndefined(todaysAlert))?todaysAlert:null},utility.popupWindow=function(link,title,width,height){var w,h,popUp,popUp_h,popUp_w;link&&(w=void 0===width?"300":"string"==typeof width||width instanceof String?width:width.toString(),h=void 0===height?"500":"string"==typeof width||width instanceof String?height:height.toString(),link&&title?popUp=$window.open(link,title,"menubar=1,resizable=1,width="+w+",height="+h):link&&(popUp=$window.open(link,"","menubar=1,resizable=1,width="+w+",height="+h)),popUp&&(popUp_w=parseInt(w,10),popUp_h=parseInt(h,10),popUp.moveTo(screen.width/2-popUp_w/2,screen.height/2-popUp_h/2)))},utility.calendarLink=function(type,event,location){if(!type||!event||!location)return"";var title=event.title,start_date=event.start.replace(/[\-:]/g,""),end_date=event.end.replace(/[\-:]/g,""),body=event.body,url=event._links.self.href,address=location.name+" - "+location.street_address+" "+location.locality+", "+location.region+" "+location.postal_code,calendar_link="";switch(type){case"google":calendar_link="https://www.google.com/calendar/render?action=template&text="+title+"&dates="+start_date+"/"+end_date+"&details="+body+"&location="+address+"&pli=1&uid=&sf=true&output=xml";break;case"yahoo":calendar_link="https://calendar.yahoo.com/?v=60&TITLE="+title+"&ST="+start_date+"&in_loc="+address+"&in_st="+address+"&DESC="+body+"&URL="+url}return calendar_link},utility.icalLink=function(event,address){if(!event||!address)return"";var currentTime=(new Date).toJSON().toString().replace(/[\-.:]/g,""),url="http://nypl.org/"+event._links.self.href,icsMSG="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NYPL//NONSGML v1.0//EN\nMETHOD:PUBLISH\nBEGIN:VEVENT\nUID:"+(new Date).getTime()+"\nDTSTAMP:"+currentTime+"\nATTENDEE;CN=My Self ;\nORGANIZER;CN=NYPL:\nDTSTART:"+event.start.replace(/[\-:]/g,"")+"\nDTEND:"+event.end.replace(/[\-:]/g,"")+"\nLOCATION:"+address+"\nDESCRIPTION:"+event.body+"\nURL;VALUE=URI:"+url+"\nSUMMARY:"+event.title+"\nEND:VEVENT\nEND:VCALENDAR",icalLink="data:text/calendar;chartset=utf-8,"+encodeURI(icsMSG);return $window.open(icalLink),icalLink},utility.calcDistance=function(locations,coords){if(!locations)return[];var searchCoordinates={latitude:coords.latitude||coords.lat,longitude:coords.longitude||coords.long};return _.each(locations,function(location){var locationLat,locationLong,locCoords=[];location.geolocation&&location.geolocation.coordinates&&(locCoords=location.geolocation.coordinates),locationLat=location.lat||locCoords[1],locationLong=location.long||locCoords[0],location.distance=nyplCoordinatesService.getDistance(searchCoordinates.latitude,searchCoordinates.longitude,locationLat,locationLong)}),locations},utility.checkDistance=function(locations){var distanceArray=_.pluck(locations,"distance");return _.min(distanceArray)>25?!0:!1},utility.returnHTML=function(html){return $sce.trustAsHtml(html)},utility.divisionHasAppointment=function(divisionsWithApts,id){return _.contains(divisionsWithApts,id)},utility.researchLibraryOrder=function(research_order,id){return _.indexOf(research_order,id)},utility}requestNotificationChannel.$inject=["$rootScope"],nyplUtility.$inject=["$window","$sce","nyplCoordinatesService"],angular.module("nypl_locations").factory("nyplUtility",nyplUtility).factory("requestNotificationChannel",requestNotificationChannel),angular.module("nypl_widget").factory("nyplUtility",nyplUtility).factory("requestNotificationChannel",requestNotificationChannel)}();